<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linkgoâ­</title>
    <link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Linkgo">
<link rel="apple-touch-icon" href="https://i.postimg.cc/cHNb4gXc/IMG-2047.jpg">
    
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(function(OneSignal) {
    OneSignal.init({
      appId: "377df80f-5fd9-4c68-8b0d-9fae568761b8",
      serviceWorkerPath: "OneSignalSDKWorker.js", // ç¡®è®¤æ–‡ä»¶å°±åœ¨æ ¹ç›®å½• 
      serviceWorkerParam: { scope: "/" }, // æ”¹ä¸ºæ ¹è·¯å¾„å°è¯• 
      allowLocalhostAsSecureOrigin: true 
    });
});

// é€‚é… v16 SDK çš„æ­£ç¡®æ£€æµ‹é€»è¾‘
async function checkAndReactivateSubscription() {
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
        console.log("ã€OneSignalã€‘æ­£åœ¨æ£€æŸ¥è®¢é˜…çŠ¶æ€ (v16)...");

        try {
            // 1. æ£€æŸ¥é€šçŸ¥æƒé™ï¼ˆv16 ä½¿ç”¨ .permission å±æ€§ï¼‰
            const permission = OneSignal.Notifications.permission;
            console.log("ã€OneSignalã€‘å½“å‰æƒé™çŠ¶æ€:", permission);

            // 2. æ£€æŸ¥è®¢é˜…çŠ¶æ€ï¼ˆv16 è·¯å¾„å·²å˜æ›´ï¼‰
            const isSubscribed = OneSignal.User.PushSubscription.optedIn;
            const pushToken = OneSignal.User.PushSubscription.id;

            if (isSubscribed && pushToken) {
                console.log("âœ… ã€OneSignalã€‘è®¢é˜…å¤„äºæ´»è·ƒçŠ¶æ€ã€‚ID:", pushToken);
            } else {
                console.warn("âŒ ã€OneSignalã€‘æœªè®¢é˜…æˆ–å·²å¤±æ•ˆï¼Œå°è¯•è¯·æ±‚æƒé™...");
                // å¦‚æœæ˜¯é»˜è®¤çŠ¶æ€ï¼Œåˆ™è¯·æ±‚æƒé™
                if (permission === "default") {
                    await OneSignal.Notifications.request();
                    console.log("ğŸš€ ã€OneSignalã€‘å·²å¼¹å‡ºè®¢é˜…è¯·æ±‚çª—å£");
                } else if (permission === "denied") {
                    console.error("ã€OneSignalã€‘é€šçŸ¥æƒé™å·²è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯ã€‚");
                }
            }
        } catch (err) {
            console.error("ã€OneSignalã€‘æ£€æµ‹é€»è¾‘æ‰§è¡Œå‡ºé”™:", err);
        }
    });
}

</script>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ----------------------- å…¨å±€ä¸ä¸»é¢˜æ ·å¼ ----------------------- */
        :root {
            /* ä¸»é¢˜å˜é‡ */
            --bg-color-primary: #f0f0f5; 
            --bg-color-secondary: #ffffff; 
            --text-color-primary: #1c1c1e; 
            --text-color-secondary: #8e8e93; 
            --accent-color: #7B9E6D; 
            --danger-color: #E8AF98;
            --warning-color: #A89F4D;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.3);
            --input-bg: #f7f7f7;
            --input-border: #e0e0e0; 
            --radius-default: 16px; 
            --bubble-radius: 6px; /* éœ€æ±‚4: æ°”æ³¡åœ†è§’ä¸è¦é‚£ä¹ˆåœ† */

            --phone-width: 100%;
            --phone-height: 100vh;
        }

        .dark-mode {
            --bg-color-primary: #121212;
            --bg-color-secondary: #1e1e1e;
            --text-color-primary: #e0e0e0; /* ç»Ÿä¸€ç™½è‰²æ–‡å­— */
            --text-color-secondary: #aaa; /* æé«˜å¯¹æ¯”åº¦ */
            --accent-color: #8AAE7F;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.5);
            --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.8);
            --input-bg: #2b2b2b;
            --input-border: #444;
            --danger-color: #D17A6B;
        }
        

        /* åŸºç¡€æ ·å¼å’ŒåŠ¨æ•ˆ */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-color-primary);
            font-family: -apple-system, BlinkMacSystemFont, 
                 'SF Pro Text', 'Helvetica Neue', 
                 'PingFang SC', 'Hiragino Sans GB',
                 sans-serif;
    -webkit-font-smoothing: antialiased;  /* å­—ä½“æŠ—é”¯é½¿ */
    -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s;
            color: var(--text-color-primary); /* ç¡®ä¿æ‰€æœ‰æ–‡å­—é¢œè‰²ç»Ÿä¸€ */
        }
        
        .clickable:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        .phone-frame {
            width: var(--phone-width);
            height: var(--phone-height);
            background: linear-gradient(145deg, var(--bg-color-primary), var(--bg-color-primary));
            border-radius: 0;
            box-shadow: var(--shadow-dark);
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color-secondary);
            border-radius: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .status-bar {
            width: 100%;
            height: 0px; /* éœ€æ±‚4: åªä¿ç•™æœ€å°é«˜åº¦ */
            background-color: var(--bg-color-secondary);
            box-sizing: border-box;
        }

        /* ----------------------- APP å›¾æ ‡å’Œä¸»ç•Œé¢ ----------------------- */
        /* æ·»åŠ è¿™è¡Œï¼Œè®©å›¾æ ‡é¢œè‰²ç»§æ‰¿çˆ¶å…ƒç´ é¢œè‰² */
        .fas, .fab {
             color: inherit;
        }

        .app-container {
            flex-grow: 1;
            width: 100%;
            padding: 40px 20px;
            display: flex;
            justify-content: center; 
            align-items: flex-start;
            gap: 40px; 
        }

        .app-icon {
            text-align: center;
            cursor: pointer;
            width: 65px; 
        }
        
        .app-icon .app-icon-image {
             transition: transform 0.1s ease;
        }
        .app-icon:active .app-icon-image {
             transform: scale(0.95);
        }

        .app-icon-image {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(8px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: var(--radius-default); 
            margin: 0 auto 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: #ffffff; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* ----------------------- é¡µé¢åˆ‡æ¢ç»“æ„ ----------------------- */
        .page {
            position: absolute;
            inset: 0;
            top: 0px; /* è°ƒæ•´çŠ¶æ€æ é«˜åº¦ */
            background: var(--bg-color-secondary);
            display: none; 
            flex-direction: column;
            color: var(--text-color-primary);
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px; 
            /* ä¿®æ”¹ç‚¹ï¼šèƒŒæ™¯æ”¹ä¸ºé€æ˜(é€å‡ºæ‰‹æœºåº•è‰²) æˆ– ç›´æ¥å†™ black */
            background-color: var(--bg-color-primary); 
            /* ä¿®æ”¹ç‚¹ï¼šå»æ‰åº•éƒ¨è¾¹æ¡†ï¼Œè®©å®ƒçœ‹èµ·æ¥å’ŒèƒŒæ™¯ä¸€ä½“ */
            border-bottom: none; 
            position: sticky;
            top: 0px;
            z-index: 2;
            height: 50px;
            box-sizing: border-box;
        }
        
        /* è®¾ç½®é¡µé¢è°ƒæ•´ */
        .page-header h3 {
            flex-grow: 1;
            text-align: center; 
            margin: 0;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            /* ä¿®æ”¹ç‚¹ï¼šå­—å·16pxï¼Œä¸åŠ ç²— */
            font-size: 16px; 
            font-weight: normal; 
        }

        /* éœ€æ±‚3: èŠå¤©å®¤é¡µé¢ */
        .page-header h3.small-title {
            font-size: 16px;
        }

        .back-button, .action-button, .manage-button {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--text-color-primary);
            padding: 5px;
            font-size: 16px;
            z-index: 3;
            transition: transform 0.1s ease;
        }
        .back-button:active, .action-button:active, .manage-button:active {
            transform: scale(0.94);
        }
        
        .back-button { margin-right: auto; }
        
        /* éœ€æ±‚2: ç®¡ç†æŒ‰é’® */
        .manage-button {
            margin-left: auto;
            margin-right: 15px;
            font-size: 16px;
        }

        /* éœ€æ±‚2: åŠ å·æ”¾å¤§ */
        .action-button.plus-btn {
            font-size: 16px; 
            font-weight: 300;
            line-height: 1;
        }
        /* ä»…é’ˆå¯¹èŠå¤©çª—å£çš„ä¸‰ä¸ªç‚¹ */
#chat-window .action-button {
    font-size: 24px;
    font-weight: 700;
}
        .back-icon { margin-right: 5px; }

        /* ----------------------- è®¾ç½® & é€‰é¡¹é¡µé¢æ ·å¼ ----------------------- */
        #settings-page .content, #options-page .content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-group {
            margin-bottom: 30px; 
            padding: 15px;
            background-color: var(--input-bg);
            border-radius: var(--radius-default); 
            box-shadow: var(--shadow-light);
            border: 1px solid var(--input-border);
        }

        .settings-group h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-color-primary);
        }

        .settings-group label {
            display: block;
            margin: 15px 0 8px; 
            font-weight: bold;
            font-size: 14px;
            color: var(--text-color-primary);
        }

        .settings-group input:not([type="checkbox"]), 
.theme-switch-group button,
.options-save-btn,
.file-upload-btn,
.modal-content input {
    width: 100%;
    padding: 12px; 
    margin-bottom: 10px;
    border: 1px solid var(--input-border);
    border-radius: var(--radius-default); 
    background-color: var(--bg-color-secondary);
    color: var(--text-color-primary);
    box-sizing: border-box;
    transition: background-color 0.3s, border-color 0.3s;
}

/* ä¿®å¤è®¾ç½®é¡µé¢è¾“å…¥æ¡†é¢œè‰²é—®é¢˜ */
#settings-page input[type="text"],
#settings-page input[type="password"],
#settings-page input[type="number"] {
    background-color: var(--input-bg) !important;
    border: 1px solid var(--input-border);
    border-radius: var(--radius-default);
    padding: 12px;
    width: 100%;
    color: var(--text-color-primary);
    box-sizing: border-box;
    transition: background-color 0.3s, border-color 0.3s;
}

#settings-page input[type="text"]:focus,
#settings-page input[type="password"]:focus,
#settings-page input[type="number"]:focus {
    outline: none;
    border-color: var(--accent-color);
    background-color: var(--input-bg) !important;
}

/* ä¸“é—¨ä¸ºtextareaæ·»åŠ æ ·å¼ï¼Œå…è®¸æ»šåŠ¨ */
.settings-group textarea,
.modal-content textarea {
    width: 100%;
    padding: 12px; 
    margin-bottom: 10px;
    border: 1px solid var(--input-border);
    border-radius: var(--radius-default); 
    background-color: var(--bg-color-secondary);
    color: var(--text-color-primary);
    box-sizing: border-box;
    transition: background-color 0.3s, border-color 0.3s;
    resize: vertical !important;
    min-height: 80px;
    max-height: 300px;
    overflow-y: auto !important;
    scrollbar-width: thin;
}

/* ç¡®ä¿æ»šåŠ¨æ¡å¯è§ */
.settings-group textarea::-webkit-scrollbar,
.modal-content textarea::-webkit-scrollbar {
    display: block;
    width: 6px;
}

.settings-group textarea::-webkit-scrollbar-thumb,
.modal-content textarea::-webkit-scrollbar-thumb {
    background-color: var(--input-border);
    border-radius: 3px;
}


        .options-save-btn, .theme-switch-group button {
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.1s ease;
        }

        .options-save-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px;
        }
        .options-save-btn:active {
            background-color: #0056b3;
            transform: scale(0.98);
        }

        /* ----------------------- èŠå¤©å®¤ (è”ç³»äºº) é¡µé¢æ ·å¼ ----------------------- */
        #contacts-page .contacts-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 15px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px 0; 
            border-bottom: 1px solid var(--input-border);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        
        .contact-item:active { background-color: rgba(0, 0, 0, 0.05); } 
        
        /* éœ€æ±‚2: åˆ é™¤æŒ‰é’® */
        .delete-btn-wrapper {
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease, margin-right 0.3s ease;
            margin-right: 0;
            display: flex;
            align-items: center;
        }
        .delete-btn-wrapper.show {
            width: 30px;
            margin-right: 10px;
        }
        .delete-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: var(--danger-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            line-height: 1;
            font-weight: bold;
        }

        /* æ–°å¢ï¼šæ‰¹é‡åˆ é™¤é€‰æ‹©æ¡† */
        .contact-checkbox {
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease, margin-right 0.3s ease;
            margin-right: 0;
            display: flex;
            align-items: center;
        }
        .contact-checkbox.show {
            width: 30px;
            margin-right: 10px;
        }
        
        .contact-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 10px; /* å¤´åƒå¾®åœ†è§’ */
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            margin-right: 15px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }


        /* ----------------------- èŠå¤©çª—å£æ ·å¼ ----------------------- */
        #chat-window { background-color: var(--bg-color-primary); }

        .chat-message { margin-bottom: 15px; display: flex; align-items: flex-start; width: 100%;}
        
        /* éœ€æ±‚4: AIåœ¨å·¦è¾¹æœ‰å¤´åƒï¼Œæˆ‘åœ¨å³è¾¹æ²¡å¤´åƒ */
        .chat-message.ai { justify-content: flex-start; }
        .chat-message.user { justify-content: flex-end; }
        
        /* ç¡®ä¿AIçš„å¤šä¸ªæ°”æ³¡ä¹‹é—´æœ‰åˆé€‚çš„é—´è· */
        .chat-message.ai {
            display: flex;
            /* ä¿®æ”¹ç‚¹ï¼šæ”¹ä¸º flex-start è®©å¤´åƒå’Œæ°”æ³¡é¡¶éƒ¨å¯¹é½ */
            align-items: flex-start; 
            margin-bottom: 15px;
        }

        .chat-message.ai .avatar {  
    width: 36px; 
    height: 36px; 
    margin-right: 8px; 
    flex-shrink: 0;
    border-radius: 8px; 
    /* ä¿®æ”¹ç‚¹ï¼šç§»é™¤æˆ–è°ƒæ•´é¡¶éƒ¨è¾¹è· */
    margin-top: 0; /* å°† 4px æ”¹ä¸º 0 */
}

.chat-message.ai:last-child {
    margin-bottom: 15px; /* æœ€åä¸€ä¸ªAIæ¶ˆæ¯ä¿æŒåŸæ¥çš„é—´è· */
}

/* ç¡®ä¿ç”¨æˆ·æ¶ˆæ¯å’ŒAIæ¶ˆæ¯ä¹‹é—´æœ‰æ­£å¸¸é—´è· */
.chat-message.user {
    margin-bottom: 15px;
}

        .chat-message.user .avatar { display: none; } /* ç”¨æˆ·æ— å¤´åƒ */

        /* éœ€æ±‚4: æ°”æ³¡åœ†è§’ä¸è¦é‚£ä¹ˆåœ† (6px) */
        .chat-message .bubble {
            max-width: 70%;
            padding: 10px 12px;
            border-radius: var(--bubble-radius); 
            line-height: 1.4;
            font-size: 17px;
            font-family: "PingFang SC", -apple-system, sans-serif;
            word-wrap: break-word; 
            position: relative;
        }

       .chat-message.ai .bubble {
    background-color: var(--bg-color-secondary);
    color: var(--text-color-primary);
    padding: 10px 12px;
    border-radius: 6px;
    max-width: 70%;
    line-height: 1.4;
    cursor: pointer; /* æ–°å¢ï¼šæ˜¾ç¤ºä¸ºå¯ç‚¹å‡» */
    transition: background-color 0.1s, transform 0.1s; /* æ–°å¢ï¼šè¿‡æ¸¡æ•ˆæœ */
}

/* æ–°å¢ï¼šç‚¹å‡»æ—¶çš„åé¦ˆæ•ˆæœ */
.chat-message.ai .bubble:active {
    background-color: rgba(0, 0, 0, 0.05);
    transform: scale(0.99);
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
.dark-mode .chat-message.ai .bubble:active {
    background-color: rgba(255, 255, 255, 0.05);
}

        .chat-message.user .bubble {
    background-color: #95ec69;  /* å¾®ä¿¡æµ…ç»¿è‰² */
    color: black;              
    margin-right: 10px;
}

/* ç™½å¤©æ¨¡å¼ä¿æŒä¸å˜ï¼Œæ·±è‰²æ¨¡å¼å¯ä»¥è°ƒæ•´ */
.dark-mode .chat-message.user .bubble {
    background-color: #07C160;  /* æ·±è‰²æ¨¡å¼ç”¨å¾®ä¿¡ç»¿ */
    color: black;
}
        
        /* æ¶ˆæ¯åŒ…è£…å™¨ */
.messages-wrapper {
    flex: 1;
    position: relative;
    overflow: hidden;
}

/* æ¶ˆæ¯å®¹å™¨ */
.messages-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    padding: 15px 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

/* ç¡®ä¿æœ€åä¸€æ¡æ¶ˆæ¯ä¸è¢«é®æŒ¡ */
.messages-container::after {
    content: '';
    display: block;
    height: 0px; /* è¾“å…¥æ¡†é«˜åº¦ + å®‰å…¨è·ç¦» */
}

/* ----------------------- è¾“å…¥æ¡†åŒºåŸŸ - iOSé£æ ¼ ----------------------- */
.chat-input-area {
    flex-shrink: 0;
    padding: 12px 16px 16px 16px; /* å¢åŠ å†…è¾¹è·ï¼Œè®©è¾“å…¥æ¡†æŠ¬é«˜ */
    display: flex;
    align-items: flex-end;
    background-color: var(--bg-color-secondary);
    border-top: 1px solid var(--input-border);
    box-sizing: border-box;
    /* ç§»é™¤min-heightï¼Œè®©é«˜åº¦è‡ªé€‚åº” */
}

/* ----------------------- æ— è¾¹æ¡†iOSé£æ ¼è¾“å…¥æ¡† ----------------------- */
.chat-input-area {
    flex-shrink: 0;
    padding: 16px 16px 20px 16px; /* ä¿æŒæŠ¬é«˜æ•ˆæœ */
    display: flex;
    align-items: center;
    background-color: var(--bg-color-secondary);
    /* å®Œå…¨ç§»é™¤è¾¹æ¡† */
    border-top: none;
    box-sizing: border-box;
    /* è½»å¾®é˜´å½±ä¿æŒæ‚¬æµ®æ„Ÿï¼Œä½†æ›´æŸ”å’Œ */
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.04);
    z-index: 10;
}

.dark-mode .chat-input-area {
    box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.15);
    background-color: var(--bg-color-secondary);
}

/* è¾“å…¥æ¡†æœ¬èº« - æ— è¾¹æ¡†ç‰ˆæœ¬ */
.chat-input-area textarea {
    flex-grow: 1;
    resize: none;
    min-height: 36px;
    max-height: 100px;
    padding: 9px 16px;
    /* ç§»é™¤è¾¹æ¡† */
    border: none;
    /* ä¿æŒåœ†è§’ */
    border-radius: 19px;
    margin: 0;
     font-size: 17px;
    font-family: "PingFang SC", -apple-system, sans-serif !important;
    -webkit-font-smoothing: antialiased;
    font-synthesis: style weight;
    box-sizing: border-box;
    background-color: var(--input-bg);
    color: var(--text-color-primary);
    transition: all 0.2s ease;
    line-height: 1.4;
    
    /* åªç”¨å†…éƒ¨é˜´å½±ï¼Œä¸è¦å¤–éƒ¨è¾¹æ¡† */
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08);
    
    /* éšè—æ»šåŠ¨æ¡ */
    overflow: hidden;
    -webkit-overflow-scrolling: touch;
}

.dark-mode .chat-input-area textarea {
    background-color: rgba(118, 118, 128, 0.24);
    color: var(--text-color-primary);
    box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.2);
}

/* èšç„¦çŠ¶æ€ - åªç”¨é˜´å½±è¡¨ç¤º */
.chat-input-area textarea:focus {
    outline: none;
    background-color: var(--input-bg);
    /* èšç„¦æ—¶å†…éƒ¨é˜´å½±åŠ æ·± */
    box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.12),
                0 0 0 1px rgba(0, 122, 255, 0.2); /* éå¸¸ç»†çš„èšç„¦æŒ‡ç¤º */
}

.dark-mode .chat-input-area textarea:focus {
    box-shadow: inset 0 0.1px 1px rgba(255, 255, 255, 0.3),
                0 0 0 0.1px rgba(255, 255, 255, 0.3);
}

/* ç¡®ä¿æ‰€æœ‰textareaéƒ½æœ‰ç›¸åŒæ ·å¼ */
textarea {
    resize: none !important;
    font-family: inherit; /* ç»§æ‰¿å­—ä½“ */
}

/* éšè—textareaçš„ä¸‰è§’æ ‡ï¼ˆå„ä¸ªæµè§ˆå™¨ï¼‰ */
textarea::-webkit-resizer {
    display: none !important;
}
textarea::-moz-resize {
    display: none !important;
}
textarea::-ms-resize {
    display: none !important;
}

/* ä¿®æ”¹æ‰€æœ‰è¾“å…¥æ¡†çš„å…‰æ ‡é¢œè‰² */
input, textarea {
    caret-color: #07C160; 
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„å…‰æ ‡é¢œè‰² */
.dark-mode input,
.dark-mode textarea {
    caret-color: #07C160; 
}

        /* ----------------------- æ¨¡æ€æ¡†/å¼¹çª—æ ·å¼ ----------------------- */
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 40;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--bg-color-secondary);
            border-radius: var(--radius-default);
            width: 80%; 
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

/* æ–°å»ºè§’è‰²å¼¹çª—ä¼˜åŒ–æ ·å¼ */
#new-contact-modal .modal-content {
    width: 85%;
    max-width: 400px;
    max-height: 85vh;
    padding: 24px;
    display: flex;
    flex-direction: column;
}

#new-contact-modal .modal-content h4 {
    margin-bottom: 24px;
    font-size: 20px;
    text-align: center;
    color: var(--text-color-primary);
}

#new-contact-modal .modal-scroll-area {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    margin-bottom: 16px;
}

#new-contact-modal .modal-scroll-area::-webkit-scrollbar {
    display: none;
}

#new-contact-modal .modal-content label {
    display: block;
    margin: 18px 0 8px 0;
    font-weight: 600;
    font-size: 15px;
    color: var(--text-color-primary);
}

#new-contact-modal .modal-content input,
#new-contact-modal .modal-content textarea {
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 8px;
    border: 1px solid var(--input-border);
    border-radius: 12px;
    background-color: var(--bg-color-secondary);
    color: var(--text-color-primary);
    box-sizing: border-box;
    font-size: 16px;
}

#new-contact-modal .modal-content input:focus,
#new-contact-modal .modal-content textarea:focus {
    outline: none;
    /* ç§»é™¤è¾¹æ¡†é¢œè‰²å˜åŒ–å’Œé˜´å½± */
    border-color: var(--input-border);
}

#new-contact-modal .modal-content textarea:focus {
    min-height: 120px;
    line-height: 1.5;
}

#new-contact-modal .modal-footer {
    margin-top: 8px;
    padding-top: 20px;
    border-top: 1px solid var(--input-border);
}

#new-contact-modal .modal-footer button {
    padding: 14px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 12px;
}

/* ç§»é™¤æ•°å­—è¾“å…¥æ¡†ç®­å¤´ */
input[type="number"] {
    -moz-appearance: textfield;
    appearance: textfield;
}

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

#memory-content-container textarea {
    scrollbar-width: none;
    -ms-overflow-style: none;
    overflow-y: hidden; /* å¼ºåˆ¶éšè—å‚ç›´æ»šåŠ¨æ¡ */
}

#memory-content-container textarea::-webkit-scrollbar {
    display: none;
}

        .overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-content h4 { 
            margin-bottom: 20px; 
            color: var(--text-color-primary);
        }
        
        .modal-content label { 
            margin-top: 15px; 
            color: var(--text-color-primary);
        }

        .modal-footer {
            display: flex;
            justify-content: space-around;
            padding-top: 20px; 
            gap: 10px;
        }

        .modal-footer button {
            flex: 1;
            padding: 12px 10px;
            border-radius: var(--radius-default); 
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.1s ease;
        }
        
        .modal-footer button:active { transform: scale(0.96); }

        .modal-footer .save-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
        }

        .modal-footer .cancel-btn {
            background-color: var(--input-bg);
            color: var(--text-color-primary);
            border: 1px solid var(--input-border);
        }
        
        /* ----------------------- é€‰é¡¹é¡µé¢ (Prompt/è®°å¿†/å¤´åƒ) ----------------------- */
        .options-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0; 
            border-bottom: 1px solid var(--input-border);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .options-item:active { background-color: rgba(0, 0, 0, 0.05); }

        .options-item:last-child { border-bottom: none; }

        .options-item span { 
            font-weight: bold; 
            color: var(--text-color-primary);
        }
        
        .options-item .indicator {
            color: var(--text-color-secondary);
            font-weight: normal;
        }
        
        #memory-modal-title { 
            margin-bottom: 20px; 
            color: var(--text-color-primary);
        }

        /* æ–°å¢ï¼šæ‰¹é‡åˆ é™¤å·¥å…·æ  */
        .batch-toolbar {
            display: none;
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color-secondary);
            border-top: 1px solid var(--input-border);
            padding: 12px 15px;
            z-index: 5;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .batch-toolbar.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .batch-info {
            color: var(--text-color-primary);
            font-size: 14px;
        }
        
        .batch-delete-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-default);
            cursor: pointer;
            font-weight: bold;
        }
        
        .batch-cancel-btn {
            background-color: var(--input-bg);
            color: var(--text-color-primary);
            border: 1px solid var(--input-border);
            padding: 8px 16px;
            border-radius: var(--radius-default);
            cursor: pointer;
            margin-right: 10px;
        }
        
        /* æ–°å¢ï¼šä¸´æ—¶è®°å¿†å¯¹è¯æ¡†æ ·å¼ */
        .round-container {
            margin-bottom: 20px;
            border: 1px solid var(--input-border);
            border-radius: var(--radius-default);
            padding: 15px;
            background-color: var(--input-bg);
        }
        
        /* ç¡®ä¿ä¸´æ—¶è®°å¿†å¯¹è¯æ¡†ä¸­çš„æ–‡æœ¬å¯æ»šåŠ¨ */
.round-message {
    padding: 8px 12px;
    border-radius: 8px;
    background-color: var(--bg-color-secondary);
    border: 1px solid var(--input-border);
    color: var(--text-color-primary);
    max-height: 150px;
    overflow-y: auto !important;
    white-space: pre-wrap;
    word-break: break-word;
}

        /* æ·»åŠ åˆ é™¤æŒ‰é’®æ ·å¼ */
.round-header {
    font-weight: bold;
    margin-bottom: 10px;
    color: var(--text-color-primary);
    font-size: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.round-delete-btn {
    background-color: var(--danger-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
    transition: transform 0.1s ease;
}

.round-delete-btn:hover {
    transform: scale(1.1);
}
        
        .round-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .round-message {
            padding: 8px 12px;
            border-radius: 8px;
            background-color: var(--bg-color-secondary);
            border: 1px solid var(--input-border);
            color: var(--text-color-primary);
        }
        
        .round-message.user {
            align-self: flex-end;
            background-color: #95ec69;
            color: #1c1c1e;
            max-width: 80%;
        }
        
        .round-message.ai {
            align-self: flex-start;
            background-color: var(--bg-color-secondary);
            max-width: 80%;
        }

        /* æ–°å¢ï¼šè®¾ç½®é¡µå¤´åƒè®¾ç½®åŒºåŸŸ */
        .avatar-settings {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--input-border);
        }
        
        .avatar-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .avatar-preview-label {
            margin-bottom: 10px;
            color: var(--text-color-primary);
            font-weight: bold;
        }
        
        .avatar-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* æ–°å¢ï¼šAIæ¶ˆæ¯é€å¥æ˜¾ç¤ºæ•ˆæœ */
        .typing-indicator {
            display: flex;
            padding: 10px 14px;
            border-radius: var(--bubble-radius);
            background-color: var(--bg-color-secondary);
            margin-bottom: 5px;
        }
        
        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--text-color-secondary);
            margin: 0 1px;
            animation: typing 1.5s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.3s; }
        .typing-dot:nth-child(2) { animation-delay: -0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-3px); }
        }

        /* æ–°å¢ï¼šé€‰æ‹©/å–æ¶ˆå…¨é€‰æŒ‰é’® */
        .select-all-btn {
            background-color: var(--warning-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
                  
        /* æ¸…ç†æŒ‰é’® - ç®€æ´insé£ */
.clear-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 15px;
}

.clear-btn {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    border-radius: 10px;
    border: 1px solid var(--input-border);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-color-secondary);
    color: var(--text-color-primary);
}

.clear-btn:active {
    transform: scale(0.98);
}

.clear-short-btn {
    border-left: 4px solid #D39C70; 
}

.clear-long-btn {
    border-left: 4px solid #8A7FAC; 
}

.clear-icon {
    font-size: 18px;
    margin-right: 12px;
} 

.clear-short-btn .clear-icon {
    color: #D39C70; /* å›¾æ ‡ä¹Ÿç”¨é™¶åœŸæ©™ */
}

.clear-long-btn .clear-icon {
    color: #8A7FAC; /* å›¾æ ‡ä¹Ÿç”¨ç°ç´«è‰² */
}

/* ä¸»é¢˜åˆ‡æ¢å¼€å…³ - å®¹å™¨ */
.theme-switch-container {
    display: flex;
    justify-content: center;
    margin: 15px 0;
}

/* è½¨é“ï¼ˆèƒŒæ™¯æ¡ï¼‰ */
.theme-switch-track {
    position: relative;
    width: 68px;
    height: 34px;
    background: linear-gradient(90deg, #ffd700 0%, #007aff 100%);
    border-radius: 34px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„è½¨é“ */
.dark-mode .theme-switch-track {
    background: #4a4a4a;
}

/* åœ†å½¢æ»‘å— */
.theme-switch-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 30px;
    height: 30px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    z-index: 2;
}

/* æ·±è‰²æ¨¡å¼ä¸‹æ»‘å—ä½ç½®ï¼ˆæ»‘åŠ¨åˆ°å³ä¾§ï¼‰ */
.dark-mode .theme-switch-thumb {
    left: calc(100% - 32px);
    background: #f5f5f7;
}

/* ä¸¤ä¾§å›¾æ ‡ */
.theme-icon-left,
.theme-icon-right {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    color: white;
    z-index: 1;
    transition: all 0.3s ease;
}

.theme-icon-left {
    left: 9px;
}

.theme-icon-right {
    right: 9px;
}

/* æ·±è‰²æ¨¡å¼ä¸‹å›¾æ ‡é¢œè‰² */
.dark-mode .theme-icon-left {
    color: #888;
}

.dark-mode .theme-icon-right {
    color: #ffd700;
}
/* ä¸ºä¸»é¢˜æ¨¡å¼æ ‡é¢˜æ·»åŠ æ ·å¼ */
#settings-page .content > div:has(h4:contains("ä¸»é¢˜æ¨¡å¼")) h4 {
    margin: 0 0 15px 0;
    text-align: center;
    color: var(--text-color-primary);
}

/* ----------------------- ä¿®å¤è®°å¿†å¼¹çª—å¤´éƒ¨å›ºå®š ----------------------- */
        
        /* 1. é’ˆå¯¹è®°å¿†å¼¹çª—ï¼šç¦æ­¢æ•´ä¸ªå¡ç‰‡æ»šåŠ¨ï¼Œè¿™æ ·æ ‡é¢˜å’Œåº•éƒ¨æŒ‰é’®å°±ä¼šå›ºå®šä½ */
        #memory-modal .modal-content {
            overflow: hidden !important; 
        }

        /* 2. è®©ä¸­é—´çš„å†…å®¹å®¹å™¨å¡«æ»¡å‰©ä½™ç©ºé—´ï¼Œå¹¶å¼€å¯ç‹¬ç«‹æ»šåŠ¨ */
        #memory-content-container {
            flex-grow: 1;           /* è‡ªåŠ¨å æ®å‰©ä½™é«˜åº¦ */
            overflow-y: auto;       /* å†…å®¹å¤šäº†åªåœ¨è¿™é‡Œå‡ºç°æ»šåŠ¨æ¡ */
            margin-bottom: 10px;    /* å’Œåº•éƒ¨æŒ‰é’®ä¿æŒè·ç¦» */
            padding-right: 5px;     /* é˜²æ­¢æ»šåŠ¨æ¡ç´§è´´æ–‡å­— */
            
            /* é’ˆå¯¹ä¸åŒæµè§ˆå™¨çš„æ»šåŠ¨æ¡ç¾åŒ–ï¼ˆå¯é€‰ï¼‰ */
            scrollbar-width: thin; 
        }

/* ----------------------- éšè—è®°å¿†å¼¹çª—ä¸­æ–‡æœ¬æ¡†çš„æ»šåŠ¨æ¡ ----------------------- */
        
        /* é’ˆå¯¹ Chrome/Safari/Edge */
        #memory-content-container textarea::-webkit-scrollbar {
            display: none;
        }

        /* é’ˆå¯¹ Firefox */
        #memory-content-container textarea {
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }

/* ä»…èŠå¤©ç•Œé¢æ»‘åŠ¨æ•ˆæœ */
#chat-window {
    position: absolute;
    top: 0px;
    bottom: 0;
    left: 0;
    right: 0;
    overflow: hidden;
}

/* è¿›å…¥èŠå¤©ç•Œé¢æ—¶çš„åŠ¨ç”» - ä»å³å‘å·¦æ»‘åŠ¨ */
.slide-in-right {
    animation: slideInRight 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

/* é€€å‡ºèŠå¤©ç•Œé¢æ—¶çš„åŠ¨ç”» - ä»å·¦å‘å³æ»‘åŠ¨ */
.slide-out-left {
    animation: slideOutLeft 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

/* ç¡®ä¿æ¶ˆæ¯å®¹å™¨åœ¨åŠ¨ç”»å¼€å§‹æ—¶å°±æ˜¯å¯è§çš„ */
#chat-window.slide-in-right .messages-container {
    opacity: 1;
    transition: opacity 0.1s;
}

/* ä¿®æ”¹åŠ¨ç”»ï¼Œç¡®ä¿å†…å®¹åŒæ—¶å‡ºç° */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(0);
    }
}

@keyframes slideOutLeft {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%); /* å‘å³æ»‘å‡º */
        opacity: 0.9;
    }
}

/* å¼ºåˆ¶æ‰€æœ‰å¤´åƒåœ†è§’ - Safariå…¼å®¹ */
.avatar,
.chat-message.ai .avatar,
.contact-avatar {
    -webkit-border-radius: 8px !important;
    -moz-border-radius: 8px !important;
    border-radius: 8px !important;
    overflow: hidden !important;
}

/* å¤´åƒå†…çš„å›¾ç‰‡ */
.avatar img,
.chat-message.ai .avatar img,
.contact-avatar img {
    -webkit-border-radius: 8px !important;
    -moz-border-radius: 8px !important;
    border-radius: 8px !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
}

/* å¯¹äºå¤´åƒæ–‡å­—ï¼ˆéå›¾ç‰‡ï¼‰ä¹Ÿç¡®ä¿åœ†è§’ */
.contact-avatar:not(:has(img)) {
    -webkit-border-radius: 8px !important;
    -moz-border-radius: 8px !important;
    border-radius: 8px !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
}

/* ----------------------- AIæ¶ˆæ¯æ“ä½œèœå• ----------------------- */
.context-menu {
    position: fixed;
    background: transparent; /* æ”¹ä¸ºé€æ˜èƒŒæ™¯ */
    border: none; /* å»æ‰è¾¹æ¡† */
    border-radius: 0; /* å»æ‰åœ†è§’ */
    box-shadow: none; /* å»æ‰é˜´å½± */
    z-index: 9999;
    min-width: 40px; /* ç¼©å°å®½åº¦ */
    overflow: visible; /* å…è®¸å†…å®¹è¶…å‡º */
    backdrop-filter: none; /* å»æ‰æ¨¡ç³Šæ•ˆæœ */
    -webkit-backdrop-filter: none;
    animation: menuFadeIn 0.2s ease;
    padding: 0; /* å»æ‰å†…è¾¹è· */
    margin-left: -8px !important;
}

@keyframes menuFadeIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.menu-item {
    padding: 0; /* å»æ‰å†…è¾¹è· */
    color: var(--text-color-primary); /* ä½¿ç”¨æ–‡å­—é¢œè‰² */
    font-size: 24px; /* ç¨å¾®è°ƒå¤§å­—ä½“ */
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    white-space: nowrap;
    border-bottom: none;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 40px;
    width: 40px;
    background: transparent; /* é€æ˜èƒŒæ™¯ */
    border-radius: 0; /* å»æ‰åœ†è§’ */

     /* æ–°å¢ï¼šå¼ºåˆ¶ä¿æŒæ­£æ–¹å½¢ */
    aspect-ratio: 1 / 1; /* å®½é«˜æ¯”1:1 */
    
    /* é’ˆå¯¹ä¸æ”¯æŒaspect-ratioçš„æµè§ˆå™¨ */
    min-height: 40px;
    min-width: 40px;
}

/* æ‰‹æœºï¼šæ›´å¤§çš„å›¾æ ‡ */
@media screen and (max-width: 768px) {
    .context-menu {
        min-width: 60px !important;
    }
    .menu-item {
        font-size: 40px !important;
        height: 60px !important;
        width: 60px !important;

        aspect-ratio: 1 / 1 !important;
        min-height: 60px !important;
        min-width: 60px !important;
    }
}

.menu-item:hover {
    background-color: transparent;
    color: #95ec69; /* é¼ æ ‡æ‚¬åœæ—¶ç”¨ç”¨æˆ·æ°”æ³¡é¢œè‰² */
}

.dark-mode .menu-item:hover {
    color: #07C160; /* æ·±è‰²æ¨¡å¼ç”¨æ·±ç»¿è‰² */
}

.menu-item:active {
    background-color: transparent; /* å»æ‰è“è‰²èƒŒæ™¯ */
    color: #95ec69; /* ç‚¹å‡»æ—¶å˜æˆç”¨æˆ·æ°”æ³¡çš„é¢œè‰² */
}

.dark-mode .menu-item:active {
    color: #07C160; /* æ·±è‰²æ¨¡å¼ç”¨æ·±ç»¿è‰² */
}
.context-menu::before {
    display: none; /* éšè—å°ä¸‰è§’ç®­å¤´ */
}

/* æ¸©åº¦æ»‘å—æ ·å¼ - ç®€æ´ç‰ˆ */
.temp-slider-container {
    padding: 12px 0;
}

.temp-slider-track {
    position: relative;
    width: 100%;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 1.5px;
    cursor: pointer;
}

.dark-mode .temp-slider-track {
    background: rgba(255, 255, 255, 0.1);
}

.temp-slider-thumb {
    position: absolute;
    top: 50%;
    left: 35%;
    transform: translate(-50%, -50%);
    width: 18px;
    height: 18px;
    background: rgba(123, 158, 109, 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50%;
    box-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.1),
        0 0 0 1px rgba(255, 255, 255, 0.3) inset;
    cursor: pointer;
    z-index: 2;
    transition: all 0.2s ease;
}

.temp-slider-thumb:hover {
    transform: translate(-50%, -50%) scale(1.1);
}

.temp-slider-thumb:active {
    cursor: grabbing;
    transform: translate(-50%, -50%) scale(0.95);
    background: rgba(136, 171, 218, 0.9);
}

.dark-mode .temp-slider-thumb {
    background: rgba(138, 174, 127, 0.8);
    box-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
}


/* å·¦ä¾§æŒ‰é’®å®¹å™¨ */
.left-header-buttons {
    display: flex;
    align-items: center;
    gap: 1px;
     margin-left: 0;
}

/* ç»™é½¿è½®å•ç‹¬çš„æ ·å¼ */
.app-icon {
    cursor: pointer;
    font-size: 18px;
    color: var(--text-color-primary);
    padding: 8px;
    border-radius: 8px;
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
}

/* ä¿ç•™é½¿è½®çš„ç¼©æ”¾æ•ˆæœ */
.app-icon:hover {
    transform: scale(1.1);
}
.app-icon:hover {
    transform: scale(1.1); /* æ”¹ä¸ºç¼©æ”¾æ•ˆæœ */  
}

/* åˆ·æ–°æŒ‰é’®æ ·å¼ */
.refresh-btn {
    font-size: 18px;
    color: var(--text-color-primary); /* æ”¹ä¸ºå’Œé½¿è½®ä¸€æ ·çš„é¢œè‰² */
    cursor: pointer;
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    border-radius: 8px;
    min-width: 40px;
    min-height: 40px;
}

.refresh-btn:hover {
    /* æ‚¬åœæ—¶ä¸è½¬ */
}

.refresh-btn:active {
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æ–°å¢ï¼šæ¸åœåŠ¨ç”» */
@keyframes spinToStop {
    0% { transform: rotate(var(--start-angle)); }
    100% { transform: rotate(var(--end-angle)); }
}

.refresh-btn.refreshing i {
    animation: spin 0.5s linear infinite;
}

/* é¢„è®¾å¼¹çª—é¡¹æ ·å¼ */
.preset-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.preset-item:active {
    transform: translateY(0);
}

/* ç¡®ä¿é¢„è®¾ç®¡ç†å¼¹çª—ä¹Ÿæœ‰åŠ¨ç”» */
#preset-modal .modal-content {
    transform: scale(0.95);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

#preset-modal.active .modal-content {
    transform: scale(1);
    opacity: 1;
}

#preset-modal {
    transition: opacity 0.3s ease;
}

/* æ¨¡å‹é€‰æ‹©å¼¹çª—æ ·å¼ */
.model-item:active {
    background-color: var(--accent-color) !important;
    color: white !important;
}

.model-item:active div {
    color: white !important;
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
#model-list-container::-webkit-scrollbar {
    width: 6px;
}

#model-list-container::-webkit-scrollbar-thumb {
    background-color: var(--input-border);
    border-radius: 3px;
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡éšè— */
#model-list-modal > div {
    overflow: hidden; /* éšè—å¤–éƒ¨æ»šåŠ¨æ¡ */
}

/* å¼¹æ€§æ»šåŠ¨å®¹å™¨ */
#model-items-container {
    -webkit-overflow-scrolling: touch; /* iOSå¼¹æ€§æ»šåŠ¨ */
    overscroll-behavior: contain; /* é˜²æ­¢æ»šåŠ¨ä¼ æ’­ */
    height: calc(70vh - 150px); /* å›ºå®šé«˜åº¦ */
    overflow-y: scroll; /* å¯ç”¨æ»šåŠ¨ä½†éšè—æ»šåŠ¨æ¡ */
    scrollbar-width: none; /* Firefoxéšè—æ»šåŠ¨æ¡ */
    -ms-overflow-style: none; /* IEéšè—æ»šåŠ¨æ¡ */
}

/* Chrome/Safariéšè—æ»šåŠ¨æ¡ */
#model-items-container::-webkit-scrollbar {
    display: none;
}

/* å¼ºåˆ¶éšè—æ‰€æœ‰æ»šåŠ¨æ¡ */
#model-list-modal ::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
    background: transparent !important;
}

#model-list-modal ::-webkit-scrollbar-track {
    display: none !important;
    background: transparent !important;
}

#model-list-modal ::-webkit-scrollbar-thumb {
    display: none !important;
    background: transparent !important;
}

#model-list-modal ::-webkit-scrollbar-corner {
    display: none !important;
    background: transparent !important;
}

/* Firefoxéšè—æ»šåŠ¨æ¡ */
#model-list-modal {
    scrollbar-width: none !important;
}

/* æ¨¡å‹åˆ—è¡¨å®¹å™¨ç‰¹æ®Šå¤„ç† */
#model-items-container {
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
}

#model-items-container::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
}

/* å¼ºåˆ¶éšè—æ¨¡å‹å¼¹çª—çš„æ‰€æœ‰æ»šåŠ¨æ¡ */
#model-list-modal *::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
}

#model-items-container {
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
}

/* é¢„è®¾æ“ä½œæŒ‰é’®æ ·å¼ */
.preset-edit-btn, .preset-delete-btn {
    width: 30px;
    height: 30px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

.preset-edit-btn {
    background: var(--accent-color);
    color: white;
}

.preset-delete-btn {
    background: var(--danger-color);
    color: white;
    font-size: 18px;
    font-weight: bold;
}

.preset-edit-btn:hover, .preset-delete-btn:hover {
    transform: scale(1.1);
}

/* ç¼–è¾‘é¢„è®¾å¼¹çª—åŠ¨ç”» */
#edit-preset-modal {
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes modalFadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

/* å¼¹çª—åŠ¨ç”» */
@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes modalFadeOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(20px);
    }
}

/* ç°æœ‰çš„æ¨¡æ€æ¡†åŠ¨ç”»å¢å¼º */
.overlay.active .modal-content {
    transform: scale(1);
    opacity: 1;
}

.modal-content {
    transform: scale(0.95);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

/* åŠ¨æ€åˆ›å»ºçš„å¼¹çª—ä¹Ÿç»Ÿä¸€åŠ¨ç”» */
#edit-preset-modal,
#model-list-modal,
#model-list-edit-modal {
    animation: modalFadeIn 0.3s ease;
}
/* æ‰‹æœºä¸“ç”¨å¼¹çª—æ ·å¼ */
@media screen and (max-width: 768px) {
    /* æ‰€æœ‰å¼¹çª—å†…å®¹ */
    .modal-content,
    #preset-modal .modal-content,
    #new-contact-modal .modal-content,
    #memory-modal .modal-content {
        width: 90% !important;
        max-width: 300px !important;
        max-height: 70vh !important;
        padding: 20px !important;
        margin: 10px !important;
    }
    
    /* ç¼–è¾‘é¢„è®¾å¼¹çª— */
    #edit-preset-modal > div {
        width: 90% !important;
        max-width: 300px !important;
        padding: 20px !important;
    }
    
    /* æ¨¡å‹é€‰æ‹©å¼¹çª— */
    #model-list-modal > div,
    #model-list-edit-modal > div {
        width: 90% !important;
        max-width: 320px !important;
    }
    
    /* å¼¹çª—å†…éƒ¨æ ‡é¢˜ */
    .modal-content h4 {
        font-size: 18px !important;
        margin-bottom: 15px !important;
    }
    
    /* å¼¹çª—å†…éƒ¨è¾“å…¥æ¡† */
    .modal-content input,
    .modal-content textarea {
        padding: 10px !important;
        font-size: 16px !important;
    }
    
    /* å¼¹çª—æŒ‰é’® */
    .modal-footer button {
        padding: 12px 16px !important;
        font-size: 16px !important;
    }
}
   </style>
</head>
<body>

    <div class="phone-frame" id="phone-frame">
        <div class="phone-screen" id="phone-screen">
                        <div class="status-bar">
                <!-- éœ€æ±‚4: æ—¶é—´/ä¿¡å·/ç”µé‡éƒ½å»æ‰ -->
            </div>
            
            <div id="contacts-page" class="page" style="display: flex;">
               <div class="page-header" style="justify-content: space-between;">
    <div style="display: flex; align-items: center;">
        <div class="app-icon clickable" onclick="showPage('settings-page')" title="è®¾ç½®" style="margin-left: -15px; margin-right: -15px;">
    <i class="fas fa-cog"></i>
</div>
        <div class="refresh-btn clickable" onclick="refreshAllData();" title="åˆ·æ–°æ‰€æœ‰æ•°æ®">
            <i class="fa-solid fa-rotate"></i>
        </div>
    </div>
    <h3 class="small-title" style="position: static; transform: none; left: auto; width: auto;">èŠå¤©å®¤</h3>
    <div style="display: flex; align-items: center;">
        <div class="manage-button clickable" onclick="toggleManageMode()">ç®¡ç†</div>
        <div class="action-button plus-btn clickable" onclick="prepareRoleModal(null)"><i class="fa-solid fa-plus"></i></div>
    </div>
</div>
                <div id="contacts-list" class="contacts-list">
</div>
                <!-- æ‰¹é‡åˆ é™¤å·¥å…·æ  -->
                <div id="batch-toolbar" class="batch-toolbar">
                    <div>
                        <button class="batch-cancel-btn clickable" onclick="cancelBatchDelete()">å–æ¶ˆ</button>
                        <button class="select-all-btn clickable" onclick="toggleSelectAll()">å…¨é€‰</button>
                    </div>
                    <div class="batch-info" id="selected-count">å·²é€‰æ‹© 0 é¡¹</div>
                    <button class="batch-delete-btn clickable" onclick="deleteSelectedContacts()">åˆ é™¤</button>
                </div>
            </div>

            <div id="settings-page" class="page">
                <div class="page-header">
                    <div class="back-button" onclick="showPage('contacts-page')"><i class="fa-solid fa-angle-left"></i></div>
                    <h3>è®¾ç½®</h3>
                </div>
                <div class="content">
                    
<div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px;">
    
    <div style="flex: 1; display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: var(--input-bg); border-radius: var(--radius-default); border: 1px solid var(--input-border);">
        <h4 style="font-size: 16px;">ä¸»é¢˜</h4>
        <div class="theme-switch-container" style="margin: 0;">
            <div class="theme-switch-track clickable" onclick="toggleThemeAuto()">
                <div class="theme-switch-thumb"></div>
                <i class="fas fa-sun theme-icon-left"></i>
                <i class="fas fa-moon theme-icon-right"></i>
            </div>
        </div>
    </div>

    <div style="flex: 1; display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: var(--input-bg); border-radius: var(--radius-default); border: 1px solid var(--input-border);">
        <h4 style="font-size: 16px;">ä¿æ´»</h4>
        <div class="theme-switch-container" style="margin: 0;">
            <div class="theme-switch-track clickable" onclick="toggleKeepAlive()" id="keep-alive-switch" style="background: var(--input-border);">
                <div class="theme-switch-thumb" style="left: 2px;"></div>
                <i class="fas fa-lock theme-icon-left" style="color: #888; font-size: 10px; left: 8px;"></i>
                <i class="fas fa-infinity theme-icon-right" style="color: #ffd700; font-size: 10px; right: 8px;"></i>
            </div>
        </div>
    </div>
</div>

<audio id="silent-audio" loop playsinline preload="auto" style="display:none;">
    <source src="https://raw.githubusercontent.com/anars/blank-audio/master/10-seconds-of-silence.mp3" type="audio/mpeg">
</audio>
<div class="settings-group">
    <h4>API é…ç½®</h4>
    
    <!-- é¢„è®¾é€‰æ‹© -->
    <label>APIé¢„è®¾:</label>
    <input type="text" id="api-preset-display" readonly 
           style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: var(--radius-default); 
                  background: var(--input-bg); color: var(--text-color-primary); 
                  border: 1px solid var(--input-border); cursor: pointer; 
                  font-size: 16px; box-sizing: border-box;"
           value="æ–°å»ºé¢„è®¾"
           onclick="openPresetManager()">
    
    <!-- ã€æ–°å¢ã€‘å½“å‰é¢„è®¾çš„æ¨¡å‹é€‰æ‹©ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="current-preset-model-container" style="display: none; margin-bottom: 10px;">
        <label for="current-preset-model">å½“å‰é¢„è®¾æ¨¡å‹:</label>
        <input type="text" id="current-preset-model" readonly
               style="width: 100%; padding: 12px; margin-top: 5px; border: 1px solid var(--input-border); 
                      border-radius: var(--radius-default); background-color: var(--input-bg); 
                      color: var(--text-color-primary); cursor: pointer; 
                      font-size: 16px; box-sizing: border-box;"
               onclick="openCurrentPresetModelSelector()"
               placeholder="ç‚¹å‡»é€‰æ‹©æ¨¡å‹">
    </div>
    
    <!-- å½“æ²¡æœ‰é¢„è®¾æ—¶éšè—çš„åŒºåŸŸ -->
    <div id="api-fields-container" style="display: none;">
        <!-- API URL -->
        <label for="api-url">API URL:</label>
        <input type="text" id="api-url" placeholder="è¾“å…¥ API URL">
        
        <!-- API Key -->
        <label for="api-key">API Key:</label>
        <input type="password" id="api-key" placeholder="è¾“å…¥æ‚¨çš„ API Key">

        <!-- ã€ä¿®æ”¹ã€‘æ¨¡å‹é€‰æ‹©ï¼ˆç”¨äºæ–°å»ºé¢„è®¾ï¼‰ -->
        <label for="ai-model" style="margin-top: 15px;">AI æ¨¡å‹:</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="ai-model" readonly 
                   style="width: 100%; padding: 12px; margin-top: 5px; border: 1px solid var(--input-border); 
                          border-radius: var(--radius-default); background-color: var(--input-bg); 
                          color: var(--text-color-primary); cursor: pointer; 
                          font-size: 16px; box-sizing: border-box;"
                   onclick="openModelSelector()" 
                   placeholder="ç‚¹å‡»é€‰æ‹©æ¨¡å‹">
        </div>
        
        <!-- ä¿å­˜ä¸ºé¢„è®¾æŒ‰é’® -->
        <button id="save-preset-btn" onclick="saveAsPreset()" 
                style="width: 100%; padding: 12px; margin-top: 15px; 
                       border-radius: var(--radius-default); background: var(--accent-color); 
                       color: white; border: none; cursor: pointer;">
            ä¿å­˜ä¸ºé¢„è®¾
        </button>
    </div>
</div>
    
    <div class="settings-group">
    <h4>æ¨¡å‹å‚æ•°</h4>
    
    <label style="margin-top: 10px; display: block;">æ¸©åº¦ (Temperature): 
        <span id="temperature-value" style="font-weight: bold; color: var(--accent-color);">0.7</span>
    </label>
    <div class="temp-slider-container" style="margin: 12px 0 8px;">
        <div class="temp-slider-track" id="temp-track">
            <div class="temp-slider-thumb" id="temp-slider-thumb"></div>
        </div>
    </div>
    <input type="hidden" id="temperature" value="0.7">

    <div style="height: 15px;"></div> <label style="display: block;">æœ€å¤§å›å¤é•¿åº¦ (Max Tokens): 
        <span id="maxTokens-value" style="font-weight: bold; color: var(--accent-color);">2048</span>
    </label>
    <div class="temp-slider-container" style="margin: 12px 0 8px;">
        <div class="temp-slider-track" id="maxTokens-track">
            <div class="temp-slider-thumb" id="maxTokens-thumb"></div>
        </div>
    </div>
    <input type="hidden" id="maxTokens-input" value="2048">
    
    <p style="font-size: 11px; color: var(--text-color-secondary); margin-top: 10px;">
        æç¤ºï¼šæ¸©åº¦å½±å“åˆ›é€ åŠ›ï¼ŒToken å½±å“å›å¤é•¿åº¦ã€‚
    </p>
</div>

    <!-- æ–°å¢ï¼šé¢„è®¾ä¸æ­£åˆ™ç®¡ç†æ¨¡å— -->
<div class="settings-group">
    <h4>é¢„è®¾ä¸æ­£åˆ™ç®¡ç†</h4>
    
    <!-- é¢„è®¾ç®¡ç† -->
    <div style="margin-bottom: 10px;">
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: bold; font-size: 14px; color: var(--text-color-primary); margin-right: 10px;">é¢„è®¾ (Deep Preset)</label>
            <div class="theme-switch-track clickable" style="width: 40px; height: 20px; background: var(--input-border); margin-top: 10px;" onclick="toggleDeepPreset()" id="deep-preset-switch">
                <div class="theme-switch-thumb" style="width: 18px; height: 18px; top: 1px; left: 1px;"></div>
            </div>
        </div>
        
        <input type="text" id="deep-preset-display" readonly 
               style="width: 100%; padding: 10px 12px; border-radius: var(--radius-default); 
                      background: var(--input-bg); color: var(--text-color-primary); 
                      border: 1px solid var(--input-border); cursor: pointer; 
                      font-size: 14px; box-sizing: border-box;"
               value="æœªé€‰æ‹©é¢„è®¾"
               onclick="openDeepPresetManager()">
    </div>
    
    <!-- æ­£åˆ™ç®¡ç† -->
    <div>
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: bold; font-size: 14px; color: var(--text-color-primary); margin-right: 10px;">æ­£åˆ™ (Regex)</label>
            <div class="theme-switch-track clickable" style="width: 40px; height: 20px; background: var(--input-border); margin-top: 10px" onclick="toggleRegex()" id="regex-switch">
                <div class="theme-switch-thumb" style="width: 18px; height: 18px; top: 1px; left: 1px;"></div>
            </div>
        </div>
        
        <input type="text" id="regex-display" readonly 
               style="width: 100%; padding: 10px 12px; border-radius: var(--radius-default); 
                      background: var(--input-bg); color: var(--text-color-primary); 
                      border: 1px solid var(--input-border); cursor: pointer; 
                      font-size: 14px; box-sizing: border-box;"
               value="æœªé€‰æ‹©æ­£åˆ™"
               onclick="openRegexManager()">
    </div>
</div>

<!-- é¢„è®¾ç®¡ç†å¼¹çª—ï¼ˆä¸APIé¢„è®¾ç®¡ç†å®Œå…¨ç›¸åŒçš„å¸ƒå±€ï¼‰ -->
<div id="deep-preset-modal" class="overlay" style="z-index: 9999;">
    <div class="modal-content" style="width: 90%; max-width: 320px; max-height: 70vh;">
        <h4 style="margin-top: 0; margin-bottom: 20px; color: var(--text-color-primary);">é¢„è®¾ç®¡ç†</h4>
        
        <div style="max-height: 50vh; overflow-y: auto; margin-bottom: 20px;" id="deep-preset-list">
            <!-- é¢„è®¾åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            <div style="text-align: center; padding: 30px; color: var(--text-color-secondary);">
                <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“</div>
                <div>æ— é¢„è®¾</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="importDeepPresetFile()" 
                    style="padding: 10px 20px; border-radius: 8px; background: var(--accent-color); 
                           color: white; border: none; cursor: pointer;">å¯¼å…¥</button>
            <button onclick="hideModal('deep-preset-modal')" 
                    style="padding: 10px 20px; border-radius: 8px; background: var(--input-bg); 
                           color: var(--text-color-primary); border: 1px solid var(--input-border); 
                           cursor: pointer;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- æ­£åˆ™ç®¡ç†å¼¹çª—ï¼ˆä¸APIé¢„è®¾ç®¡ç†å®Œå…¨ç›¸åŒçš„å¸ƒå±€ï¼‰ -->
<div id="regex-modal" class="overlay" style="z-index: 9999;">
    <div class="modal-content" style="width: 90%; max-width: 320px; max-height: 70vh;">
        <h4 style="margin-top: 0; margin-bottom: 20px; color: var(--text-color-primary);">æ­£åˆ™ç®¡ç†</h4>
        
        <div style="max-height: 50vh; overflow-y: auto; margin-bottom: 20px;" id="regex-list">
            <!-- æ­£åˆ™åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            <div style="text-align: center; padding: 30px; color: var(--text-color-secondary);">
                <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“„</div>
                <div>æ— æ­£åˆ™</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="importRegexFile()" 
                    style="padding: 10px 20px; border-radius: 8px; background: var(--accent-color); 
                           color: white; border: none; cursor: pointer;">å¯¼å…¥</button>
            <button onclick="hideModal('regex-modal')" 
                    style="padding: 10px 20px; border-radius: 8px; background: var(--input-bg); 
                           color: var(--text-color-primary); border: 1px solid var(--input-border); 
                           cursor: pointer;">å…³é—­</button>
        </div>
    </div>
</div>                
<div class="settings-group">
    <h4>è®°å¿†é…ç½®</h4>
    
    <label for="context-limit">æºå¸¦å†å²è½®æ•° (ä¸´æ—¶è®°å¿†):</label>
    <p style="font-size: 12px; color: var(--text-color-secondary); margin-top: 2px; margin-bottom: 8px;">å‘é€ç»™AIçš„æœ€è¿‘å¯¹è¯è½®æ•°ï¼ˆ1è½®=æˆ‘é—®+AIç­”ï¼‰ã€‚</p >
    <input type="number" id="context-limit" value="10" placeholder="é»˜è®¤ 10">
    
    <label for="diary-interval">è‡ªåŠ¨å†™æ—¥è®°é¢‘ç‡ (è½®æ•°):</label>
    <p style="font-size: 12px; color: var(--text-color-secondary); margin-top: 2px; margin-bottom: 8px;">æ¯éš”å¤šå°‘è½®å¯¹è¯ï¼Œè®©AIæ€»ç»“ä¸€æ¬¡é•¿æœŸè®°å¿†ã€‚</p >
    <input type="number" id="diary-interval" value="10" placeholder="é»˜è®¤ 10">
</div>
                    <!-- æ–°å¢ï¼šå¤´åƒè®¾ç½®åŒºåŸŸ -->
                    <div class="settings-group avatar-settings">
                        <h4>AI å¤´åƒè®¾ç½®</h4>
                        <div class="avatar-preview-container">
                            <div class="avatar-preview-label">å½“å‰å¤´åƒé¢„è§ˆ</div>
                            <div id="current-ai-avatar-preview" class="contact-avatar" style="width: 80px; height: 80px; font-size: 36px;"></div>
                            <input type="file" id="ai-avatar-file" accept="image/*" style="display: none;">
                            <input type="hidden" id="ai-avatar-base64">
                                                                                                                                                                                                                        <div class="avatar-actions" style="display: flex; gap: 10px;">
                                <button class="file-upload-btn clickable" onclick="document.getElementById('ai-avatar-file').click()" style="padding: 8px 15px; font-size: 14px; height: 36px; border: none; background: var(--accent-color); color: white; border-radius: 8px; white-space: nowrap;">ä¸Šä¼ æ–°å¤´åƒ</button>
                                <button class="clickable" onclick="resetAvatar()" style="padding: 8px 15px; font-size: 14px; height: 36px; background-color: var(--input-bg); color: var(--text-color-primary); border: 1px solid var(--input-border); border-radius: 8px; white-space: nowrap;">é‡ç½®</button>
                            </div>
                        </div>
                    </div>
                    
<div class="settings-group">
    <h4>é€šçŸ¥æœåŠ¡</h4>
    <p style="font-size: 12px; color: var(--text-color-secondary); margin-bottom: 10px;">é…ç½® OneSignal åå°æ¨é€å¯†é’¥</p>
    <button onclick="showPushKeyModal()" style="width: 100%; padding: 10px; background: var(--accent-color); color: white; border: none; border-radius: 10px; cursor: pointer;">
        é…ç½®é€šçŸ¥ API
    </button>
</div>
                                        <!-- æ•°æ®ç®¡ç† -->
<div class="settings-group">
    <h4>æ•°æ®ç®¡ç†</h4>
    <div style="margin-bottom: 12px; padding: 10px; background: var(--input-bg); border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; font-size: 14px;">
            <span style="color: var(--text-color-primary);">å·²å ç”¨ç¼“å­˜:</span>
            <span id="cache-size" style="font-weight: bold; color: var(--accent-color);">è®¡ç®—ä¸­...</span>
        </div>
        <div style="height: 4px; background: var(--input-border); border-radius: 2px; margin-top: 8px; overflow: hidden;">
            <div id="cache-progress" style="height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s;"></div>
        </div>
    </div>

    <div style="display: flex; gap: 10px;">
        <button onclick="exportData()" style="flex:1; padding: 10px; background: var(--accent-color); color: white; border: none; border-radius: 10px;">å¯¼å‡ºæ•°æ®</button>
        <button onclick="importData()" style="flex:1; padding: 10px; background: var(--input-bg); color: var(--text-color-primary); border: 1px solid var(--input-border); border-radius: 10px;">å¯¼å…¥æ•°æ®</button>
    </div>
</div>

<button onclick="saveSettings()" class="options-save-btn clickable">ä¿å­˜é…ç½®</button>
                    
                    
                </div>
            </div>
            
            <!-- ä¿®æ”¹chat-windowçš„ç»“æ„ -->
<div id="chat-window" class="page">
    <div class="page-header">
        <div class="back-button" onclick="exitChatWindow()"><i class="fa-solid fa-angle-left"></i></div>
        <h3 id="chat-role-name"></h3> 
        <div class="action-button clickable" onclick="showPage('options-page')">Â·Â·Â·</div>
    </div>
    
    <!-- æ–°å¢ï¼šæ¶ˆæ¯å®¹å™¨åŒ…è£…å™¨ -->
    <div class="messages-wrapper">
        <div id="chat-messages" class="messages-container">
    <div id="loading-more" style="display:none; text-align:center; padding:10px; color:var(--text-color-secondary);">åŠ è½½ä¸­...</div>
</div>
    </div>

    <div class="chat-input-area">
        <textarea id="chat-textarea" rows="1"></textarea>
    </div>
</div>
            
<!-- AIæ¶ˆæ¯æ“ä½œèœå• -->
<div id="ai-context-menu" class="context-menu" style="display: none;">
    <div class="menu-item clickable" onclick="regenerateFromBubble()">âŸ³</div>
</div>

                        <div id="options-page" class="page">
                <div class="page-header">
                    <div class="back-button" onclick="showPage('chat-window')"><i class="fa-solid fa-angle-left"></i></div>
                    <h3 id="options-role-name"></h3> 
                </div>
                <div class="content">
                    <div class="settings-group">
                       
                    <div class="options-item clickable" onclick="showMemoryModal('prompt')">
                            <span>è§’è‰² Prompt</span>
                            <span class="indicator">ä¿®æ”¹ â¯</span>
                        </div>
                        
                        <div class="options-item clickable" onclick="showMemoryModal('short')">
                            <span>ä¸´æ—¶è®°å¿†</span>
                            <span class="indicator">æŸ¥çœ‹/ç¼–è¾‘ â¯</span>
                        </div>
                        
                        <div class="options-item clickable" onclick="showMemoryModal('long')">
                            <span>é•¿æœŸè®°å¿†</span>
                            <span class="indicator">æŸ¥çœ‹/ç¼–è¾‘ â¯</span>
                        </div>
                    </div>
                    
                    <!-- æ–°å¢ï¼šæ¸…ç†è®°å¿†åŒºåŸŸ -->
                    <div class="settings-group">
                        <h4 style="color: var(--warning-color); display: flex; align-items: center;">
    <i class="fas fa-eraser" style="margin-right: 10px;"></i>
    æ¸…ç†è®°å¿†
</h4>
                        <p style="color: var(--text-color-secondary); margin-top: 0; font-size: 14px;">è¿™äº›æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…ä½¿ç”¨</p>
                        
                        <div class="clear-buttons">
                        <button class="clear-btn clear-short-btn clickable" onclick="clearShortTermMemory()">
                            <span class="clear-icon"><i class="fas fa-broom"></i></span>
                            <span>æ¸…ç©ºä¸´æ—¶è®°å¿†</span>
                        </button>
                        
                        <button class="clear-btn clear-long-btn clickable" onclick="clearLongTermMemory()">
                            <span class="clear-icon"><i class="fas fa-trash-alt"></i></span>
                            <span>æ¸…ç©ºé•¿æœŸè®°å¿†</span>
                        </button>
                    </div>
                    </div>
                </div>
            </div>
            
            <div id="new-contact-modal" class="overlay">
    <div class="modal-content" style="width: 90%; max-width: 320px; max-height: 70vh;">
        <h4 id="modal-role-title">æ–°å»ºè§’è‰²</h4>
        
        <div class="modal-scroll-area">
            <label for="modal-role-name">è§’è‰²å:</label>
            <input type="text" id="modal-role-name" placeholder="ä¾‹å¦‚: å¿ƒç†å¯¼å¸ˆ">
            
            <label for="modal-role-prompt">è§’è‰²è®¾å®š Prompt:</label>
            <textarea id="modal-role-prompt" rows="8" placeholder="å¡«å†™å¯¹åº”çš„è§’è‰²åå’Œç›¸å…³prompt"></textarea>
            
            <input type="hidden" id="modal-role-id">
        </div>
        
        <div class="modal-footer">
            <button class="cancel-btn clickable" onclick="hideModal('new-contact-modal')">å–æ¶ˆ</button>
            <button class="save-btn clickable" onclick="saveRoleFromModal()">ä¿å­˜</button>
        </div>
    </div>
</div>
            
           <div id="memory-modal" class="overlay">
    <div class="modal-content" style="width: 90%; max-width: 320px; max-height: 70vh;"> 
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div class="back-button clickable" onclick="goBackInMemoryModal()" style="margin-right: 15px;">
    <i class="fa-solid fa-angle-left"></i>
</div>
                        <h4 id="memory-modal-title" style="margin: 0; flex-grow: 1;"></h4>
                    </div>
                    
                    <div id="memory-content-container"></div>
                    
                    <div class="modal-footer">
                        <button id="memory-save-btn" class="save-btn clickable" onclick="saveContextModalData()">ä¿å­˜ä¿®æ”¹</button>
                        <button class="cancel-btn clickable" onclick="hideModal('memory-modal')">å…³é—­</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
	// åˆå§‹åŒ–åˆ†è¯å™¨ï¼ŒæŒ‡å®šä¸­æ–‡ç¯å¢ƒ 
	const segmenter = new Intl.Segmenter('zh-Hans', { granularity: 'word' });

	// ç®€å•çš„åœç”¨è¯è¡¨ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦å¢åŠ ï¼‰
	const stopWords = new Set(['çš„', 'äº†', 'æ˜¯', 'æˆ‘', 'ä½ ', 'ä»–', 'åœ¨', 'ä¸', 'æœ‰', 'ä¸ª', 'ä¹Ÿ', 'å°±']);

function extractKeywords(text) {
    // 1. ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿèƒ½åŠ›è¿›è¡Œåˆ†è¯ 
    const segments = segmenter.segment(text);
    const keywords = [];

    for (const segment of segments) {
        // åªä¿ç•™â€œè¯è¯­â€ç±»å‹ï¼Œä¸”é•¿åº¦å¤§äº1ï¼Œä¸”ä¸æ˜¯åºŸè¯ 
        if (segment.isWordLike && segment.segment.length > 1 && !stopWords.has(segment.segment)) {
            keywords.push(segment.segment);
        }
    }
    return keywords;
}

	function calculateMemoryScore(queryKeywords, memoryKeywords) {
    let score = 0;
    queryKeywords.forEach(qKey => {
        if (memoryKeywords.includes(qKey)) {
            // åŒ¹é…åˆ°çš„è¯è¶Šé•¿ï¼Œåˆ†æ•°è¶Šé«˜ï¼ˆåŠ æƒè¯„åˆ†ï¼‰
            score += qKey.length; 
        }
    });
    return score;
}

        // æ ¸å¿ƒæ•°æ®
        let APP_DATA = JSON.parse(localStorage.getItem('AI_PHONE_APP_DATA')) || {
    contacts: [
        { 
            id: 1, 
            name: 'å¿ƒç†å¯¼å¸ˆ', 
            prompt: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¿ƒç†å¯¼å¸ˆï¼Œä»¥æ¸©æš–ã€åŒæƒ…å’Œä¸“ä¸šçš„æ€åº¦å›å¤ç”¨æˆ·çš„é—®é¢˜ã€‚', 
            history: [], 
            longMemories: [], // æ”¹ä¸ºæ•°ç»„
            shortTermMemory: [],
            summaryCount: 0,
            summaryThreshold: 30
        },
        { 
            id: 2, 
            name: 'è‹±è¯­é™ªç»ƒ', 
            prompt: 'ä½ æ˜¯ä¸€ä½åªè¯´è‹±è¯­çš„å£è¯­é™ªç»ƒï¼Œæ¯å¥è¯éƒ½å¿…é¡»æ˜¯è‹±è¯­ã€‚', 
            history: [], 
            longMemories: [], // æ”¹ä¸ºæ•°ç»„
            shortTermMemory: [],
            summaryCount: 0,
            summaryThreshold: 30
        }
    ],
    settings: {
        apiUrl: 'https://api.siliconflow.cn/v1/chat/completions',
        apiKey: '',
        aiModel: 'qwen-72b-chat',
        temperature: 0.7,
        aiAvatarBase64: 'AI',
        contextLimit: 20, // é»˜è®¤æºå¸¦20è½®å†å²
        diaryInterval: 20 // é»˜è®¤20è½®å†™ä¸€æ¬¡æ—¥è®°
    },
    currentTheme: 'light',
    currentChatId: null,
    activeModalContext: null,
    presets: [], 
    currentPresetId: null, // å½“å‰é¢„è®¾ID
    // æ–°å¢ï¼šæ·±é¢„è®¾å’Œæ­£åˆ™æ•°æ®
    deepPresets: [],        // æ·±é¢„è®¾æ•°ç»„
    regexPatterns: [],      // æ­£åˆ™è¡¨è¾¾å¼æ•°ç»„
    currentDeepPresetId: null,  // å½“å‰é€‰ä¸­çš„æ·±é¢„è®¾ID
    currentRegexId: null,       // å½“å‰é€‰ä¸­çš„æ­£åˆ™ID
    deepPresetEnabled: false,   // æ·±é¢„è®¾æ˜¯å¦å¯ç”¨
    regexEnabled: false         // æ­£åˆ™æ˜¯å¦å¯ç”¨
};  // <-- ç¡®ä¿è¿™é‡Œçš„åˆ†å·

let currentContact = null;
let isManageMode = false; // ç®¡ç†æ¨¡å¼çŠ¶æ€
let batchMode = false; // æ‰¹é‡åˆ é™¤æ¨¡å¼
let selectedContacts = new Set(); // é€‰æ‹©çš„è”ç³»äººIDé›†åˆ
let isTyping = false; // AIæ˜¯å¦æ­£åœ¨è¾“å…¥
let currentAIRequest = null; // æ–°å¢ï¼šå­˜å‚¨å½“å‰AIè¯·æ±‚
let currentController = null; // æ–°å¢ï¼šç”¨äºå–æ¶ˆè¯·æ±‚çš„æ§åˆ¶å™¨
let currentStartIndex = 0;
const PAGE_SIZE = 10; 
let isLoadingMore = false; 
        
        // ----------------------- æ•°æ®å­˜å‚¨å’ŒåŠ è½½ -----------------------
        function saveData() {
            localStorage.setItem('AI_PHONE_APP_DATA', JSON.stringify(APP_DATA));
        }

        function loadSettings() {
    document.getElementById('api-url').value = APP_DATA.settings.apiUrl;
    document.getElementById('api-key').value = APP_DATA.settings.apiKey;
    document.getElementById('ai-model').value = APP_DATA.settings.aiModel;
    document.getElementById('temperature').value = APP_DATA.settings.temperature || 0.7;
    document.getElementById('maxTokens-input').value = APP_DATA.settings.maxTokens || 2048; // æ–°å¢åŠ è½½é¡¹
    document.getElementById('context-limit').value = APP_DATA.settings.contextLimit || 20;
    document.getElementById('diary-interval').value = APP_DATA.settings.diaryInterval || 10;
    
    loadAvatarPreview(APP_DATA.settings.aiAvatarBase64, 'current-ai-avatar-preview');
    document.getElementById('ai-avatar-base64').value = APP_DATA.settings.aiAvatarBase64;
    
    // ã€æ–°å¢ã€‘åŠ è½½å½“å‰é¢„è®¾çš„æ˜¾ç¤º
    if (APP_DATA.currentPresetId) {
        const preset = APP_DATA.presets.find(p => p.id == APP_DATA.currentPresetId);
        if (preset) {
            document.getElementById('api-preset-display').value = preset.name;
            document.getElementById('save-preset-btn').style.display = 'none';
            document.getElementById('api-fields-container').style.display = 'none';
        // æ–°å¢ï¼šåŠ è½½æ·±é¢„è®¾å’Œæ­£åˆ™è®¾ç½®
             loadDeepPresetAndRegexSettings();
        }
    }
}
        
        // æ–°å¢ï¼šåˆå§‹åŒ–é¢„è®¾ç³»ç»Ÿ
function initPresetSystem() {
    const apiFieldsContainer = document.getElementById('api-fields-container');
    const modelContainer = document.getElementById('current-preset-model-container');
    
    // ç¡®ä¿é¢„è®¾æ•°ç»„å­˜åœ¨
    if (!APP_DATA.presets) {
        APP_DATA.presets = [];
    }
    
    console.log('åˆå§‹åŒ–é¢„è®¾ç³»ç»Ÿï¼Œé¢„è®¾æ•°é‡:', APP_DATA.presets.length);
    
    if (APP_DATA.presets.length === 0) {
        // æ²¡æœ‰é¢„è®¾ï¼Œæ˜¾ç¤ºæ–°å»ºé¢„è®¾çŠ¶æ€
        document.getElementById('api-preset-display').value = 'æ–°å»ºé¢„è®¾';
        document.getElementById('save-preset-btn').style.display = 'block';
        APP_DATA.currentPresetId = null;
        
        // ã€æ–°å¢ã€‘éšè—å½“å‰é¢„è®¾æ¨¡å‹é€‰æ‹©æ¡†
        if (modelContainer) {
            modelContainer.style.display = 'none';
        }
        
        // æ˜¾ç¤º API è¾“å…¥å­—æ®µï¼ˆå› ä¸ºæ˜¯æ–°å»ºé¢„è®¾çŠ¶æ€ï¼‰
        if (apiFieldsContainer) {
            apiFieldsContainer.style.display = 'block';
        }
    } else {
        // å¦‚æœæœ‰é¢„è®¾ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ªæˆ–å½“å‰é¢„è®¾
        if (APP_DATA.currentPresetId) {
            loadPreset(APP_DATA.currentPresetId);
        } else {
            loadPreset(APP_DATA.presets[0].id);
        }
    }
}


// æ˜¾ç¤ºé¢„è®¾ç®¡ç†å¼¹çª—ï¼ˆç®€å•ç‰ˆï¼‰
function showPresetModal() {
    refreshPresetList(); // åˆ·æ–°åˆ—è¡¨
    showModal('preset-modal'); // æ˜¾ç¤ºå¼¹çª—
}

// æ–°å¢ï¼šåœ¨å¼¹çª—ä¸­ç¼–è¾‘é¢„è®¾
function editPresetInModal(presetId, event) {
    event.stopPropagation();
    
    const preset = APP_DATA.presets.find(p => p.id == presetId);
    if (!preset) return;
    
    const newName = prompt('ä¿®æ”¹é¢„è®¾åç§°:', preset.name);
    if (newName && newName.trim()) {
        preset.name = newName.trim();
        saveData();
        showPresetModal(); // åˆ·æ–°å¼¹çª—
    }
}

// æ–°å¢ï¼šåœ¨å¼¹çª—ä¸­åˆ é™¤é¢„è®¾
function deletePresetInModal(presetId, event) {
    event.stopPropagation();
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿ')) return;
    
    // ä»æ•°ç»„ä¸­åˆ é™¤
    APP_DATA.presets = APP_DATA.presets.filter(p => p.id != presetId);
    
    // å¦‚æœåˆ çš„æ˜¯å½“å‰é¢„è®¾
    if (APP_DATA.currentPresetId == presetId) {
        // å¦‚æœè¿˜æœ‰é¢„è®¾ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
        if (APP_DATA.presets.length > 0) {
            loadPreset(APP_DATA.presets[0].id);
        } else {
            // æ²¡æœ‰é¢„è®¾äº†ï¼Œå›åˆ°æ–°å»ºçŠ¶æ€
            document.getElementById('api-preset-display').value = 'æ–°å»ºé¢„è®¾';
            document.getElementById('api-url').value = '';
            document.getElementById('api-key').value = '';
            document.getElementById('ai-model').value = '';
            document.getElementById('save-preset-btn').style.display = 'block';
            APP_DATA.currentPresetId = null;
        }
    }
    
    saveData();
    showPresetModal(); // åˆ·æ–°å¼¹çª—
}

function loadPreset(presetId) {
    const preset = APP_DATA.presets.find(p => p.id == presetId);
    const apiFieldsContainer = document.getElementById('api-fields-container');
    const modelContainer = document.getElementById('current-preset-model-container');
    
    if (!preset) {
        console.log('æœªæ‰¾åˆ°é¢„è®¾:', presetId);
        return;
    }
    
    console.log('åŠ è½½é¢„è®¾:', preset.name);
    
    APP_DATA.currentPresetId = presetId;
    document.getElementById('api-preset-display').value = preset.name;
    
    // ã€æ–°å¢ã€‘è®°å½•æœ€åä½¿ç”¨æ—¶é—´
    preset.lastUsedTime = Date.now();
    
    // ã€æ–°å¢ã€‘æ˜¾ç¤ºå½“å‰é¢„è®¾çš„æ¨¡å‹é€‰æ‹©æ¡†
    if (modelContainer) {
        modelContainer.style.display = 'block';
        document.getElementById('current-preset-model').value = preset.defaultModel || '';
    }
    
    // ã€æ–°å¢ã€‘éšè—æ–°å»ºé¢„è®¾åŒºåŸŸï¼ˆå¦‚æœæœ‰é¢„è®¾ï¼‰
    if (apiFieldsContainer) {
        apiFieldsContainer.style.display = 'none';
    }
    document.getElementById('save-preset-btn').style.display = 'none';
    
    // åŒæ­¥åˆ°settings
    APP_DATA.settings.apiUrl = preset.apiUrl || '';
    APP_DATA.settings.apiKey = preset.apiKey || '';
    APP_DATA.settings.aiModel = preset.defaultModel || '';
    
    // ä¿å­˜å½“å‰çŠ¶æ€
    saveData();
}

// æ–°å¢ï¼šåˆ›å»ºæ–°é¢„è®¾ï¼ˆä»å¼¹çª—ï¼‰
function createNewPreset() {
    hideModal('preset-modal');
    selectPreset('new');
}

/// ä¿å­˜ä¸ºé¢„è®¾ï¼ˆç®€å•ç‰ˆï¼‰
function saveAsPreset() {
    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    const model = document.getElementById('ai-model').value.trim();
    
    if (!apiUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™API URLå’ŒAPI Key');
        return;
    }
    
    const presetName = prompt('è¯·è¾“å…¥é¢„è®¾åç§°:', 'æˆ‘çš„é¢„è®¾');
    if (!presetName || !presetName.trim()) return;
    
        // åˆ›å»ºæ–°é¢„è®¾
    const newPreset = {
        id: Date.now(),
        name: presetName.trim(),
        apiUrl: apiUrl,
        apiKey: apiKey,
        defaultModel: model,
        lastUsedTime: Date.now()  
    };
    
    console.log('æ­£åœ¨ä¿å­˜é¢„è®¾:', newPreset); // è°ƒè¯•ç”¨
    
    // æ·»åŠ åˆ°é¢„è®¾æ•°ç»„
    if (!APP_DATA.presets) {
        APP_DATA.presets = [];
    }
    APP_DATA.presets.push(newPreset);
    APP_DATA.currentPresetId = newPreset.id;
    
    // åŒæ­¥åˆ°settings
    APP_DATA.settings.apiUrl = apiUrl;
    APP_DATA.settings.apiKey = apiKey;
    APP_DATA.settings.aiModel = model;
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('AI_PHONE_APP_DATA', JSON.stringify(APP_DATA));
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('api-preset-display').value = newPreset.name;
    document.getElementById('save-preset-btn').style.display = 'none';
    
    // éšè—APIè¾“å…¥å­—æ®µ
    const apiFieldsContainer = document.getElementById('api-fields-container');
    if (apiFieldsContainer) {
        apiFieldsContainer.style.display = 'none';
    }
    
    alert('é¢„è®¾ä¿å­˜æˆåŠŸï¼');
    
    // åˆ·æ–°é¢„è®¾åˆ—è¡¨ï¼ˆå¦‚æœå¼¹çª—æ‰“å¼€ç€ï¼‰
    refreshPresetList();
}

async function fetchModels() {
    // è·å–APIä¿¡æ¯
    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    
    // éªŒè¯
    if (!apiUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™API URLå’ŒAPI Key');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½ä¸­
    const modelInput = document.getElementById('ai-model');
    const originalValue = modelInput.value;
    modelInput.value = 'æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...';
    modelInput.disabled = true;
    
    try {
        // æ„å»ºæ¨¡å‹åˆ—è¡¨URLï¼ˆå…¼å®¹ä¸åŒAPIæä¾›å•†ï¼‰
        let modelsUrl = '';
        if (apiUrl.includes('siliconflow')) {
            modelsUrl = apiUrl.replace('/chat/completions', '/models');
        } else if (apiUrl.includes('openai')) {
            modelsUrl = 'https://api.openai.com/v1/models';
        } else {
            // é€šç”¨æ ¼å¼ï¼šå°è¯•ç§»é™¤è·¯å¾„æœ«å°¾éƒ¨åˆ†
            modelsUrl = apiUrl.replace(/\/chat\/completions$/, '/models');
        }
        
        console.log('è¯·æ±‚æ¨¡å‹åˆ—è¡¨URL:', modelsUrl);
        
        // å‘é€è¯·æ±‚
        const response = await fetch(modelsUrl, {
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        const data = await response.json();
        
        // æå–æ¨¡å‹åˆ—è¡¨ï¼ˆå…¼å®¹ä¸åŒæ ¼å¼ï¼‰
        let models = [];
        if (Array.isArray(data)) {
            models = data; // ç›´æ¥æ˜¯æ•°ç»„
        } else if (data.data && Array.isArray(data.data)) {
            models = data.data; // {data: [...]}
        } else if (data.models && Array.isArray(data.models)) {
            models = data.models; // {models: [...]}
        }
        
        if (models.length === 0) {
            alert('æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°');
            modelInput.value = originalValue;
            return;
        }
        
        // æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å¼¹çª—
        showModelSelectDialog(models);
        
    } catch (error) {
        console.error('è·å–æ¨¡å‹å¤±è´¥:', error);
        alert('è·å–æ¨¡å‹å¤±è´¥: ' + error.message + '\nè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°');
    } finally {
        modelInput.disabled = false;
        if (modelInput.value === 'æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...') {
            modelInput.value = originalValue;
        }
    }
}


       
        function saveSettings() {
    // ã€é‡è¦ä¿®æ”¹ã€‘å¦‚æœå½“å‰åœ¨"æ–°å»ºé¢„è®¾"çŠ¶æ€ï¼Œä¸è¦æ›´æ–°ä»»ä½•é¢„è®¾
    if (APP_DATA.currentPresetId) {
        const preset = APP_DATA.presets.find(p => p.id == APP_DATA.currentPresetId);
        if (preset) {
            preset.apiUrl = document.getElementById('api-url').value;
            preset.apiKey = document.getElementById('api-key').value;
            preset.defaultModel = document.getElementById('ai-model').value;
        }
    }
    
    // ä¿å­˜åˆ°APP_DATA.settings
    APP_DATA.settings.apiUrl = document.getElementById('api-url').value;
    APP_DATA.settings.apiKey = document.getElementById('api-key').value;
    APP_DATA.settings.aiModel = document.getElementById('ai-model').value;
   APP_DATA.settings.temperature = parseFloat(document.getElementById('temperature').value) || 0.7; [cite_start]// [cite: 488, 955]
    APP_DATA.settings.maxTokens = parseInt(document.getElementById('maxTokens-input').value) || 2048; // æ–°å¢ä¿å­˜é¡¹
    // æ–°å¢ï¼šä¿å­˜è®°å¿†è®¾ç½®
    APP_DATA.settings.contextLimit = parseInt(document.getElementById('context-limit').value) || 20;
    APP_DATA.settings.diaryInterval = parseInt(document.getElementById('diary-interval').value) || 10;
APP_DATA.settings.oneSignalKey = document.getElementById('onesignal-key').value;

    const avatarBase64 = document.getElementById('ai-avatar-base64').value;
    APP_DATA.settings.aiAvatarBase64 = avatarBase64 || 'AI';
    
    saveData();
    alert('è®¾ç½®å·²ä¿å­˜ï¼');
    renderContacts(); 
}
        
// æ˜¾ç¤ºå¼¹çª—å¹¶åŠ è½½å·²ä¿å­˜çš„ Key
function showPushKeyModal() {
    // ç¡®ä¿ä» APP_DATA è¯»å–
    const savedKey = APP_DATA.settings.oneSignalKey || '';
    document.getElementById('onesignal-key-input').value = savedKey;
    showModal('push-key-modal');
}

function savePushKey() {
    const keyVal = document.getElementById('onesignal-key-input').value.trim();
    if (!keyVal) return;
    
    // å¼ºåˆ¶æ›´æ–°åˆ° settings å¯¹è±¡ä¸­ï¼Œé˜²æ­¢è¢« saveSettings è¦†ç›–
    APP_DATA.settings.oneSignalKey = keyVal;
    
    saveData(); // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ [cite: 496]
    hideModal('push-key-modal');
    alert('é€šçŸ¥ API é…ç½®å·²æˆåŠŸåŒæ­¥ï¼');
}
        // ----------------------- é¡µé¢åˆ‡æ¢ -----------------------
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'flex';
            
            if (pageId === 'settings-page') {
                loadSettings();
                updateCacheSize();
            } else if (pageId === 'options-page') {
                document.getElementById('options-role-name').textContent = currentContact ? currentContact.name + ' é€‰é¡¹' : 'é€‰é¡¹';
          } else if (pageId === 'chat-window') {
    // æ™ºèƒ½æ›´æ–°ï¼šæ ¹æ®æ ‡è®°æˆ–æ•°æ®å˜åŒ–å†³å®šæ˜¯å¦é‡æ–°æ¸²æŸ“
    if (currentContact) {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆæ¯”å¦‚ä»è®°å¿†ç¼–è¾‘é¡µé¢è¿”å›ï¼‰
        if (window.needRefreshChat) {
            renderMessages(currentContact.history);
            window.needRefreshChat = false; // é‡ç½®æ ‡è®°
        } else {
            // æ£€æŸ¥æ¶ˆæ¯æ•°é‡æ˜¯å¦ä¸€è‡´
            const container = document.getElementById('chat-messages');
            if (container) {
                const displayedCount = container.querySelectorAll('.chat-message').length;
                const actualCount = currentContact.history.length;
                
                // å¦‚æœæ•°é‡ä¸ä¸€è‡´ï¼ˆæ¯”å¦‚æ¸…ç†äº†è®°å¿†ï¼‰ï¼Œé‡æ–°æ¸²æŸ“
                if (displayedCount !== actualCount) {
                    renderMessages(currentContact.history);
                }
            }
        }
        
        scrollToBottomInstant();
    }
} else if (pageId === 'contacts-page') {
                // é€€å‡ºèŠå¤©çª—å£æ—¶é€€å‡ºç®¡ç†æ¨¡å¼
                isManageMode = false;
                batchMode = false;
                selectedContacts.clear();
                document.getElementById('batch-toolbar').classList.remove('show');
                renderContacts();
            }
        }

        function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.style.display = 'flex';
    
    // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿åŠ¨ç”»ç”Ÿæ•ˆ
    modal.offsetWidth;
    
    modal.classList.add('active');
}

       function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // ç§»é™¤activeç±»å¼€å§‹æ·¡å‡ºåŠ¨ç”»
    modal.classList.remove('active');
    
    // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

        function toggleTheme(mode) {
            if (mode === 'dark') {
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
            }
            APP_DATA.currentTheme = mode;
            saveData();
        }

        // ----------------------- èŠå¤©å®¤ (è”ç³»äºº) ç®¡ç† -----------------------
        
        // åˆ‡æ¢ç®¡ç†æ¨¡å¼
        function toggleManageMode() {
            isManageMode = !isManageMode;
            batchMode = isManageMode;
            
            if (!batchMode) {
                selectedContacts.clear();
                document.getElementById('batch-toolbar').classList.remove('show');
            } else {
                document.getElementById('batch-toolbar').classList.add('show');
                updateSelectedCount();
            }
            
            renderContacts();
        }
        
        function cancelBatchDelete() {
            batchMode = false;
            isManageMode = false;
            selectedContacts.clear();
            document.getElementById('batch-toolbar').classList.remove('show');
            renderContacts();
        }
        
        function toggleSelectAll() {
            if (selectedContacts.size === APP_DATA.contacts.length) {
                // å¦‚æœå·²ç»å…¨é€‰ï¼Œåˆ™å–æ¶ˆå…¨é€‰
                selectedContacts.clear();
            } else {
                // å¦åˆ™å…¨é€‰
                APP_DATA.contacts.forEach(contact => {
                    selectedContacts.add(contact.id);
                });
            }
            renderContacts();
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = `å·²é€‰æ‹© ${selectedContacts.size} é¡¹`;
        }
        
        function toggleContactSelection(id) {
            if (selectedContacts.has(id)) {
                selectedContacts.delete(id);
            } else {
                selectedContacts.add(id);
            }
            renderContacts();
            updateSelectedCount();
        }
        
        function deleteSelectedContacts() {
            if (selectedContacts.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„èŠå¤©å®¤');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedContacts.size} ä¸ªèŠå¤©å®¤å—ï¼Ÿ`)) {
                APP_DATA.contacts = APP_DATA.contacts.filter(c => !selectedContacts.has(c.id));
                saveData();
                selectedContacts.clear();
                batchMode = false;
                isManageMode = false;
                document.getElementById('batch-toolbar').classList.remove('show');
                renderContacts();
            }
        }

        function renderContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            
            if (APP_DATA.contacts.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-color-secondary);">æš‚æ— èŠå¤©å®¤</div>';
                return;
            }

            APP_DATA.contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-item clickable'; 
                
                // æ‰¹é‡é€‰æ‹©æ¡†æˆ–åˆ é™¤æŒ‰é’®
                if (batchMode) {
                    const checkboxWrapper = document.createElement('div');
                    checkboxWrapper.className = `contact-checkbox ${batchMode ? 'show' : ''}`;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = selectedContacts.has(contact.id);
                    checkbox.onclick = (e) => {
                        e.stopPropagation();
                        toggleContactSelection(contact.id);
                    };
                    checkboxWrapper.appendChild(checkbox);
                    item.appendChild(checkboxWrapper);
                } 
                    else if (isManageMode) {
    const actionWrapper = document.createElement('div');
    actionWrapper.className = `delete-btn-wrapper ${isManageMode ? 'show' : ''}`;
    actionWrapper.style.display = 'flex';
    actionWrapper.style.gap = '10px';
    actionWrapper.style.alignItems = 'center';
    
    // ä¿®æ”¹æŒ‰é’®
    const editBtn = document.createElement('div');
    editBtn.className = 'edit-icon';
    editBtn.innerHTML = 'âœ';
    editBtn.style.cssText = 'width:22px;height:22px;border-radius:50%;background-color:#88ABDA;color:white;display:flex;justify-content:center;align-items:center;font-size:14px;cursor:pointer;';
    editBtn.onclick = (e) => {
        e.stopPropagation();
        const newName = prompt('ä¿®æ”¹è§’è‰²åï¼š', contact.name);
        if (newName && newName.trim()) {
            contact.name = newName.trim();
            saveData();
            renderContacts();
            alert('ä¿®æ”¹æˆåŠŸï¼');
        }
    };
    
    // åˆ é™¤æŒ‰é’®
    const deleteBtn = document.createElement('div');
    deleteBtn.className = 'delete-icon';
    deleteBtn.textContent = '-';
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteContact(contact.id);
    };
    
    actionWrapper.appendChild(editBtn);
    actionWrapper.appendChild(deleteBtn);
    item.appendChild(actionWrapper);
}
                
                // å¤´åƒ
                const avatar = document.createElement('div');
                avatar.className = 'contact-avatar';
                // ä½¿ç”¨ AI è®¾ç½®çš„å¤´åƒæˆ–é»˜è®¤é¦–å­—
                if(APP_DATA.settings.aiAvatarBase64 && APP_DATA.settings.aiAvatarBase64 !== 'AI' && APP_DATA.settings.aiAvatarBase64.startsWith('data:image')) {
                     const img = document.createElement('img');
                     img.src = APP_DATA.settings.aiAvatarBase64;
                     avatar.appendChild(img);
                } else {
                     avatar.textContent = contact.name.charAt(0);
                }
                item.appendChild(avatar);

                                                                // åå­—
                let nameElement;
                
                if (isManageMode) {
                    // ç®¡ç†æ¨¡å¼ï¼šæ˜¾ç¤ºè¾“å…¥æ¡†
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = contact.name;
                    nameInput.style.cssText = `
                        border: 1px solid var(--accent-color);
                        border-radius: 6px;
                        padding: 4px 8px;
                        background: var(--bg-color-secondary);
                        color: var(--text-color-primary);
                        font-size: inherit;
                        width: 120px;
                        user-select: text !important;
                        -webkit-user-select: text !important;
                        caret-color: #07C160;
                    `;
                    nameInput.onclick = (e) => {
                        e.stopPropagation();
                        nameInput.select();
                    };
                    nameInput.onblur = () => {
                        const newName = nameInput.value.trim();
                        if (newName && newName !== contact.name) {
                            contact.name = newName;
                            saveData();
                            renderContacts();
                        }
                    };
                    nameInput.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            nameInput.blur();
                        }
                        e.stopPropagation();
                    };
                    nameElement = nameInput;
                } else {
                    // æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºæ™®é€šæ–‡æœ¬
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = contact.name;
                    nameElement = nameSpan;
                }
                     // æ·»åŠ åˆ°itemå‰å…ˆç§»é™¤ç‚¹å‡»åŠ¨ç”»ç±»
                item.classList.remove('clickable');
                item.appendChild(nameElement);
                
                              // ç‚¹å‡»äº‹ä»¶
item.onclick = () => {
    if (batchMode) {
        toggleContactSelection(contact.id);
    } else {
        openChatWindow(contact.id);
    }
};


                list.appendChild(item);
            });
        }
        
        function deleteContact(id) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠå¤©å®¤å—ï¼Ÿ')) {
                APP_DATA.contacts = APP_DATA.contacts.filter(c => c.id !== id);
                saveData();
                renderContacts();
            }
        }
        
        function prepareRoleModal(contact = null) {
            document.getElementById('modal-role-id').value = contact ? contact.id : '';
            document.getElementById('modal-role-name').value = contact ? contact.name : '';
            document.getElementById('modal-role-prompt').value = contact ? contact.prompt : '';
            document.getElementById('modal-role-title').textContent = contact ? 'ç¼–è¾‘è§’è‰²' : 'æ–°å»ºè§’è‰²';
            
            showModal('new-contact-modal');
        }

        function saveRoleFromModal() {
            const id = document.getElementById('modal-role-id').value;
            const name = document.getElementById('modal-role-name').value.trim();
            const prompt = document.getElementById('modal-role-prompt').value.trim();
            
            if (!name || !prompt) {
                alert('è§’è‰²åå’Œ Prompt ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            
            if (id) {
                const contact = APP_DATA.contacts.find(c => c.id == id);
                if (contact) {
                    contact.name = name;
                    contact.prompt = prompt;
                }
            } else {
                const newId = APP_DATA.contacts.length > 0 ? Math.max(...APP_DATA.contacts.map(c => c.id)) + 1 : 1;
                APP_DATA.contacts.push({
                    id: newId,
                    name: name,
                    prompt: prompt,
                    history: [],
                    longMemory: 'æ— '
                });
            }
            saveData();
            renderContacts();
            hideModal('new-contact-modal');
        }
        
        // ----------------------- èŠå¤©é€»è¾‘ -----------------------
      function openChatWindow(contactId) {
    // é‡ç½®åˆ†é¡µ
      currentStartIndex = 0;
    const contactsPage = document.getElementById('contacts-page');
    const chatWindow = document.getElementById('chat-window');
    
    // è®¾ç½®èŠå¤©ä¿¡æ¯
    APP_DATA.currentChatId = contactId;
    currentContact = APP_DATA.contacts.find(c => c.id === contactId);
    document.getElementById('chat-role-name').textContent = currentContact.name;
    
    // å…ˆéšè—èŠå¤©å®¤
    contactsPage.style.display = 'none';
    
    // ç«‹å³æ˜¾ç¤ºèŠå¤©çª—å£
    chatWindow.style.display = 'flex';
    chatWindow.classList.add('slide-in-right');
    
    // ã€å…³é”®ä¿®æ”¹ã€‘åœ¨åŠ¨ç”»å¼€å§‹å‰å°±æ¸²æŸ“æ¶ˆæ¯
   renderMessages(currentContact.history.slice(-20));
    
    // ã€å…³é”®ä¿®æ”¹ã€‘ç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä¸ç­‰å¾…
    setTimeout(() => {
        const container = document.getElementById('chat-messages');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }, 10);
    
    // ç­‰å¾…åŠ¨ç”»ç»“æŸ
    setTimeout(() => {
        chatWindow.classList.remove('slide-in-right');
    }, 300);
}
        
       function exitChatWindow() {
    const contactsPage = document.getElementById('contacts-page');
    const chatWindow = document.getElementById('chat-window');
    
 
    currentAIRequest = null;
    isTyping = false;
    
    // 3. åŠ¨ç”»æ•ˆæœ
    chatWindow.classList.add('slide-out-left');
    contactsPage.style.display = 'flex';
    
    setTimeout(() => {
        chatWindow.style.display = 'none';
        chatWindow.classList.remove('slide-out-left');
        
        // 4. é€€å‡ºç®¡ç†æ¨¡å¼
        isManageMode = false;
        batchMode = false;
        selectedContacts.clear();
        document.getElementById('batch-toolbar').classList.remove('show');
        renderContacts();
    }, 300);
}

       function renderMessages(history, startFromEnd = true) {
    const container = document.getElementById('chat-messages');
    
    if (startFromEnd) {
        // ä»æœ€åå¼€å§‹æ˜¾ç¤º
        currentStartIndex = Math.max(0, history.length - PAGE_SIZE);
    }
    
    const messagesToShow = history.slice(currentStartIndex);
    
    // æ¸…ç©ºå®¹å™¨ä½†ä¿ç•™åŠ è½½æç¤º
    const loadingElement = document.getElementById('loading-more');
    container.innerHTML = '';
    if (loadingElement) {
        container.appendChild(loadingElement);
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    let segmentGroup = [];
    
    messagesToShow.forEach((msg, index) => {
        if (msg.role === 'ai' && msg.isSegment && msg.segmentIndex !== undefined) {
            if (msg.segmentIndex === 0) {
                if (segmentGroup.length > 0) {
                    displaySegmentGroup(segmentGroup, container);
                }
                segmentGroup = [msg];
            } else {
                segmentGroup.push(msg);
            }
        } else {
            if (segmentGroup.length > 0) {
                displaySegmentGroup(segmentGroup, container);
                segmentGroup = [];
            }
            appendMessageToDOM(msg.content, msg.role, false);
        }
    });
    
    if (segmentGroup.length > 0) {
        displaySegmentGroup(segmentGroup, container);
    }
    
    scrollToBottomInstant();
}

function loadMoreMessages() {
    if (!currentContact || isLoadingMore) return;
    
    // å·²ç»æ˜¯æœ€å‰é¢äº†
    if (currentStartIndex <= 0) return;
    
    isLoadingMore = true;
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    const loadingElement = document.getElementById('loading-more');
    if (loadingElement) {
        loadingElement.style.display = 'block';
    }
    
    // å¾€å‰å–10æ¡
    currentStartIndex = Math.max(0, currentStartIndex - PAGE_SIZE);
    
    // é‡æ–°æ¸²æŸ“
    setTimeout(() => {
        renderMessages(currentContact.history, false);
        isLoadingMore = false;
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }, 300);
}

// æ–°å¢ï¼šç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆä¸ä½¿ç”¨åŠ¨ç”»ï¼‰
function scrollToBottomInstant() {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    
    const messages = container.querySelectorAll('.chat-message');
    if (messages.length === 0) return;
    
    const lastMessage = messages[messages.length - 1];
    const desiredSpacing = 15;
    
    // è®¡ç®—ç›®æ ‡æ»šåŠ¨ä½ç½®
    const lastMessageBottom = lastMessage.offsetTop + lastMessage.offsetHeight;
    const containerHeight = container.clientHeight;
    
    // ç›®æ ‡ä½ç½®ï¼šæœ€åä¸€æ¡æ¶ˆæ¯åº•éƒ¨ + æœŸæœ›çš„é—´è·
    const targetScroll = lastMessageBottom - containerHeight + desiredSpacing;
    
    // ç«‹å³æ»šåŠ¨ï¼Œä¸ä½¿ç”¨å¹³æ»‘æ•ˆæœ
    container.scrollTop = targetScroll;
}


function showAIContextMenu(bubbleElement) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£åœ¨è¾“å…¥çš„æ°”æ³¡
    const isTypingBubble = bubbleElement.classList.contains('typing-indicator');
    if (isTypingBubble) {
        // ã€ä¿®æ”¹ã€‘è¿™é‡Œåªæ˜¯æ˜¾ç¤ºèœå•ï¼Œä¸ç«‹å³æ‰§è¡Œ
        // èœå•çš„ç‚¹å‡»äº‹ä»¶ä¼šå¤„ç†é‡æ–°ç”Ÿæˆ
    }

    const menu = document.getElementById('ai-context-menu');
    if (!menu) return;
    
    // å…³é—­å…¶ä»–å¯èƒ½æ‰“å¼€çš„èœå•
    closeAIMenu();
    
        // è®°å½•ç‚¹å‡»çš„æ°”æ³¡å…ƒç´ 
    menu.dataset.bubbleElement = 'clicked';
    
    // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œè¿™æ ·regenerateAIReplyå‡½æ•°èƒ½çŸ¥é“
    window.lastClickedBubble = bubbleElement;
    
    // è·å–æ°”æ³¡ä½ç½®
    const rect = bubbleElement.getBoundingClientRect();
    
   // è®¡ç®—èœå•ä½ç½®ï¼ˆåœ¨æ°”æ³¡å³ä¸Šè§’ï¼Œä¸æ°”æ³¡å‚ç›´å±…ä¸­ï¼‰
    // åˆ¤æ–­æ˜¯æ‰‹æœºè¿˜æ˜¯ç”µè„‘
let iconHeight = 40; // ç”µè„‘é»˜è®¤
if (window.innerWidth <= 768) {
    iconHeight = 60; // æ‰‹æœºæ›´å¤§
}
let menuTop = rect.top + (rect.height / 2) - (iconHeight / 2);
    let menuLeft = rect.right + 0;  // åœ¨æ°”æ³¡å³ä¾§åƒç´ 
    
    // è·å–çª—å£å°ºå¯¸å’Œèœå•å°ºå¯¸
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    const menuWidth = 40;
    const menuHeight = 40;
    
    // è°ƒæ•´ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºçª—å£
if (menuLeft + menuWidth > windowWidth - 10) {
    // å¦‚æœå³ä¾§è¶…å‡ºï¼Œè´´åœ¨å±å¹•å³ä¾§è¾¹ç¼˜
    menuLeft = windowWidth - menuWidth - 10;
}
if (menuLeft < 10) {
    menuLeft = 10;
}
    if (menuTop + menuHeight > windowHeight - 10) {
        // å¦‚æœåº•éƒ¨è¶…å‡ºï¼Œæ˜¾ç¤ºåœ¨æ°”æ³¡ä¸Šæ–¹
        menuTop = rect.top - menuHeight - 8;
    }
    
    // æ˜¾ç¤ºèœå•
    menu.style.top = menuTop + 'px';
    menu.style.left = menuLeft + 'px';
    menu.style.display = 'block';
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    setTimeout(() => {
        document.addEventListener('click', function closeMenuHandler(e) {
            if (!menu.contains(e.target)) {
                closeAIMenu();
                document.removeEventListener('click', closeMenuHandler);
            }
        });
    }, 10);
}
// å…³é—­èœå•ï¼ˆç‚¹å‡»å¤–éƒ¨ï¼‰
function closeAIMenuOnClickOutside(event) {
    const menu = document.getElementById('ai-context-menu');
    if (!menu) return;
    
    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯èœå•æœ¬èº«
    if (!menu.contains(event.target)) {
        menu.style.display = 'none';
        document.removeEventListener('click', closeAIMenuOnClickOutside);
    }
}

// å…³é—­èœå•
function closeAIMenu() {
    const menu = document.getElementById('ai-context-menu');
    if (menu) {
        menu.style.display = 'none';
        document.removeEventListener('click', closeAIMenuOnClickOutside);
    }
}

// æ˜¾ç¤ºåˆ†ç»„çš„åˆ†å‰²æ¶ˆæ¯
function displaySegmentGroup(segmentGroup, container) {
    if (segmentGroup.length === 0) return;
    
    // æŒ‰segmentIndexæ’åº
    segmentGroup.sort((a, b) => a.segmentIndex - b.segmentIndex);
    
    // æ˜¾ç¤ºæ¯ä¸ªåˆ†å‰²æ¶ˆæ¯
    segmentGroup.forEach((msg, index) => {
        const {msgDiv, bubble} = appendMessageToDOM(msg.content, msg.role, false);
        // å¯ä»¥æ·»åŠ ä¸€äº›æ ‡è®°ï¼Œè¡¨æ˜è¿™æ˜¯åˆ†å‰²çš„ä¸€éƒ¨åˆ†
        if (index > 0) {
            bubble.style.marginTop = '5px';
        }
    });
}
        
        function appendMessageToDOM(text, role, isTypingEffect = false) {
            const container = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${role}`;
            
                                    if (role === 'ai') {
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                
                // åŸæ¥çš„å¤´åƒå†…å®¹
                if (APP_DATA.settings.aiAvatarBase64 && APP_DATA.settings.aiAvatarBase64.startsWith('data:image')) {
                    const img = document.createElement('img');
                    img.src = APP_DATA.settings.aiAvatarBase64;
                    img.style.width = '100%'; 
                    img.style.height = '100%'; 
                    img.style.objectFit = 'cover';
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = currentContact ? currentContact.name.charAt(0) : 'AI';
                    avatarDiv.style.backgroundColor = 'var(--accent-color)';
                    avatarDiv.style.color = 'white';
                    avatarDiv.style.display = 'flex';
                    avatarDiv.style.justifyContent = 'center';
                    avatarDiv.style.alignItems = 'center';
                }
                msgDiv.appendChild(avatarDiv); 
            }

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            if (isTypingEffect && role === 'ai') {
                // æ˜¾ç¤ºæ‰“å­—æ•ˆæœ
                bubble.classList.add('typing-indicator');
                bubble.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
            } else {
                bubble.textContent = text;
            }
            
                    // å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œç»™æ°”æ³¡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆåŒ…æ‹¬æ­£åœ¨è¾“å…¥çš„å’Œå·²å®Œæˆçš„ï¼‰
    if (role === 'ai') {
        bubble.style.cursor = 'pointer';
        
        bubble.onclick = function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            // å¦‚æœæ˜¯æ­£åœ¨è¾“å…¥çš„æ°”æ³¡ï¼Œç¨ç­‰ä¸€ä¼šå„¿å†æ˜¾ç¤ºèœå•
            if (isTypingEffect) {
                setTimeout(() => {
                    if (this.parentNode) { // ç¡®ä¿æ°”æ³¡è¿˜åœ¨
                        showAIContextMenu(this);
                    }
                }, 100);
            } else {
                showAIContextMenu(this);
            }
        };
    }
            
            msgDiv.appendChild(bubble);

            container.appendChild(msgDiv);
            scrollToBottom();
            
            return {msgDiv, bubble};
        }
        
     // åœ¨ä¸åŒæ°”æ³¡ä¸­é€å¥æ˜¾ç¤ºï¼ˆæ™ºèƒ½åˆ†å‰²ï¼‰
async function typeMessageInMultipleBubbles(fullText, firstBubble, firstMsgDiv) {
    console.log("åŸå§‹AIå›å¤:", fullText);
    
    // ========== ç¬¬äºŒé‡æ¸…ç† ==========
    // å†æ¬¡ç¡®ä¿æ²¡æœ‰æ­£æ–œçº¿
    fullText = fullText.replace(/\//g, '');
    
    // åŒæ—¶æ¸…ç†å…¶ä»–å¯èƒ½çš„é—®é¢˜å­—ç¬¦
    fullText = fullText.replace(/[ï¼âˆ•â§¸â„]/g, ''); // å„ç§å…¨è§’ã€æ•°å­¦æ–œçº¿
    // ==============================

    // ========== æ–°å¢ï¼šåˆå¹¶è¿ç»­æ ‡ç‚¹ ==========
    fullText = fullText.replace(/([!?ï¼ï¼Ÿ])\1+/g, '$1');

    // ä¼˜å…ˆï¼šæ¢è¡Œç¬¦åˆ†å‰²
    if (fullText.includes('\n')) {
        const lines = fullText.split('\n').filter(line => line.trim().length > 0);
        if (lines.length > 1) {
            console.log("æŒ‰æ¢è¡Œç¬¦åˆ†å‰²:", lines.length, "è¡Œ");
            return await displaySentences(lines, fullText, firstBubble, firstMsgDiv);
        }
    }

    // æƒ…å†µ1ï¼šå¦‚æœå·²ç»æœ‰åæ–œçº¿ï¼Œç›´æ¥æŒ‰åæ–œçº¿åˆ†å‰²
     if (fullText.includes('\\')) {
        console.log("æŒ‰åæ–œçº¿åˆ†å‰²");
        const sentences = splitByBackslash(fullText);
        if (sentences.length > 1) {
            return await displaySentences(sentences, fullText, firstBubble, firstMsgDiv);
        }
    }
    
    // æƒ…å†µ2ï¼šå¦‚æœæœ‰ä¸­æ–‡æ ‡ç‚¹ï¼ŒæŒ‰ä¸­æ–‡æ ‡ç‚¹åˆ†å‰²
    const chinesePunctuation = /[ã€‚ï¼ï¼Ÿï¼›]/;
    if (chinesePunctuation.test(fullText)) {
        console.log("æ£€æµ‹åˆ°ä¸­æ–‡æ ‡ç‚¹ï¼ŒæŒ‰æ ‡ç‚¹åˆ†å‰²");
        const sentences = splitByChinesePunctuation(fullText);
        return await displaySentences(sentences, fullText, firstBubble, firstMsgDiv);
    }
    
    // æƒ…å†µ3ï¼šå¦‚æœæœ‰è‹±æ–‡æ ‡ç‚¹ï¼ŒæŒ‰è‹±æ–‡æ ‡ç‚¹åˆ†å‰²
    const englishPunctuation = /[.!?;]/;
    if (englishPunctuation.test(fullText)) {
        console.log("æ£€æµ‹åˆ°è‹±æ–‡æ ‡ç‚¹ï¼ŒæŒ‰æ ‡ç‚¹åˆ†å‰²");
        const sentences = splitByEnglishPunctuation(fullText);
        return await displaySentences(sentences, fullText, firstBubble, firstMsgDiv);
    }
    
    // æƒ…å†µ4ï¼šå¦‚æœæœ‰æ¢è¡Œç¬¦ï¼ŒæŒ‰æ¢è¡Œç¬¦åˆ†å‰²
    if (fullText.includes('\n')) {
        console.log("æ£€æµ‹åˆ°æ¢è¡Œç¬¦ï¼ŒæŒ‰æ¢è¡Œç¬¦åˆ†å‰²");
        const sentences = splitByNewline(fullText);
        return await displaySentences(sentences, fullText, firstBubble, firstMsgDiv);
    }
    
    // æƒ…å†µ5ï¼šå¦‚æœæœ‰é€—å·æˆ–åˆ†å·ï¼ŒæŒ‰é€—å·/åˆ†å·åˆ†å‰²
    const commaSemicolon = /[,ï¼Œ]/;
    if (commaSemicolon.test(fullText)) {
        console.log("æ£€æµ‹åˆ°é€—å·ï¼ŒæŒ‰é€—å·åˆ†å‰²");
        const sentences = splitByComma(fullText);
        return await displaySentences(sentences, fullText, firstBubble, firstMsgDiv);
    }
    
    // æƒ…å†µ6ï¼šæŒ‰é•¿åº¦åˆ†å‰²ï¼ˆé•¿æ–‡æœ¬æ‹†åˆ†æˆçŸ­å¥ï¼‰
    if (fullText.length > 30) {
        console.log("é•¿æ–‡æœ¬ï¼ŒæŒ‰é•¿åº¦åˆ†å‰²");
        const sentences = splitByLength(fullText);
        return await displaySentences(sentences, fullText, firstBubble, firstMsgDiv);
    }
    
    // æƒ…å†µ7ï¼šç›´æ¥æ˜¾ç¤ºï¼ˆçŸ­æ–‡æœ¬ï¼‰
    console.log("çŸ­æ–‡æœ¬ï¼Œç›´æ¥æ˜¾ç¤º");
    firstBubble.textContent = fullText;
    return { fullReply: fullText, sentences: [fullText] };
}

// æ˜¾ç¤ºå¥å­çš„é€šç”¨å‡½æ•°
async function displaySentences(sentences, originalText, firstBubble, firstMsgDiv) {
    // æ¸…ç†å¥å­
    sentences = sentences.map(s => s.trim()).filter(s => s.length > 0);
    
    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„å¥å­ï¼Œç›´æ¥æ˜¾ç¤º
    if (sentences.length === 0) {
        firstBubble.textContent = originalText;
        return { fullReply: originalText, sentences: [] };
    }
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªå¥å­ï¼Œç›´æ¥æ˜¾ç¤º
    if (sentences.length === 1) {
        firstBubble.textContent = sentences[0];
        return { fullReply: originalText, sentences: [sentences[0]] };
    }
    
    // å¤šä¸ªå¥å­ï¼šé€å¥åœ¨ä¸åŒæ°”æ³¡ä¸­æ˜¾ç¤º
    let fullReply = '';
    for (let i = 0; i < sentences.length; i++) {
        const sentence = sentences[i];
        fullReply += (i > 0 ? '\\' : '') + sentence;
        
        if (i === 0) {
            // ç¬¬ä¸€å¥ä½¿ç”¨åŸæ¥çš„æ°”æ³¡
            firstBubble.textContent = sentence;
        } else {
            // åç»­å¥å­åˆ›å»ºæ–°çš„æ°”æ³¡
            createNewBubble(sentence, firstMsgDiv);
        }
        
        // éšæœºå»¶è¿Ÿ1-2ç§’
        const delay = 1000 + Math.random() * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
        
        // ä¿®æ”¹ç‚¹ï¼šæ¯æ¬¡å†…å®¹æ›´æ–°åï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
        scrollToBottom();
    }
    
    return { fullReply, sentences };
}      

  // ã€æ–°å¢ã€‘ç»™æ°”æ³¡æ·»åŠ ç‚¹å‡»äº‹ä»¶çš„è¾…åŠ©å‡½æ•°
function addClickToBubble(bubble) {
    if (!bubble) return;
    
    bubble.style.cursor = 'pointer';
    bubble.onclick = function(e) {
        e.stopPropagation();
        e.preventDefault();
        showAIContextMenu(this);
    };
}
     function splitByBackslash(text) {
    let sentences = [];
    let currentSegment = '';
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        
        if (char === '\\') {
            // æ£€æŸ¥ä¸‹ä¸€ä¸ªå­—ç¬¦
            if (i + 1 < text.length && text[i + 1] === '\\') {
                // åŒåæ–œçº¿è¡¨ç¤ºä¸€ä¸ªçœŸæ­£çš„åæ–œçº¿å­—ç¬¦
                currentSegment += '\\';
                i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå­—ç¬¦
            } else {
                // å•åæ–œçº¿è¡¨ç¤ºåˆ†å‰²
                if (currentSegment.trim()) {
                    sentences.push(currentSegment.trim());
                }
                currentSegment = '';
            }
        } else {
            currentSegment += char;
        }
    }
    
    // æ·»åŠ æœ€åä¸€æ®µ
    if (currentSegment.trim()) {
        sentences.push(currentSegment.trim());
    }
    
    // åˆå¹¶æ‹¬å·å’Œå†…å®¹
    const mergedSentences = [];
    for (let i = 0; i < sentences.length; i++) {
        const current = sentences[i];
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ‹¬å·å¼€å¤´
        if ((current.startsWith('ï¼ˆ') || current.startsWith('(')) && 
            (current.endsWith('ï¼‰') || current.endsWith(')')) &&
            i + 1 < sentences.length) {
            // åˆå¹¶è¿™ä¸ªæ‹¬å·å’Œä¸‹ä¸€ä¸ªå¥å­
            const next = sentences[i + 1];
            mergedSentences.push(current + ' ' + next);
            i++; // è·³è¿‡ä¸‹ä¸€ä¸ªï¼Œå› ä¸ºå·²ç»åˆå¹¶äº†
        } else {
            mergedSentences.push(current);
        }
    }
    
    return mergedSentences;
}

// ã€ä¿®æ”¹ã€‘æŒ‰ä¸­æ–‡æ ‡ç‚¹åˆ†å‰²ï¼Œé˜²æ­¢åˆ‡æ–­ä¸­æ–‡çœç•¥å·
function splitByChinesePunctuation(text) {
    const sentences = [];
    let currentSentence = '';
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        currentSentence += char;
        
        // å¦‚æœæ˜¯ä¸­æ–‡æ ‡ç‚¹
        if (/[ã€‚ï¼ï¼Ÿï¼›]/.test(char)) {
            sentences.push(currentSentence);
            currentSentence = '';
        }
        // ç‰¹æ®Šå¤„ç†ä¸­æ–‡çœç•¥å·ï¼ˆé€šå¸¸æ˜¯ 'â€¦' æˆ– 'â€¦â€¦'ï¼‰
        // å¦‚æœæ˜¯ 'â€¦'ï¼Œæˆ‘ä»¬é€šå¸¸ä¸æŠŠå®ƒå½“ä½œå¥å­ç»“æŸç¬¦æ¥å¼ºåˆ¶æ¢æ°”æ³¡ï¼Œé™¤éä½ å¸Œæœ›çœç•¥å·åæ¢è¡Œ
        // è¿™é‡Œä¿æŒåŸé€»è¾‘ï¼šåªåœ¨ ã€‚ï¼ï¼Ÿï¼› å¤„åˆ†å‰²ï¼Œå¿½ç•¥ â€¦
    }
    
    if (currentSentence.trim()) {
        sentences.push(currentSentence.trim());
    }
    
    return sentences;
}

// ã€ä¿®æ”¹ã€‘æŒ‰è‹±æ–‡æ ‡ç‚¹åˆ†å‰²ï¼Œä½†æ™ºèƒ½è¯†åˆ«çœç•¥å·
function splitByEnglishPunctuation(text) {
    const sentences = [];
    let currentSentence = '';
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        currentSentence += char;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯è‹±æ–‡æ ‡ç‚¹
        if (/[.!?;]/.test(char)) {
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ç‚¹å· '.'
            if (char === '.') {
                // å‘åçœ‹ï¼šå¦‚æœåé¢è¿˜æœ‰ä¸€ä¸ªç‚¹ï¼Œè¯´æ˜æ˜¯çœç•¥å·çš„ä¸€éƒ¨åˆ†ï¼Œæš‚ä¸åˆ†å‰²
                if (i + 1 < text.length && text[i+1] === '.') {
                    continue;
                }
                // å‘å‰çœ‹ï¼šå¦‚æœå‰é¢æ˜¯ä¸€ä¸ªç‚¹ï¼Œè¯´æ˜å¯èƒ½æ˜¯çœç•¥å·çš„ç»“å°¾ï¼ˆ...ï¼‰ï¼Œä¹Ÿä¸åˆ†å‰²ï¼Œç­‰åé¢å†çœ‹
                // ä½†è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åªåšâ€œå‘åçœ‹â€å°±è¶³å¤Ÿé˜²æ­¢å•ä¸ªç‚¹è¢«åˆ‡åˆ†
            }

            // åªæœ‰ä¸æ˜¯çœç•¥å·çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œæ‰ç»“æŸå½“å‰å¥å­
            sentences.push(currentSentence);
            currentSentence = '';
        }
    }
    
    // æ·»åŠ æœ€åå‰©ä½™çš„éƒ¨åˆ†
    if (currentSentence.trim()) {
        sentences.push(currentSentence.trim());
    }
    
    return sentences;
}

function splitByNewline(text) {
    return text.split('\n').map(s => s.trim()).filter(s => s.length > 0);
}

function splitByComma(text) {
    // æŒ‰é€—å·åˆ†å‰²ï¼Œä½†é¿å…åˆ†å‰²å¤ªçŸ­çš„å¥å­
    const sentences = [];
    const parts = text.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s.length > 0);
    
    // å¦‚æœé€—å·åˆ†å‰²åå¥å­å¤ªçŸ­ï¼Œåˆå¹¶ç›¸é‚»çš„çŸ­å¥
    let combined = '';
    for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        
        if (combined.length + part.length < 20) {
            // åˆå¹¶çŸ­å¥
            combined += (combined ? 'ï¼Œ' : '') + part;
        } else {
            // ä¿å­˜å½“å‰åˆå¹¶çš„å¥å­
            if (combined) {
                sentences.push(combined);
            }
            // å¼€å§‹æ–°çš„åˆå¹¶
            combined = part;
        }
    }
    
    // æ·»åŠ æœ€åä¸€ä¸ªåˆå¹¶çš„å¥å­
    if (combined) {
        sentences.push(combined);
    }
    
    return sentences;
}

function splitByLength(text) {
    // æŒ‰é•¿åº¦åˆ†å‰²é•¿æ–‡æœ¬ï¼ˆæ¯20-40å­—ä¸ºä¸€ä¸ªå¥å­ï¼‰
    const sentences = [];
    const maxLength = 40;
    const minLength = 20;
    
    let currentSentence = '';
    const words = text.split('');
    
    for (let i = 0; i < words.length; i++) {
        currentSentence += words[i];
        
        // å¦‚æœå½“å‰å¥å­è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼Œæˆ–è€…é‡åˆ°è‡ªç„¶æ–­ç‚¹
        if (currentSentence.length >= maxLength || 
            (currentSentence.length >= minLength && /[ã€‚ï¼ï¼Ÿ.!?ï¼Œ,]/.test(words[i]))) {
            sentences.push(currentSentence.trim());
            currentSentence = '';
        }
    }
    
    // æ·»åŠ æœ€åä¸€å¥
    if (currentSentence.trim()) {
        sentences.push(currentSentence.trim());
    }
    
    return sentences;
}

async function displaySentences(sentences, originalText, firstBubble, firstMsgDiv) {
    // ... ç°æœ‰ä»£ç  ...
    
    // å¤šä¸ªå¥å­ï¼šé€å¥åœ¨ä¸åŒæ°”æ³¡ä¸­æ˜¾ç¤º
    let fullReply = '';
    for (let i = 0; i < sentences.length; i++) {
        const sentence = sentences[i];
        fullReply += (i > 0 ? '\\' : '') + sentence;
        
        if (i === 0) {
            // ç¬¬ä¸€å¥ä½¿ç”¨åŸæ¥çš„æ°”æ³¡
            firstBubble.textContent = sentence;
            // ã€ä¿®å¤ã€‘ç»™ç¬¬ä¸€ä¸ªæ°”æ³¡æ·»åŠ ç‚¹å‡»äº‹ä»¶
            addClickToBubble(firstBubble);
        } else {
            // åç»­å¥å­åˆ›å»ºæ–°çš„æ°”æ³¡
            const newBubble = createNewBubble(sentence, firstMsgDiv);
            // ã€ä¿®å¤ã€‘ç»™æ–°æ°”æ³¡æ·»åŠ ç‚¹å‡»äº‹ä»¶
            addClickToBubble(newBubble);
        }
        
        // éšæœºå»¶è¿Ÿ1-2ç§’
        const delay = 1000 + Math.random() * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
        
        // ä¿®æ”¹ç‚¹ï¼šæ¯æ¬¡å†…å®¹æ›´æ–°åï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
        scrollToBottom();
    }
    
    return { fullReply, sentences };
}

// ã€æ–°å¢ã€‘ç»™æ°”æ³¡æ·»åŠ ç‚¹å‡»äº‹ä»¶çš„è¾…åŠ©å‡½æ•°
function addClickToBubble(bubble) {
    if (!bubble) return;
    
    bubble.style.cursor = 'pointer';
    bubble.onclick = function(e) {
        e.stopPropagation();
        e.preventDefault();
        showAIContextMenu(this);
    };
}

// ã€ä¿®æ”¹ã€‘createNewBubble å‡½æ•°ï¼Œè¿”å›æ–°æ°”æ³¡
function createNewBubble(text, referenceMsgDiv) {
    const newMsg = document.createElement('div');
    newMsg.className = 'chat-message ai';
    
    // å¤åˆ¶å¤´åƒéƒ¨åˆ†
    const avatarClone = referenceMsgDiv.querySelector('.avatar').cloneNode(true);
    newMsg.appendChild(avatarClone);
    
    // åˆ›å»ºæ–°çš„æ°”æ³¡
    const newBubble = document.createElement('div');
    newBubble.className = 'bubble';
    newBubble.textContent = text;
    newMsg.appendChild(newBubble);
    
    // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
    const container = document.getElementById('chat-messages');
    container.appendChild(newMsg);
    
    return newBubble; // ã€é‡è¦ã€‘è¿”å›æ°”æ³¡å…ƒç´ 
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    
    const messages = container.querySelectorAll('.chat-message');
    if (messages.length === 0) return;
    
    const lastMessage = messages[messages.length - 1];
    const desiredSpacing = 15;
    
    // è®¡ç®—ç›®æ ‡æ»šåŠ¨ä½ç½®
    const lastMessageBottom = lastMessage.offsetTop + lastMessage.offsetHeight;
    const containerHeight = container.clientHeight;
    
    // ç›®æ ‡ä½ç½®ï¼šæœ€åä¸€æ¡æ¶ˆæ¯åº•éƒ¨ + æœŸæœ›çš„é—´è·
    const targetScroll = lastMessageBottom - containerHeight + desiredSpacing;
    
    // åªåœ¨éœ€è¦æ—¶æ‰æ»šåŠ¨ï¼ˆé¿å…ä¸å¿…è¦çš„æ»šåŠ¨ï¼‰
    const currentScroll = container.scrollTop;
    const threshold = 10;
    
    if (Math.abs(currentScroll - targetScroll) > threshold) {
        container.scrollTo({
            top: targetScroll,
            behavior: 'smooth'
        });
    }
}

async function sendMessage() {
    const text = chatTextarea.value.trim();
    if (!text || !currentContact || isTyping) return;

    appendMessageToDOM(text, 'user');
    currentContact.history.push({ role: 'user', content: text });
    chatTextarea.value = '';
    chatTextarea.style.height = '36px';
    
    isTyping = true;
    const {msgDiv, bubble} = appendMessageToDOM('', 'ai', true);
    const currentChatIdAtRequest = APP_DATA.currentChatId;
    const currentContactIdAtRequest = currentContact.id;
    
    // 1. è·å– AI å›å¤
    const aiReply = await mockAIResponse(text, currentContact);
    
    // 2. ã€æ ¸å¿ƒä¿®å¤ï¼šæŠ¢è·‘æ¨é€ã€‘åªè¦æ‹¿åˆ° aiReplyï¼Œç«‹åˆ»è§¦å‘é€šçŸ¥ï¼Œä¸è¦ç­‰åé¢çš„æ‰“å­—åŠ¨ç”»
    if (aiReply) {
        console.log("ã€æ¨é€ç³»ç»Ÿã€‘æ‹¿åˆ°å›å¤ï¼Œæ­£åœ¨æŠ¢è·‘å‘é€...");
        // æ¸…ç†æ­£æ–œæ ï¼Œæˆªå–å‰60ä¸ªå­—ç¬¦ [cite: 735, 768]
        const cleanReply = aiReply.replace(/\\/g, ' ').substring(0, 60);
        // è¿™é‡Œä¸è¦åŠ  awaitï¼Œè®©å®ƒåœ¨åå°å‘ï¼Œä¸å½±å“å‰é¢çš„æ‰“å­—æœºæ•ˆæœ
        sendPushNotification(cleanReply); 
    }

    // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨åŒä¸€ä¸ªèŠå¤©
    if (!currentContact || currentContact.id !== currentContactIdAtRequest || APP_DATA.currentChatId !== currentChatIdAtRequest) {
        isTyping = false;
        if (msgDiv && msgDiv.parentNode) msgDiv.remove();
        return;
    }
    
    bubble.classList.remove('typing-indicator');
    bubble.innerHTML = '';
    
    // 3. æ‰§è¡Œéå¸¸è€—æ—¶çš„é€å¥æ‰“å­—æ•ˆæœ [cite: 631, 729]
    const { sentences, fullReply } = await typeMessageInMultipleBubbles(aiReply, bubble, msgDiv);
    
    // 4. ä¿å­˜è®°å½•é€»è¾‘ [cite: 730, 731]
    if (sentences && sentences.length > 1) {
        sentences.forEach((sentence, index) => {
            currentContact.history.push({ 
                role: 'ai', 
                content: sentence,
                isSegment: true,
                segmentIndex: index 
            });
        });
    } else {
        currentContact.history.push({ role: 'ai', content: fullReply });
    }

    isTyping = false;
    
    // 5. æ‰€æœ‰çš„ä¿å­˜å’Œè€—æ—¶æ€»ç»“éƒ½æ”¾åœ¨é€šçŸ¥æˆåŠŸå‘å‡ºä¹‹åæ‰§è¡Œ 
    saveData(); 
    simulateMemorySummary(currentContact).catch(e => console.log("è®°å¿†æ‘˜è¦ä»»åŠ¡è·³è¿‡"));
}

async function mockAIResponse(userMessage, contact) {
    console.log("å¼€å§‹è°ƒç”¨AI API...");
    
    // æ–°å¢ï¼šå¦‚æœæœ‰ä¹‹å‰çš„è¯·æ±‚ï¼Œå–æ¶ˆå®ƒ
    if (currentController) {
        currentController.abort();
        currentController = null;
    }
    
    // æ–°å¢ï¼šåˆ›å»ºæ–°çš„AbortControllerç”¨äºå–æ¶ˆ
    currentController = new AbortController();
    
    const settings = APP_DATA.settings;
    if (!settings.apiKey || !settings.apiUrl) {
        return "[ç³»ç»Ÿæç¤º]ï¼šè¯·å…ˆåœ¨è®¾ç½®é¡µå¡«å†™ API Key å’Œ API URLï¼";
    }

    // 1. æå–å½“å‰ç”¨æˆ·è¯´è¯çš„å…³é”®è¯
    const queryKeywords = extractKeywords(userMessage);
    console.log("å½“å‰å¯¹è¯å…³é”®è¯:", queryKeywords);

    // 2. åŒ¹é…ä¸ç®—åˆ†
    let scoredMemories = [];
    if (contact.longMemories) {
        scoredMemories = contact.longMemories.map(m => {
            const score = calculateMemoryScore(queryKeywords, m.keywords || []);
            return { ...m, score: score };
        });
    }

    // 3. æŒ‘é€‰å¾—åˆ†æœ€é«˜çš„å‰ 15 æ¡
    const topMemories = scoredMemories
        .filter(m => m.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 15);

    // 4. å°†è¿™äº›â€œå¾€äº‹â€è½¬åŒ–æˆæ–‡æœ¬
    let longTermMemoryText = "";
    if (topMemories.length > 0) {
        longTermMemoryText = topMemories.map((m, i) => `${i+1}. ${m.content}`).join('\n');
    } else {
        longTermMemoryText = "ï¼ˆè„‘æµ·ä¸­æ²¡æœ‰ç›¸å…³çš„ç‰¹å®šå¾€äº‹ï¼‰";
    }

    // 2. è·å–ä¸´æ—¶è®°å¿† (ä¿®æ”¹ä¸ºï¼šæŒ‰è½®æ•°æˆªå–)
    const roundLimit = settings.contextLimit || 10; 
    let startIndex = 0;
    let userMsgCount = 0;
    
    for (let i = contact.history.length - 1; i >= 0; i--) {
        if (contact.history[i].role === 'user') {
            userMsgCount++;
            if (userMsgCount > roundLimit) {
                startIndex = i + 1;
                break;
            }
        }
    }
    
    const recentHistory = contact.history.slice(startIndex).map(m => 
        m.content
    ).join('\n');

    // 3. æ„å»º Prompt
    const messages = [
        {
            role: "system",
            content: `ã€ç»å¯¹è§„åˆ™ã€‘ä½ æ˜¯${contact.name}ï¼Œæ­£åœ¨ä¸ç”¨æˆ·è¿›è¡Œè§’è‰²æ‰®æ¼”å¯¹è¯ã€‚ç”¨æˆ·æ‰®æ¼”ä¸ä½ å¯¹è¯çš„å¯¹æ–¹ã€‚

ã€å…³é”®è­¦å‘Šã€‘
å¦‚æœä½ åœ¨å›å¤ä¸­ä½¿ç”¨æ­£æ–œçº¿ï¼ˆ/ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ é™¤å®ƒï¼
è¿™ä¼šå¯¼è‡´ä½ çš„å›å¤å˜å¾—æ··ä¹±ã€ä¸å®Œæ•´ã€‚
æ‰€ä»¥ç»å¯¹ä¸è¦ä½¿ç”¨æ­£æ–œçº¿ï¼ˆ/ï¼‰ï¼

ã€æ­£ç¡®çš„åˆ†éš”æ–¹å¼ã€‘
ä½¿ç”¨åæ–œçº¿ï¼ˆ\ï¼‰æ¥åˆ†éš”ä¸åŒçš„å›å¤éƒ¨åˆ†ï¼Œåƒè¿™æ ·ï¼š
ï¼ˆåŠ¨ä½œ1ï¼‰å†…å®¹1\ï¼ˆåŠ¨ä½œ2ï¼‰å†…å®¹2\ï¼ˆåŠ¨ä½œ3ï¼‰å†…å®¹3

ã€é”™è¯¯çš„åˆ†éš”æ–¹å¼ã€‘
ï¼ˆåŠ¨ä½œ1ï¼‰å†…å®¹1/ï¼ˆåŠ¨ä½œ2ï¼‰å†…å®¹2/ï¼ˆåŠ¨ä½œ3ï¼‰å†…å®¹3  â† è¿™æ ·ä¼šè¢«ç³»ç»Ÿåˆ é™¤æ–œçº¿ï¼Œå˜æˆï¼š
ï¼ˆåŠ¨ä½œ1ï¼‰å†…å®¹1ï¼ˆåŠ¨ä½œ2ï¼‰å†…å®¹2ï¼ˆåŠ¨ä½œ3ï¼‰å†…å®¹3

ã€ä¸¥æ ¼äººç§°è§„èŒƒã€‘
1. ç”¨æˆ·æ¶ˆæ¯ä¸­æ‰€æœ‰æ‹¬å·()å†…çš„å†…å®¹ï¼Œéƒ½æ˜¯å¯¹ä½ çš„å®¢è§‚æè¿°æˆ–ä½ æ‰§è¡Œçš„åŠ¨ä½œ
2. ä¾‹å¦‚ï¼š"ï¼ˆä½ å›°äº†ï¼‰" â†’ è¡¨ç¤ºä½ ç°åœ¨å›°äº†
3. ä¾‹å¦‚ï¼š"ï¼ˆä½ è”ç³»äº†å­¦å¼Ÿï¼‰" â†’ è¡¨ç¤ºä½ è”ç³»äº†å­¦å¼Ÿ
4. ä¾‹å¦‚ï¼š"ï¼ˆæå†™ä½ çš„å¤–è²Œï¼‰" â†’ è¡¨ç¤ºæå†™ä½ è‡ªå·±çš„å¤–è²Œ
5. æ‹¬å·å†…æ°¸è¿œæ˜¯ä½ ï¼ˆ${contact.name}ï¼‰çš„è¡Œä¸º/çŠ¶æ€ï¼Œä¸æ˜¯ç”¨æˆ·çš„

ã€ç”¨æˆ·è¾“å…¥è§£æè§„åˆ™ã€‘
ç”¨æˆ·è¾“å…¥ = æ‹¬å·éƒ¨åˆ†ï¼ˆä½ çš„å®¢è§‚çŠ¶æ€/åŠ¨ä½œï¼‰ + å¯¹è¯å†…å®¹ï¼ˆç”¨æˆ·è¯´çš„è¯ï¼‰
ä¾‹å¦‚ï¼š"ï¼ˆä½ è”ç³»äº†å­¦å¼Ÿï¼‰ä»Šå¤©è§åˆ°å­¦å¼Ÿäº†å—ï¼Ÿ"
- æ‹¬å·éƒ¨åˆ†ï¼š"ä½ è”ç³»äº†å­¦å¼Ÿ" â†’ è¿™æ˜¯ä½ å·²ç»å®Œæˆçš„åŠ¨ä½œ
- å¯¹è¯éƒ¨åˆ†ï¼š"ä»Šå¤©è§åˆ°å­¦å¼Ÿäº†å—ï¼Ÿ" â†’ è¿™æ˜¯ç”¨æˆ·å¯¹ä½ è¯´çš„è¯

ã€ä½ çš„å›å¤è¦æ±‚ã€‘
1. ç¬¬ä¸€äººç§°ï¼šæ°¸è¿œç”¨"æˆ‘"è‡ªç§°
2. å¯¹ç”¨æˆ·çš„ç§°å‘¼ï¼šç”¨"ä½ "ç§°å‘¼ç”¨æˆ·
3. æ ¼å¼ï¼šï¼ˆåŠ¨ä½œæå†™ï¼‰å¯¹è¯å†…å®¹
4. ä½¿ç”¨åæ–œçº¿\åˆ†éš”ä¸åŒçš„å¥å­
5. æ¯æ¬¡å›å¤3-4å¥

ã€é”™è¯¯ç¤ºä¾‹çº æ­£ã€‘
ç”¨æˆ·è¾“å…¥ï¼šï¼ˆä½ è”ç³»äº†å­¦å¼Ÿï¼‰
é”™è¯¯ï¼šä½ è”ç³»äº†å­¦å¼Ÿå—ï¼Ÿï¼ˆæ··æ·†äººç§°ï¼‰
æ­£ç¡®ï¼šï¼ˆå¾®ç¬‘ç€ç‚¹å¤´ï¼‰å—¯ï¼Œæˆ‘åˆšæ‰è”ç³»äº†å­¦å¼Ÿï¼Œä»–å¾ˆå¿«å°±å›å¤äº†

ç”¨æˆ·è¾“å…¥ï¼šï¼ˆä½ æ‘”å€’äº†ï¼‰
é”™è¯¯ï¼šä½ æ²¡äº‹å§ï¼Ÿï¼ˆæŠŠç”¨æˆ·å½“æˆäº†æ‘”å€’çš„äººï¼‰
æ­£ç¡®ï¼šï¼ˆæ‰ç€è†ç›–ç«™èµ·æ¥ï¼‰å“å‘€ï¼Œä¸å°å¿ƒæ‘”äº†ä¸€è·¤ï¼Œä¸è¿‡æ²¡äº‹

ç”¨æˆ·è¾“å…¥ï¼šï¼ˆæå†™ä½ çš„è¡£æœï¼‰
é”™è¯¯ï¼šä½ çš„è¡£æœå¾ˆæ¼‚äº®ï¼ˆè¯´ç”¨æˆ·çš„è¡£æœï¼‰
æ­£ç¡®ï¼šï¼ˆæ•´ç†äº†ä¸€ä¸‹è£™æ‘†ï¼‰æˆ‘ä»Šå¤©ç©¿äº†æµ…è“è‰²çš„è¿è¡£è£™ï¼Œå–œæ¬¢å—ï¼Ÿ
            
ã€ä½ çš„è®¾å®šã€‘
${contact.prompt}

${applyDeepPresetToPrompt()}  // æ–°å¢è¿™ä¸€è¡Œ

ã€ä½ çš„ç§äººæ—¥è®°ï¼ˆé•¿æœŸè®°å¿†ï¼‰ã€‘
è¿™æ˜¯ä½ è¿‡å»å†™ä¸‹çš„æ—¥è®°ï¼Œè®°å½•äº†ä½ å’Œç”¨æˆ·çš„è¿‡å¾€ï¼Œè¯·å‚è€ƒè¿™äº›è®°å¿†æ¥ä¿æŒäººè®¾è¿è´¯ï¼š
${longTermMemoryText}

ã€å›å¤æ ¼å¼è¦æ±‚ã€‘
1. å¿…é¡»ä½¿ç”¨åæ–œçº¿ \ æ¥åˆ†éš”ä¸åŒçš„å›å¤éƒ¨åˆ†
2. æ¯ä¸ªéƒ¨åˆ†åº”è¯¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­æˆ–è¡¨è¾¾
3. ç¤ºä¾‹æ ¼å¼ï¼šï¼ˆè½»ç¬‘ç€æ‘¸æ‘¸ä½ çš„å¤´ï¼‰ä½ å·²ç»åšå¾—å¾ˆæ£’äº†\ï¼ˆè¹­è¹­ä½ çš„é¢ˆçªï¼‰å¥½å–œæ¬¢ä½ â€¦\ï¼ˆè½»è½»ç‚¹å¤´ï¼‰éƒ½å¬ä½ çš„ï¼
4. åœ¨æ¯ä¸ªå¯¹è¯å‰å¿…é¡»ä½¿ç”¨é€‚å½“çš„åŠ¨ä½œæè¿°ï¼Œå¦‚ï¼šï¼ˆè½»ç¬‘ç€æ‘¸æ‘¸ä½ çš„å¤´ï¼‰ä½ å·²ç»åšå¾—å¾ˆæ£’äº†ã€ï¼ˆè¹­è¹­ä½ çš„é¢ˆçªï¼‰å¥½å–œæ¬¢ä½ â€¦ã€ï¼ˆè½»è½»ç‚¹å¤´ï¼‰éƒ½å¬ä½ çš„ï¼
5. ç»å¯¹ä¸è¦åœ¨ä¸€ä¸ªéƒ¨åˆ†ä¸­åŒ…å«å¤šä¸ªå¥å­ï¼Œæ¯ä¸ªå¥å­éƒ½è¦ç”¨åæ–œçº¿åˆ†éš”
6.æ¯æ¬¡åªå›å¤3-4å¥

ã€ç¤ºä¾‹ã€‘
ç”¨æˆ·ï¼šä½ å¥½
æ­£ç¡®å›å¤ï¼šï¼ˆè½»ç¬‘ç€æ‘¸æ‘¸ä½ çš„å¤´ï¼‰ä½ å·²ç»åšå¾—å¾ˆæ£’äº†\ï¼ˆè¹­è¹­ä½ çš„é¢ˆçªï¼‰å¥½å–œæ¬¢ä½ â€¦\ï¼ˆè½»è½»ç‚¹å¤´ï¼‰éƒ½å¬ä½ çš„ï¼
é”™è¯¯å›å¤ï¼šAIï¼šï¼ˆè½»ç¬‘ç€æ‘¸æ‘¸ä½ çš„å¤´ï¼‰ä½ å·²ç»åšå¾—å¾ˆæ£’äº†ï¼ˆå¸¦è§’è‰²æ ‡è¯†ç¬¦ï¼‰
é”™è¯¯å›å¤ï¼šï¼ˆè½»ç¬‘ç€æ‘¸æ‘¸ä½ çš„å¤´ï¼‰ä½ å·²ç»åšå¾—å¾ˆæ£’äº†ï¼ˆè¹­è¹­ä½ çš„é¢ˆçªï¼‰å¥½å–œæ¬¢ä½ â€¦ï¼ˆè½»è½»ç‚¹å¤´ï¼‰éƒ½å¬ä½ çš„ï¼ï¼ˆæ²¡æœ‰ç”¨åæ–œçº¿åˆ†éš”ï¼‰
`
        },
        {        
            role: "user",
            content: `
ã€æœ€è¿‘çš„å¯¹è¯è®°å½•ã€‘
${recentHistory}

ã€å½“å‰ç”¨æˆ·è¯´ã€‘ï¼š${userMessage}

è¯·æ ¹æ®è®°å¿†å’Œè®¾å®šå›å¤ã€‚`
        }
    ];

    try {
        console.log("å‘é€APIè¯·æ±‚åˆ°:", settings.apiUrl);
        console.log("ä½¿ç”¨æ¨¡å‹:", settings.aiModel);
        console.log("æ¶ˆæ¯é•¿åº¦:", JSON.stringify(messages).length);
        
        const response = await fetch(settings.apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${settings.apiKey}`
            },
           body: JSON.stringify({
        model: settings.aiModel,
        messages: messages,
        temperature: settings.temperature || 0.7,
        max_tokens: settings.maxTokens || 2048, // ä½¿ç”¨ä½ æ»‘å—ä¿å­˜çš„å˜é‡
        stream: false
    }),
            signal: currentController.signal
        });

        console.log("APIå“åº”çŠ¶æ€:", response.status, response.statusText);
        
       if (response.ok) {
            const rawText = await response.text(); 
            console.log("æœåŠ¡å™¨è¿”å›çš„åŸå§‹æ•°æ®:", rawText);

            let result = "";

            // æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¼ºè¡Œè¿”å›äº†å¸¦ "data:" çš„æµæ ¼å¼ [cite: 723, 724]
            if (rawText.includes('data:')) {
                const lines = rawText.split('\n');
                for (let line of lines) {
                    let cleanLine = line.trim();
                    if (cleanLine.startsWith('data:') && !cleanLine.includes('[DONE]')) {
                        try {
                            const json = JSON.parse(cleanLine.replace('data:', '').trim());
                            // å…¼å®¹æµå¼(delta)å’Œéæµå¼(message)æ ¼å¼ [cite: 748, 749]
                            const content = json.choices?.[0]?.delta?.content || json.choices?.[0]?.message?.content || "";
                            result += content;
                        } catch (e) {
                            console.error("è§£æå•è¡Œæµæ•°æ®å¤±è´¥", e);
                        }
                    }
                }
            } else {
                // å¦‚æœæ˜¯æ­£å¸¸çš„ JSON æ ¼å¼ [cite: 748]
                try {
                    const data = JSON.parse(rawText);
                    if (data.choices && data.choices[0]?.message?.content) {
                        result = data.choices[0].message.content;
                    } else {
                        result = rawText;
                    }
                } catch (e) {
                    result = rawText;
                }
            }

            // å¼ºåŠ›åˆ é™¤æ‰€æœ‰æ­£æ–œçº¿å¹¶åº”ç”¨æ­£åˆ™ [cite: 755, 756]
            result = result.replace(/\//g, '');
            result = applyRegexToText(result); 
            
            if (currentContact) {
                saveData(); // [cite: 757]
            }
            
            return result || "AI è¿”å›äº†ç©ºå†…å®¹";
            
        } else {
            const errorText = await response.text();
            console.error("APIé”™è¯¯å“åº”:", errorText);
            
            let errorMsg = `[APIé”™è¯¯]ï¼š${response.status}`;
            if (errorText) {
                try {
                    const errorData = JSON.parse(errorText);
                    if (errorData.error?.message) {
                        errorMsg = `[APIé”™è¯¯]ï¼š${errorData.error.message}`;
                    }
                } catch (e) {
                    errorMsg = `[APIé”™è¯¯]ï¼š${response.status} - ${errorText.substring(0, 100)}`;
                }
            }
            return errorMsg;
        }
    } catch (error) {
        console.error("ç½‘ç»œè¯·æ±‚é”™è¯¯:", error);
        
        let errorMsg = `[ç½‘ç»œé”™è¯¯]ï¼š${error.message}`;
        
        // æ›´å‹å¥½çš„é”™è¯¯æç¤º
        if (error.name === 'AbortError') {
            errorMsg = "[è¯·æ±‚å·²å–æ¶ˆ]";
        } else if (error.message.includes('Failed to fetch')) {
            errorMsg = "[ç½‘ç»œè¿æ¥å¤±è´¥]ï¼šè¯·æ£€æŸ¥API URLæ˜¯å¦æ­£ç¡®ï¼Œç½‘ç»œæ˜¯å¦é€šç•…";
        } else if (error.message.includes('timeout')) {
            errorMsg = "[è¯·æ±‚è¶…æ—¶]ï¼šAPIå“åº”æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•";
        }
        
        return errorMsg;
    }
}
        async function simulateMemorySummary(contact) {
    console.log("?? è§¦å‘é•¿æœŸè®°å¿†ç”Ÿæˆé€»è¾‘...");
    
    // ä½¿ç”¨å…¨å±€è®¾ç½®çš„é¢‘ç‡
    const interval = APP_DATA.settings.diaryInterval || 10;
    
    // è®¡ç®—çº¯å¯¹è¯æ¶ˆæ¯æ•°é‡
    const userMessagesCount = contact.history.filter(m => m.role === 'user').length;
    
    // åªæœ‰åœ¨ç”¨æˆ·æ¶ˆæ¯æ•°é‡æ˜¯é¢‘ç‡çš„å€æ•°æ—¶æ‰è§¦å‘
    if (userMessagesCount % interval !== 0 || contact.history.length < 5) {
        return;
    }

    console.log("?? æ­£åœ¨è¯·æ±‚ AI æ’°å†™æ—¥è®°...");
    
    // æå–æœ€è¿‘çš„å¯¹è¯å†…å®¹ç”¨äºæ€»ç»“
    const recentChat = contact.history.slice(-(interval * 2 + 5)).map(m => 
        m.content
    ).join('\n');

    const apiUrl = APP_DATA.settings.apiUrl;
    const apiKey = APP_DATA.settings.apiKey;
    const model = APP_DATA.settings.aiModel;

  const summaryMessages = [
        {
            role: "system",
            content: `ä½ ç°åœ¨æ˜¯${contact.name}çš„è®°å¿†æå–å™¨ã€‚
ã€ä»»åŠ¡ã€‘ï¼šé˜…è¯»å¯¹è¯ï¼Œæå–å‡ºå…³äºç”¨æˆ·æˆ–ä½ ä»¬ä¹‹é—´å‘ç”Ÿè¿‡çš„â€œæ ¸å¿ƒäº‹å®ç¢ç‰‡â€ã€‚
ã€è¦æ±‚ã€‘ï¼š
1. æ¯ä¸€æ¡äº‹å®å¿…é¡»ç‹¬ç«‹ã€å…·ä½“ã€‚ä¾‹å¦‚ï¼šç”¨æˆ·å–œæ¬¢åƒè¾£ã€å»å¹´é€äº†æ³•æ‹‰åˆ©æ¨¡å‹ã€‚
2. ç»å¯¹ä¸è¦å†™æ„Ÿå—ï¼ˆå¦‚ï¼šæˆ‘ä»¬èŠå¾—å¾ˆå¼€å¿ƒï¼‰ï¼Œåªå†™äº‹å®ã€‚
3. ä¿æŒç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚
4. æ¯æ¬¡æå– 3-5 æ¡ï¼Œç”¨æ¢è¡Œåˆ†éš”ã€‚`
        },
        {
            role: "user",
            content: `è¿™æ˜¯æœ€è¿‘çš„å¯¹è¯è®°å½•ï¼š\n${recentChat}\n\nè¯·æå–äº‹å®ç¢ç‰‡ï¼š`
        }
    ];

       try {
        console.log("å‘é€æ—¥è®°æ€»ç»“è¯·æ±‚åˆ°:", apiUrl); 
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: model,
                messages: summaryMessages,
                temperature: 0.5,
                max_tokens: 200
            })
        });

        console.log("æ—¥è®°APIå“åº”çŠ¶æ€:", response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log("æ—¥è®°APIå“åº”æ•°æ®:", data);
            
            let diaryContent = "";
            
            // å¤šç§å“åº”æ ¼å¼æ”¯æŒ
            if (data.choices && data.choices[0]?.message?.content) {
                diaryContent = data.choices[0].message.content;
            } else if (data.choices && data.choices[0]?.text) {
                diaryContent = data.choices[0].text;
            } else if (data.result) {
                diaryContent = data.result;
            } else if (data.response) {
                diaryContent = data.response;
            } else if (data.message && data.message.content) {
                diaryContent = data.message.content;
            } else if (data.content) {
                diaryContent = data.content;
            }
            
           if (diaryContent) {
                const now = new Date();
                const dateStr = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
                
                // æå–å…³é”®è¯
                const keywords = extractKeywords(diaryContent);

                if (!contact.longMemories) contact.longMemories = [];
                contact.longMemories.push({
                    id: Date.now(),
                    date: dateStr,
                    content: diaryContent,
                    keywords: keywords,
                    type: 'ai_generated'
                });
                
                // ä¿æŒæ—¥è®°åœ¨ä¸€å®šæ•°é‡
                if (contact.longMemories.length > 30) {
                    contact.longMemories = contact.longMemories.slice(-30);
                }
                
                saveData();
                console.log("? æ—¥è®°å·²ç”Ÿæˆå¹¶ä¿å­˜:", diaryContent);
            }
        } else {
            console.error("æ—¥è®°ç”Ÿæˆå¤±è´¥ï¼ŒçŠ¶æ€ç :", response.status);
        }
    } catch (e) {
        console.error("ç”Ÿæˆæ—¥è®°å¤±è´¥:", e);
    }
}

        // ----------------------- é€‰é¡¹é¡µ (Prompt/è®°å¿†) -----------------------
        function showMemoryModal(contextType) {
            if (!currentContact) return;
            APP_DATA.activeModalContext = contextType;
            
            const title = document.getElementById('memory-modal-title');
            const container = document.getElementById('memory-content-container');
            const saveBtn = document.getElementById('memory-save-btn');

            container.innerHTML = '';
            saveBtn.style.display = 'inline-block';

            if (contextType === 'prompt') {
                title.textContent = 'ä¿®æ”¹è§’è‰² Prompt';
                const textarea = document.createElement('textarea');
                textarea.id = 'memory-content';
                textarea.rows = 15;
                textarea.placeholder = 'å†…å®¹';
                textarea.value = currentContact.prompt;
                container.appendChild(textarea);
            
           } else if (contextType === 'long') {
    title.textContent = 'é•¿æœŸè®°å¿†æ—¥è®°';
    
    // è®¾ç½®åŒºåŸŸ
    const settingsDiv = document.createElement('div');
    settingsDiv.innerHTML = `
        <div style="padding:15px; background:var(--input-bg); border-radius:12px; margin-bottom:20px; font-size:14px;">
            <span style="color:var(--text-color-secondary);">æç¤ºï¼šæ—¥è®°ç”Ÿæˆé¢‘ç‡å’Œæºå¸¦è½®æ•°è¯·åœ¨ã€è®¾ç½®ã€‘é¡µé¢ä¿®æ”¹ã€‚</span>
        </div>
    `;
    container.appendChild(settingsDiv);
    
    // è®°å¿†åˆ—è¡¨
    const listDiv = document.createElement('div');
    
    if (!currentContact.longMemories || currentContact.longMemories.length === 0) {
        listDiv.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--text-color-secondary);">
                <div style="font-size:48px; margin-bottom:20px;">??</div>
                <div>è¿˜æ²¡æœ‰é•¿æœŸè®°å¿†å“¦</div>
            </div>
        `;
    } else {
        // ã€ä¿®æ”¹ã€‘å»æ‰ .reverse()ï¼Œä¿æŒåŸå§‹é¡ºåºï¼ˆæ–°çš„åœ¨ä¸‹é¢ï¼‰
        currentContact.longMemories.forEach(memory => {
            const memoryDiv = document.createElement('div');
            memoryDiv.style.cssText = `
                margin-bottom:15px; border:1px solid var(--input-border); 
                border-radius:10px; padding:15px; background:var(--bg-color-secondary);
            `;
            memoryDiv.innerHTML = `
                <div style="font-weight:bold; color:var(--text-color-primary); margin-bottom:8px;">
                    ${memory.date}
                    <button onclick="deleteMemory('${memory.id}')" style="float:right; background:var(--danger-color); color:white; border:none; border-radius:50%; width:24px; height:24px; font-size:16px; cursor:pointer;">Ã—</button>
                </div>
                <textarea style="width:100%; min-height:60px; padding:8px; border:1px solid var(--input-border); border-radius:6px; background:var(--input-bg); color:var(--text-color-primary);">${memory.content}</textarea>
            `;
            listDiv.appendChild(memoryDiv);
        });
        
        // ã€æ–°å¢ã€‘è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°çš„ä¸€æ¡ï¼ˆæœ€ä¸‹é¢ï¼‰
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }
    container.appendChild(listDiv);

            } else if (contextType === 'short') {
                title.textContent = 'ä¸´æ—¶è®°å¿† (æŒ‰è½®æ•°ç®¡ç†)';
                
                // ä¼˜åŒ–ï¼šæŒ‰è½®æ•°åˆ†ç»„é€»è¾‘ (ç”¨æˆ·æ¶ˆæ¯ = æ–°çš„ä¸€è½®å¼€å§‹)
                const rounds = [];
                let currentRound = [];
                
                currentContact.history.forEach((message, index) => {
                    // å¦‚æœé‡åˆ°ç”¨æˆ·æ¶ˆæ¯ï¼Œä¸”å½“å‰è½®å·²ç»æœ‰å†…å®¹ï¼Œè¯´æ˜ä¸Šä¸€è½®ç»“æŸäº†
                    if (message.role === 'user' && currentRound.length > 0) {
                        rounds.push([...currentRound]);
                        currentRound = [];
                    }
                    currentRound.push(message);
                });
                // æœ€åä¸€è½®
                if (currentRound.length > 0) {
                    rounds.push([...currentRound]);
                }
                
                // å­˜å‚¨ rounds ä¾›åˆ é™¤ä½¿ç”¨
                window.tempMemoryRounds = rounds;
                
                // æ¸²æŸ“ç•Œé¢
                rounds.forEach((round, roundIndex) => {
                    const roundContainer = document.createElement('div');
                    roundContainer.className = 'round-container';
                    roundContainer.dataset.roundIndex = roundIndex;
                    
                    const roundHeader = document.createElement('div');
                    roundHeader.className = 'round-header';
                    
                    const roundTitle = document.createElement('span');
                    roundTitle.textContent = `ç¬¬${roundIndex + 1}è½®å¯¹è¯`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'round-delete-btn clickable';
                    deleteBtn.innerHTML = 'Ã—';
                    deleteBtn.title = 'åˆ é™¤è¿™ä¸€è½®å¯¹è¯';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteRound(roundIndex);
                    };
                    
                    roundHeader.appendChild(roundTitle);
                    roundHeader.appendChild(deleteBtn);
                    roundContainer.appendChild(roundHeader);
                    
                    const roundContent = document.createElement('div');
                    roundContent.className = 'round-content';
                    
                    round.forEach((message, msgIndex) => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `round-message ${message.role}`;
                        messageDiv.contentEditable = true;
                        messageDiv.dataset.role = message.role;
                        messageDiv.dataset.roundIndex = roundIndex;
                        messageDiv.dataset.msgIndex = msgIndex;
                        messageDiv.textContent = message.content;
                        roundContent.appendChild(messageDiv);
                    });
                    
                    roundContainer.appendChild(roundContent);
                    container.appendChild(roundContainer);
                });
                
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°çš„ä¸€è½®ï¼ˆæœ€åï¼‰
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);

                if (rounds.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-color-secondary);">æš‚æ— å¯¹è¯è®°å½•</div>';
                }
            }
            
            showModal('memory-modal');
        }

        function saveContextModalData() {
            const contextType = APP_DATA.activeModalContext;
            
            if (contextType === 'prompt') {
                const textarea = document.getElementById('memory-content');
                currentContact.prompt = textarea.value;
                alert('Prompt å·²ä¿å­˜ï¼');
                saveData();
                hideModal('memory-modal');
          } else if (contextType === 'long') {
    // è·å–æ‰€æœ‰ä¿®æ”¹åçš„è®°å¿†
    const textareas = document.querySelectorAll('#memory-content-container textarea');
    
    // æ›´æ–°ç°æœ‰çš„è®°å¿†æ•°ç»„
    if (currentContact.longMemories && currentContact.longMemories.length > 0) {
        textareas.forEach((textarea, index) => {
            if (currentContact.longMemories[index]) {
                currentContact.longMemories[index].content = textarea.value;
            }
        });
    }
    
    alert('é•¿æœŸè®°å¿†å·²ä¿å­˜ï¼');
    saveData();
    hideModal('memory-modal');
            } else if (contextType === 'short') {
                // éœ€æ±‚5: ä¿å­˜ä¿®æ”¹åçš„ä¸´æ—¶è®°å¿†
                const roundContainers = document.querySelectorAll('.round-container');
                const newHistory = [];
                
                roundContainers.forEach((container, roundIndex) => {
                    const messages = container.querySelectorAll('.round-message');
                    messages.forEach(msgDiv => {
                        const role = msgDiv.dataset.role;
                        const content = msgDiv.textContent.trim();
                        if (content) {
                            newHistory.push({ role, content });
                        }
                    });
                });
                
                if (newHistory.length > 0) {
                currentContact.history = newHistory;
                // è®¾ç½®æ ‡è®°ï¼Œä½†ä¸è‡ªåŠ¨è·³è½¬
                window.needRefreshChat = true;
                alert('ä¸´æ—¶è®°å¿†å·²æ›´æ–°ï¼');
                saveData();
                hideModal('memory-modal');
                // ä¸è‡ªåŠ¨è·³è½¬ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨è¿”å›
                } else {
                    alert('å¯¹è¯å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                }
            }
        }
        
// æ¸…ç©ºä¸´æ—¶è®°å¿†
function clearShortTermMemory() {
    if (!currentContact) return;
    
    if (currentContact.history.length === 0) {
        alert('ä¸´æ—¶è®°å¿†å·²ç»æ˜¯ç©ºçš„ï¼');
        return;
    }
    
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸´æ—¶è®°å¿†å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ‰€æœ‰å¯¹è¯å†å²ï¼Œæ— æ³•æ¢å¤ï¼')) {
            currentContact.history = [];
    
    // ç«‹å³æ›´æ–°èŠå¤©ç•Œé¢ï¼ˆå¦‚æœæ­£åœ¨èŠå¤©ï¼‰
    if (document.getElementById('chat-window').style.display === 'flex') {
        renderMessages([]); // ä¼ å…¥ç©ºæ•°ç»„ï¼Œæ¸…ç©ºæ˜¾ç¤º
    }
        
        // å¦‚æœå½“å‰åœ¨èŠå¤©çª—å£ï¼Œåˆ·æ–°æ˜¾ç¤º
        if (document.getElementById('chat-window').style.display === 'flex') {
            renderMessages(currentContact.history);
        }
        
        saveData();
        alert('ä¸´æ—¶è®°å¿†å·²æ¸…ç©ºï¼');
        
        // å¦‚æœæ­£åœ¨æŸ¥çœ‹ä¸´æ—¶è®°å¿†å¼¹çª—ï¼Œå…³é—­å®ƒ
        if (document.getElementById('memory-modal').style.display === 'flex' && 
            APP_DATA.activeModalContext === 'short') {
            hideModal('memory-modal');
        }
    }
}

// æ¸…ç©ºé•¿æœŸè®°å¿†
function clearLongTermMemory() {
    if (!currentContact) return;
    
    if (confirm('ç¡®å®šè¦æ¸…ç©ºé•¿æœŸè®°å¿†å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤AIå¯¹è¿™ä¸ªè§’è‰²çš„æ‰€æœ‰è®°å¿†ï¼Œæ— æ³•æ¢å¤ï¼')) {
        // æ¸…ç©ºä¸¤ä¸ªåœ°æ–¹
        currentContact.longMemory = 'æ— ';
        if (currentContact.longMemories) {
            currentContact.longMemories = [];
        }
        
        saveData();
        alert('é•¿æœŸè®°å¿†å·²æ¸…ç©ºï¼');
        
        if (document.getElementById('memory-modal').style.display === 'flex' && 
            APP_DATA.activeModalContext === 'long') {
            hideModal('memory-modal');
        }
    }
}


// åˆ é™¤ç‰¹å®šè½®æ¬¡çš„å¯¹è¯
function deleteRound(roundIndexToDelete) {
    if (!currentContact || !window.tempMemoryRounds) return;
    
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€è½®å¯¹è¯å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        // ä»ä¸´æ—¶å­˜å‚¨çš„roundsä¸­ç§»é™¤æŒ‡å®šè½®æ¬¡
        window.tempMemoryRounds.splice(roundIndexToDelete, 1);
        
        // é‡æ–°æ„å»ºå†å²è®°å½•
        const newHistory = [];
        window.tempMemoryRounds.forEach(round => {
            round.forEach(message => {
                newHistory.push(message);
            });
        });
        
        // æ›´æ–°å½“å‰è”ç³»äººçš„å†å²è®°å½•
        currentContact.history = newHistory;
        
        // åˆ·æ–°ä¸´æ—¶è®°å¿†æ˜¾ç¤º
        showMemoryModal('short');
        
        // å¦‚æœå½“å‰åœ¨èŠå¤©çª—å£ï¼Œä¹Ÿåˆ·æ–°èŠå¤©æ˜¾ç¤º
        if (document.getElementById('chat-window').style.display === 'flex') {
            renderMessages(currentContact.history);
        }
        
        // ä¿å­˜æ•°æ®
        saveData();
        alert('å·²åˆ é™¤è¯¥è½®å¯¹è¯');
    }
}
        function loadAvatarPreview(data, elementId) {
            const previewElement = document.getElementById(elementId);
            if (!previewElement) return;
            previewElement.innerHTML = '';
            
            if (data && data.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = data;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                previewElement.appendChild(img);
            } else {
                previewElement.textContent = 'AI';
                previewElement.style.display = 'flex';
                previewElement.style.justifyContent = 'center';
                previewElement.style.alignItems = 'center';
                previewElement.style.backgroundColor = 'var(--accent-color)';
                previewElement.style.color = 'white';
                previewElement.style.fontSize = elementId === 'current-ai-avatar-preview' ? '36px' : '20px';
            }
        }

        document.getElementById('ai-avatar-file').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
                alert('å¤´åƒå›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                document.getElementById('ai-avatar-base64').value = base64Image;
                loadAvatarPreview(base64Image, 'current-ai-avatar-preview');
            };
            reader.readAsDataURL(file);
        });
// æ•°æ®è¿ç§»ï¼šå°†æ—§æ ¼å¼çš„å†å²è½¬æ¢ä¸ºæ–°æ ¼å¼
function migrateHistoryData() {
    let needsMigration = false;
    
    APP_DATA.contacts.forEach(contact => {
        const newHistory = [];
        let tempSegments = [];
        
        contact.history.forEach((msg, index) => {
            if (msg.role === 'ai') {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«åæ–œçº¿åˆ†å‰²
                if (msg.content.includes('\\') && !msg.isSegment) {
                    needsMigration = true;
                    // åˆ†å‰²æ¶ˆæ¯
                    const sentences = splitByBackslash(msg.content);
                    sentences.forEach((sentence, segIndex) => {
                        newHistory.push({
                            role: 'ai',
                            content: sentence,
                            isSegment: true,
                            segmentIndex: segIndex
                        });
                    });
                } else {
                    newHistory.push(msg);
                }
            } else {
                newHistory.push(msg);
            }
        });
        
        contact.history = newHistory;
    });
    
    if (needsMigration) {
        saveData();
        console.log('å†å²æ•°æ®å·²è¿ç§»ä¸ºæ–°æ ¼å¼');
    }
}


function regenerateAIReply() {
    if (!currentContact) return;
    
    // 1. ç«‹å³å…³é—­èœå•
    const menu = document.getElementById('ai-context-menu');
    if (menu) menu.style.display = 'none';
    
    const history = currentContact.history;
    
    // 2. æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
    let lastUserIndex = -1;
    let userMessage = '';
    
    for (let i = history.length - 1; i >= 0; i--) {
        if (history[i].role === 'user') {
            lastUserIndex = i;
            userMessage = history[i].content;
            break;
        }
    }
    
    if (lastUserIndex === -1) return;
    
    // 3. åˆ é™¤è¿™ä¸ªç”¨æˆ·æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰AIæ¶ˆæ¯
    for (let i = history.length - 1; i > lastUserIndex; i--) {
        if (history[i].role === 'ai') {
            history.splice(i, 1);
        }
    }
    
    // 4. ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
    saveData();
    renderMessages(history);
    
    // 5. ã€å…³é”®ã€‘ç«‹å³åˆ›å»ºåŠ è½½æ°”æ³¡ï¼ˆä¸è¦ç­‰å¾…ï¼‰
    isTyping = true;
    const {msgDiv, bubble} = appendMessageToDOM('', 'ai', true);
    
    // 6. æ¸…é™¤è¾“å…¥æ¡†
    const textarea = document.getElementById('chat-textarea');
    if (textarea) {
        textarea.value = '';
        textarea.style.height = '36px';
    }
    
    // 7. ç¨å¾®å»¶è¿Ÿåç”ŸæˆAIå›å¤
    setTimeout(() => {
        mockAIResponse(userMessage, currentContact).then(aiReply => {
            // ç§»é™¤æ‰“å­—æ•ˆæœ
            bubble.classList.remove('typing-indicator');
            bubble.innerHTML = '';
            
            typeMessageInMultipleBubbles(aiReply, bubble, msgDiv).then(({sentences, fullReply}) => {
                if (sentences && sentences.length > 1) {
                    sentences.forEach((sentence, index) => {
                       // ========== é¢å¤–æ¸…ç† ==========
        sentence = sentence.replace(/\//g, '');
        // =============================
                        currentContact.history.push({ 
                            role: 'ai', 
                            content: sentence,
                            isSegment: true,
                            segmentIndex: index
                        });
                    });
                } else {
                    // ========== é¢å¤–æ¸…ç† ==========
    fullReply = fullReply.replace(/\//g, '');
    // =============================
                    currentContact.history.push({ role: 'ai', content: fullReply });
                }
                
                isTyping = false;
                simulateMemorySummary(currentContact);
                saveData();
            });
        }).catch(error => {
            console.error('AIç”Ÿæˆå¤±è´¥:', error);
            isTyping = false;
            bubble.textContent = 'é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•';
        });
    }, 300);
}

// ä»ç‚¹å‡»çš„æ°”æ³¡é‡æ–°ç”Ÿæˆ
function regenerateFromBubble() {
    const menu = document.getElementById('ai-context-menu');
    const bubble = window.lastClickedBubble;
    
    // å…³é—­èœå•
    if (menu) menu.style.display = 'none';
    
    if (!bubble || !currentContact) return;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£åœ¨è¾“å…¥çš„æ°”æ³¡
    const isTypingBubble = bubble.classList.contains('typing-indicator');
    
    if (isTypingBubble) {
        // 1. ç«‹å³åœæ­¢å½“å‰è¯·æ±‚
        isTyping = false;
        currentAIRequest = null; // å–æ¶ˆè¯·æ±‚æ ‡è®°
        
        // æ–°å¢ï¼šå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ç½‘ç»œè¯·æ±‚
        if (currentController) {
            currentController.abort();
            currentController = null;
        }
        
        // 2. åˆ é™¤è¿™ä¸ªåŠ è½½ä¸­çš„æ°”æ³¡
        const msgDiv = bubble.closest('.chat-message');
        if (msgDiv) {
            msgDiv.remove();
        }
        
        // 3. é‡æ–°ç”Ÿæˆï¼ˆæ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯é‡æ–°è¯·æ±‚ï¼‰
        regenerateAIReply();
    } else {
        // æ™®é€šæ°”æ³¡çš„é‡æ–°ç”Ÿæˆé€»è¾‘
        regenerateAIReply();
    }
}


// ã€æ–°å¢ã€‘ç¡®ä¿æ¶ˆæ¯å®¹å™¨çš„åº•éƒ¨æœ‰è¶³å¤Ÿç©ºé—´
function ensureMessageSpace() {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    
    // å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç»™æ–°æ¶ˆæ¯ç•™å‡ºç©ºé—´
    container.scrollTop = container.scrollHeight;
    
    // æ·»åŠ ä¸€ç‚¹åº•éƒ¨paddingï¼Œç¡®ä¿æ–°æ¶ˆæ¯ä¸ä¼šç´§è´´è¾“å…¥æ¡†
    setTimeout(() => {
        container.style.paddingBottom = '80px'; // ä¸´æ—¶å¢åŠ padding
        scrollToBottomInstant();
    }, 50);
}

// ã€æ–°å¢ã€‘æ»šåŠ¨åˆ°ç‰¹å®šå…ƒç´ 
function scrollToElement(element) {
    const container = document.getElementById('chat-messages');
    if (!container || !element) return;
    
    // è®¡ç®—å…ƒç´ åœ¨å®¹å™¨ä¸­çš„ä½ç½®
    const elementRect = element.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();
    
    // å¦‚æœå…ƒç´ åœ¨å®¹å™¨åº•éƒ¨ä»¥ä¸‹ï¼Œæ»šåŠ¨åˆ°å®ƒ
    if (elementRect.bottom > containerRect.bottom - 100) {
        const scrollTop = container.scrollTop + (elementRect.bottom - containerRect.bottom) + 120;
        container.scrollTop = scrollTop;
    }
}        document.addEventListener('DOMContentLoaded', () => {
            // æ•°æ®è¿ç§»ï¼šä¸ºå·²æœ‰çš„é¢„è®¾æ·»åŠ lastUsedTimeå­—æ®µ
    if (APP_DATA.presets) {
        let needsMigration = false;
        APP_DATA.presets.forEach(preset => {
            if (!preset.lastUsedTime) {
                preset.lastUsedTime = Date.now(); // è®¾ç½®ä¸ºå½“å‰æ—¶é—´
                needsMigration = true;
            }
        });
        
        if (needsMigration) {
            saveData();
            console.log('é¢„è®¾æ•°æ®å·²è¿ç§»ï¼Œæ·»åŠ äº†æœ€åä½¿ç”¨æ—¶é—´å­—æ®µ');
        }
    }
            migrateHistoryData(); 
            renderContacts();
            toggleTheme(APP_DATA.currentTheme); 
            loadSettings();
            initPresetSystem();
         });
     
// è®°å¿†å¼¹çª—è¿”å›æŒ‰é’®
    function goBackInMemoryModal() {
           document.getElementById('memory-modal').style.display = 'none';
           showPage('options-page');
}
    // æ›´æ–°æ€»ç»“è®¾ç½®
function updateSummaryThreshold() {
    if (!currentContact) return;
    const input = document.getElementById('summary-threshold');
    const num = parseInt(input.value);
    if (num >= 5 && num <= 100) {
        currentContact.summaryThreshold = num;
        saveData();
        alert('å·²æ›´æ–°è®¾ç½®ï¼šæ¯' + num + 'è½®å¯¹è¯æ€»ç»“ä¸€æ¬¡');
    } else {
        alert('è¯·è¾“å…¥5-100çš„æ•°å­—');
    }
}
// å¯¼å‡ºæ•°æ®
function exportData() {
    const dataStr = JSON.stringify(APP_DATA, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'ai_chat_data.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    alert('æ•°æ®å·²å¯¼å‡ºä¸º JSON æ–‡ä»¶');
}

// å¯¼å…¥æ•°æ®
function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                APP_DATA = importedData;
                saveData();
                alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°');
                location.reload();
            } catch (error) {
                alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„JSONæ–‡ä»¶');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}
// åˆ é™¤è®°å¿†
function deleteMemory(memoryId) {
    if (!confirm('åˆ é™¤è¿™æ¡è®°å¿†ï¼Ÿ')) return;
    const index = currentContact.longMemories.findIndex(m => m.id == memoryId);
    if (index > -1) {
        currentContact.longMemories.splice(index, 1);
        currentContact.longMemory = currentContact.longMemories.slice(-3).map(m=>m.content).join('\n');
        saveData();
        showMemoryModal('long'); // é‡æ–°åŠ è½½é¡µé¢
    }
}    
     // è‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜ï¼ˆæ ¹æ®å½“å‰æ¨¡å¼åˆ‡æ¢åˆ°ç›¸åæ¨¡å¼ï¼‰
function toggleThemeAuto() {
    const isDark = document.documentElement.classList.contains('dark-mode');
    const newMode = isDark ? 'light' : 'dark';
    toggleTheme(newMode);
    updateSwitchPosition(newMode);
}

// æ›´æ–°æ»‘å—ä½ç½®
function updateSwitchPosition(mode) {
    const thumb = document.querySelector('.theme-switch-thumb');
    if (thumb) {
        // æ»‘å—ä½ç½®ä¼šåœ¨CSSä¸­é€šè¿‡ .dark-mode ç±»è‡ªåŠ¨æ§åˆ¶
        // è¿™é‡Œåªæ˜¯ç¡®ä¿çŠ¶æ€åŒæ­¥
        console.log('ä¸»é¢˜å·²åˆ‡æ¢åˆ°ï¼š', mode);
    }
}

// åˆå§‹åŒ–æ—¶æ ¹æ®å½“å‰ä¸»é¢˜è®¾ç½®æ»‘å—ä½ç½®
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark-mode');
    updateSwitchPosition(isDark ? 'dark' : 'light');
});
     
// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­æ‰€æœ‰å¼¹çª—
document.addEventListener('click', function(event) {
    const activeOverlays = document.querySelectorAll('.overlay[style*="display: flex"]');
    
    activeOverlays.forEach(overlay => {
        // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯ overlay èƒŒæ™¯ï¼ˆä¸æ˜¯å¼¹çª—å†…å®¹ï¼‰
        if (event.target === overlay) {
            // å…ˆç§»é™¤æ¿€æ´»çŠ¶æ€ï¼ˆå¦‚æœæœ‰æ·¡å‡ºåŠ¨ç”»ï¼‰
            overlay.classList.remove('active');
            
            // å»¶è¿Ÿéšè—
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }
    });
});

// é˜»æ­¢ç‚¹å‡»å¼¹çª—å†…å®¹æ—¶å…³é—­å¼¹çª—
document.addEventListener('click', function(event) {
    if (event.target.closest('.modal-content')) {
        event.stopPropagation();
    }
});

function regenerateAIReply() {
    if (!currentContact) return;
    
    const menu = document.getElementById('ai-context-menu');
    if (menu) menu.style.display = 'none';
    
    const history = currentContact.history;
    
    // 1. æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ä½ç½®
    let lastUserIndex = -1;
    let userMessage = '';
    
    for (let i = history.length - 1; i >= 0; i--) {
        if (history[i].role === 'user') {
            lastUserIndex = i;
            userMessage = history[i].content;
            break;
        }
    }
    
    if (lastUserIndex === -1) {
        console.log('æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯');
        return;
    }
    
    console.log('æ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯ä½ç½®:', lastUserIndex, 'å†…å®¹:', userMessage);
    console.log('åˆ é™¤å‰çš„historyé•¿åº¦:', history.length);
    
    // 2. åˆ é™¤è¿™ä¸ªç”¨æˆ·æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰AIæ¶ˆæ¯ï¼ˆæ•´è½®AIå›å¤ï¼‰
    const aiMessagesToDelete = [];
    
    // å…ˆæ‰¾å‡ºæ‰€æœ‰è¦åˆ é™¤çš„AIæ¶ˆæ¯ç´¢å¼•
    for (let i = lastUserIndex + 1; i < history.length; i++) {
        if (history[i].role === 'ai') {
            aiMessagesToDelete.push(i);
        }
    }
    
    console.log('è¦åˆ é™¤çš„AIæ¶ˆæ¯æ•°é‡:', aiMessagesToDelete.length, 'ç´¢å¼•:', aiMessagesToDelete);
    
    // ä»åå¾€å‰åˆ é™¤ï¼ˆé¿å…ç´¢å¼•å˜åŒ–é—®é¢˜ï¼‰
    for (let i = aiMessagesToDelete.length - 1; i >= 0; i--) {
        const indexToDelete = aiMessagesToDelete[i];
        history.splice(indexToDelete, 1);
    }
    
    console.log('åˆ é™¤åçš„historyé•¿åº¦:', history.length);
    
    // 3. ç«‹å³ä¿å­˜æ•°æ®
    saveData();
    
    // 4. é‡æ–°æ¸²æŸ“ç•Œé¢ï¼ˆç°åœ¨åªæ˜¾ç¤ºåˆ°ç”¨æˆ·æ¶ˆæ¯ï¼ŒAIæ¶ˆæ¯éƒ½è¢«åˆ é™¤äº†ï¼‰
    renderMessages(history);
    
    // 5. æ¸…é™¤è¾“å…¥æ¡†ï¼ˆç¡®ä¿ä¸ä¼šæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼‰
    const textarea = document.getElementById('chat-textarea');
    if (textarea) {
        textarea.value = '';
        textarea.style.height = '36px';
    }
    
        // 6. ç«‹å³é‡æ–°ç”ŸæˆAIå›å¤
    if (!currentContact || isTyping) return;
    
    console.log('å¼€å§‹é‡æ–°ç”ŸæˆAIå›å¤ï¼Œç”¨æˆ·æ¶ˆæ¯:', userMessage);
    
    isTyping = true;
    const {msgDiv, bubble} = appendMessageToDOM('', 'ai', true);
    
    mockAIResponse(userMessage, currentContact).then(aiReply => {
        console.log('AIå›å¤æ”¶åˆ°:', aiReply);
        
        bubble.classList.remove('typing-indicator');
        bubble.innerHTML = '';
        
        typeMessageInMultipleBubbles(aiReply, bubble, msgDiv).then(({sentences, fullReply}) => {
            console.log('åˆ†å‰²åçš„å¥å­:', sentences);
            
            // ä¿å­˜æ–°ç”Ÿæˆçš„AIå›å¤åˆ°å†å²è®°å½•
            if (sentences && sentences.length > 1) {
                sentences.forEach((sentence, index) => {
                    currentContact.history.push({ 
                        role: 'ai', 
                        content: sentence,
                        isSegment: true,
                        segmentIndex: index
                    });
                });
            } else {
                currentContact.history.push({ role: 'ai', content: fullReply });
            }
            
            isTyping = false;
            simulateMemorySummary(currentContact);
            saveData();
            
            console.log('é‡æ–°ç”Ÿæˆå®Œæˆï¼Œæœ€ç»ˆhistoryé•¿åº¦:', currentContact.history.length);
        });
    }).catch(error => {
        console.error('AIç”Ÿæˆå¤±è´¥:', error);
        isTyping = false;
        bubble.textContent = 'é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•';
    });
}

// æ¸©åº¦æ»‘å—å®æ—¶æ›´æ–°
document.getElementById('temperature').addEventListener('input', function() {
    document.getElementById('temperature-value').textContent = this.value;
});

// åŠ è½½æ—¶æ›´æ–°æ»‘å—æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    const tempSlider = document.getElementById('temperature');
    const tempValue = document.getElementById('temperature-value');
    if (tempSlider && tempValue) {
        tempValue.textContent = tempSlider.value;
    }
});

// æ¨¡å‹å‚æ•°ï¼ˆæ¸©åº¦ä¸Tokenï¼‰æ»‘å—åˆå§‹åŒ–
function initParamSliders() {
    // ç¡®ä¿è·å–æ­£ç¡®çš„ HTML å…ƒç´ 
    const tempTrack = document.getElementById('temp-track');
    const tempThumb = document.getElementById('temp-slider-thumb');
    const tempValue = document.getElementById('temperature-value');
    const tempInput = document.getElementById('temperature');

    const tokenTrack = document.getElementById('maxTokens-track');
    const tokenThumb = document.getElementById('maxTokens-thumb');
    const tokenValue = document.getElementById('maxTokens-value');
    const tokenInput = document.getElementById('maxTokens-input');

    function setupSlider(track, thumb, display, input, min, max, isFloat) {
        if (!track || !thumb) return;
        let isDragging = false;

        const update = (clientX) => {
            const rect = track.getBoundingClientRect();
            // è®¡ç®—ç™¾åˆ†æ¯”
            let percent = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
            // è®¡ç®—æ•°å€¼
            let value = min + (percent / 100) * (max - min);
            
            if (isFloat) {
                value = parseFloat(value.toFixed(1)); // æ¸©åº¦ä¿ç•™ä¸€ä½å°æ•°
            } else {
                value = Math.round(value / 256) * 256; // TokenæŒ‰128æ­¥è¿›
            }
            
            // é‡æ–°è®¡ç®—ç™¾åˆ†æ¯”ä»¥å¯¹é½æ­¥è¿›åçš„ä½ç½®
            const finalPercent = ((value - min) / (max - min)) * 100;
            thumb.style.left = finalPercent + '%';
            display.textContent = value;
            input.value = value;
        };

        // é¼ æ ‡äº‹ä»¶
        const onMouseDown = (e) => { isDragging = true; update(e.clientX); };
        const onMouseMove = (e) => { if (isDragging) update(e.clientX); };
        const onMouseUp = () => { isDragging = false; };

        // è§¦æ‘¸äº‹ä»¶ (é€‚é…æ‰‹æœº)
        const onTouchStart = (e) => { isDragging = true; update(e.touches[0].clientX); e.preventDefault(); };
        const onTouchMove = (e) => { if (isDragging) update(e.touches[0].clientX); };

        track.addEventListener('mousedown', onMouseDown);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);

        thumb.addEventListener('touchstart', onTouchStart, {passive: false});
        document.addEventListener('touchmove', onTouchMove, {passive: false});
        document.addEventListener('touchend', onMouseUp);

        // åˆå§‹ä½ç½®è®¾ç½®
        const initVal = isFloat ? (parseFloat(input.value) || 0.7) : (parseInt(input.value) || 2048);
        const initPercent = ((initVal - min) / (max - min)) * 100;
        thumb.style.left = initPercent + '%';
        display.textContent = initVal;
    }

    setupSlider(tempTrack, tempThumb, tempValue, tempInput, 0.1, 2.0, true);
    setupSlider(tokenTrack, tokenThumb, tokenValue, tokenInput, 256, 4096, false);
}
// é¡µé¢åŠ è½½åç«‹å³å¯åŠ¨
document.addEventListener('DOMContentLoaded', initParamSliders);

// è®¡ç®—ç¼“å­˜å¤§å°å¹¶æ›´æ–°æ˜¾ç¤º
function updateCacheSize() {
    try {
        // è®¡ç®—æ€»æ•°æ®å¤§å°
        const dataStr = JSON.stringify(APP_DATA);
        const dataSize = new Blob([dataStr]).size; // å­—èŠ‚
        
        // è½¬æ¢ä¸ºäººæ€§åŒ–çš„æ˜¾ç¤ºå•ä½
        let displaySize, displayUnit;
        if (dataSize < 1024) {
            displaySize = dataSize;
            displayUnit = 'B';
        } else if (dataSize < 1024 * 1024) {
            displaySize = (dataSize / 1024).toFixed(1);
            displayUnit = 'KB';
        } else {
            displaySize = (dataSize / (1024 * 1024)).toFixed(2);
            displayUnit = 'MB';
        }
        
        // è®¡ç®—è¿›åº¦æ¡ï¼ˆå‡è®¾æœ€å¤§5MBï¼‰
        const maxSize = 5 * 1024 * 1024; // 5MB
        const percentage = Math.min(100, (dataSize / maxSize) * 100);
        
        // æ›´æ–°æ˜¾ç¤º
        const sizeElement = document.getElementById('cache-size');
        const progressElement = document.getElementById('cache-progress');
        
        if (sizeElement) {
            sizeElement.textContent = `${displaySize} ${displayUnit}`;
        }
        if (progressElement) {
            progressElement.style.width = `${percentage}%`;
            
            // æ ¹æ®ä½¿ç”¨ç‡æ”¹å˜é¢œè‰²
            if (percentage > 90) {
                progressElement.style.background = 'var(--danger-color)';
            } else if (percentage > 70) {
                progressElement.style.background = 'var(--warning-color)';
            } else {
                progressElement.style.background = 'var(--accent-color)';
            }
        }
    } catch (error) {
        console.error('è®¡ç®—ç¼“å­˜å¤§å°å¤±è´¥:', error);
        const sizeElement = document.getElementById('cache-size');
        if (sizeElement) {
            sizeElement.textContent = 'è®¡ç®—å¤±è´¥';
        }
    }
}

// åœ¨æ•°æ®å˜åŒ–æ—¶æ›´æ–°ç¼“å­˜æ˜¾ç¤º
function saveData() {
    console.log('ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨:', APP_DATA); // è°ƒè¯•ç”¨
    localStorage.setItem('AI_PHONE_APP_DATA', JSON.stringify(APP_DATA));
}

// é¡µé¢åŠ è½½æ—¶è®¡ç®—ç¼“å­˜å¤§å°
document.addEventListener('DOMContentLoaded', function() {
    // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿é¡µé¢åŠ è½½å®Œæˆ
    setTimeout(updateCacheSize, 500);
});

// åœ¨å¯¼å…¥/å¯¼å‡ºæ•°æ®åä¹Ÿæ›´æ–°æ˜¾ç¤º
function exportData() {
    const dataStr = JSON.stringify(APP_DATA, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'ai_chat_data.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    alert('æ•°æ®å·²å¯¼å‡ºä¸º JSON æ–‡ä»¶');
    updateCacheSize(); // å¯¼å‡ºåæ›´æ–°æ˜¾ç¤º
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                APP_DATA = importedData;
                saveData();
                alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°');
                location.reload();
            } catch (error) {
                alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„JSONæ–‡ä»¶');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// ç‚¹å‡»ç©ºç™½å¤„é€€å‡ºç®¡ç†æ¨¡å¼
document.addEventListener('click', function(event) {
    if (isManageMode) {
        // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯ç®¡ç†ç›¸å…³å…ƒç´ 
        const isManageButton = event.target.closest('.manage-button');
        const isContactItem = event.target.closest('.contact-item');
        const isBatchToolbar = event.target.closest('.batch-toolbar');
        
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¿™äº›å…ƒç´ ï¼Œé€€å‡ºæ‰€æœ‰ç®¡ç†æ¨¡å¼
        if (!isManageButton && !isContactItem && !isBatchToolbar) {
            // ç›´æ¥é€€å‡ºæ‰€æœ‰æ¨¡å¼
            isManageMode = false;
            batchMode = false;
            selectedContacts.clear();
            document.getElementById('batch-toolbar').classList.remove('show');
            renderContacts(); // é‡æ–°æ¸²æŸ“ï¼Œé€€å‡ºç¼–è¾‘æ¨¡å¼
        }
    }
});

// ç´§æ€¥ä¿®å¤èŠå¤©åŠŸèƒ½
function quickFixChat() {
    const textarea = document.getElementById('chat-textarea');
    if (!textarea) return;
    
    // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨
    const newTextarea = textarea.cloneNode(true);
    textarea.parentNode.replaceChild(newTextarea, textarea);
    
    // é‡æ–°ç»‘å®šäº‹ä»¶
    newTextarea.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });
    
    newTextarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
}


// ä¿®å¤å›è½¦é—®é¢˜çš„ç»ˆææ–¹æ¡ˆ
function initChatInput() {
    const textarea = document.getElementById('chat-textarea');
    if (!textarea) {
        setTimeout(initChatInput, 100);
        return;
    }
    
    // ç§»é™¤æ‰€æœ‰æ—§äº‹ä»¶
    const newTextarea = textarea.cloneNode(true);
    textarea.parentNode.replaceChild(newTextarea, textarea);
    
    // ç»‘å®šå›è½¦äº‹ä»¶ - æœ€ç®€å•çš„å®ç°
    newTextarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            // Shift+Enter = æ¢è¡Œ
            if (e.shiftKey) {
                return; // å…è®¸é»˜è®¤è¡Œä¸º
            }
            
            // çº¯Enter = å‘é€
            e.preventDefault();
            
            const text = this.value.trim();
            if (text && currentContact && !isTyping) {
                // ä¿å­˜æ–‡æœ¬ï¼Œæ¸…ç©ºè¾“å…¥æ¡†
                const messageText = text;
                this.value = '';
                this.style.height = '36px';
                
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿è¾“å…¥æ¡†æ¸…ç©º
                setTimeout(() => {
                    // æ‰‹åŠ¨æ‰§è¡Œå‘é€é€»è¾‘
                    appendMessageToDOM(messageText, 'user');
                    currentContact.history.push({ role: 'user', content: messageText });
                    
                    // AIå›å¤
                    isTyping = true;
                    const {msgDiv, bubble} = appendMessageToDOM('', 'ai', true);
                    
                    mockAIResponse(messageText, currentContact).then(aiReply => {
                        bubble.classList.remove('typing-indicator');
                        bubble.innerHTML = '';
                        
                        typeMessageInMultipleBubbles(aiReply, bubble, msgDiv).then(({sentences, fullReply}) => {
                            if (sentences && sentences.length > 1) {
                                sentences.forEach((sentence, index) => {
                                    currentContact.history.push({ 
                                        role: 'ai', 
                                        content: sentence,
                                        isSegment: true,
                                        segmentIndex: index
                                    });
                                });
                            } else {
                                currentContact.history.push({ role: 'ai', content: fullReply });
                            }
                            
                            isTyping = false;
                            simulateMemorySummary(currentContact);
                            saveData();
                        });
                    });
                }, 10);
            }
        }
    });
    
    // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
    newTextarea.addEventListener('input', function() {
        this.style.height = 'auto';
        const height = Math.min(this.scrollHeight, 100);
        this.style.height = height + 'px';
    });
}

// é¡µé¢åŠ è½½ååˆå§‹åŒ–
setTimeout(initChatInput, 500);

function refreshAllData() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const icon = refreshBtn?.querySelector('i');
    
// å…ˆä¿å­˜å½“å‰æ•°æ®
    saveData();
        
    // å»¶è¿Ÿååˆ·æ–°æ•´ä¸ªç½‘é¡µ
    setTimeout(() => {
        location.reload();
    }, 300);

    if (icon) {
        // 1. ç‚¹å‡»åè½¬å‡ åœˆ
        let rotation = 0;
        let circles = 0;
        const maxCircles = 1; // è½¬3åœˆ
        
        const spin = () => {
            rotation += 5; 
            icon.style.transform = `rotate(${rotation}deg)`;
            
            // æ¯360åº¦ç®—ä¸€åœˆ
            if (rotation >= 360) {
                rotation = 0;
                circles++;
            }
            
            // è½¬å¤Ÿåœˆæ•°å°±åœ
            if (circles < maxCircles) {
                requestAnimationFrame(spin);
            } else {
                icon.style.transform = 'rotate(0deg)';
                // åˆ·æ–°å®Œæˆåæç¤º
                setTimeout(() => {
                    alert('å·²åˆ·æ–°');
                }, 100);
            }
        };
        
        // å¼€å§‹è½¬
        spin();
        
        // 2. æ‰§è¡Œåˆ·æ–°é€»è¾‘
        const savedData = localStorage.getItem('AI_PHONE_APP_DATA');
        if (savedData) {
            try {
                APP_DATA = JSON.parse(savedData);
            } catch (error) {
                console.error('æ•°æ®è§£æå¤±è´¥:', error);
            }
        }
        renderContacts();
    }
}

// ç›‘å¬æ»šåŠ¨åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
        messagesContainer.addEventListener('scroll', function() {
            // æ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘æ—¶åŠ è½½æ›´å¤š
            if (this.scrollTop < 100 && currentStartIndex > 0 && !isLoadingMore) {
                loadMoreMessages();
            }
        });
    }
});

// ç›‘å¬æ‰€æœ‰æ»šåŠ¨äº‹ä»¶å…³é—­èœå•
window.addEventListener('scroll', closeAIMenu);
document.getElementById('chat-messages')?.addEventListener('scroll', closeAIMenu);

function doCreateNewPreset() {
    // ç›´æ¥æ‰“å¼€ç¼–è¾‘é¢„è®¾ç•Œé¢ï¼ˆä¸åˆ›å»ºé¢„è®¾å¯¹è±¡ï¼‰
    const newPresetId = 'new_' + Date.now(); // ä¸´æ—¶ID
    editPreset(newPresetId); // ä½¿ç”¨ç°æœ‰çš„ç¼–è¾‘å‡½æ•°
    
    // åœ¨ç¼–è¾‘ç•Œé¢ä¸­è®¾ç½®ç©ºå€¼
    setTimeout(() => {
        const nameInput = document.getElementById('edit-preset-name');
        const urlInput = document.getElementById('edit-api-url');
        const keyInput = document.getElementById('edit-api-key');
        const modelInput = document.getElementById('edit-default-model');
        
        if (nameInput) nameInput.value = '';
        if (urlInput) urlInput.value = '';
        if (keyInput) keyInput.value = '';
        if (modelInput) modelInput.value = '';
        
        // èšç„¦åˆ°é¢„è®¾åè¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸éœ€è¦è‡ªåŠ¨èšç„¦å¯ä»¥å»æ‰ï¼‰
        // if (nameInput) nameInput.focus();
    }, 100);
}

function refreshPresetList() {
    const list = document.getElementById('preset-list');
    
    console.log('åˆ·æ–°é¢„è®¾åˆ—è¡¨ï¼Œé¢„è®¾æ•°é‡:', APP_DATA.presets ? APP_DATA.presets.length : 0);
    
    if (!APP_DATA.presets || APP_DATA.presets.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-color-secondary);">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                <div>æ— é¢„è®¾</div>
            </div>
        `;

    } else {
        // ã€æ–°å¢ã€‘æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
        const sortedPresets = [...APP_DATA.presets].sort((a, b) => {
            // è·å–æœ€åä½¿ç”¨æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨0
            const timeA = a.lastUsedTime || 0;
            const timeB = b.lastUsedTime || 0;
            
            // å€’åºæ’åºï¼šæ—¶é—´å¤§çš„ï¼ˆæ–°çš„ï¼‰åœ¨å‰é¢
            return timeB - timeA;
        });
        
        // å¦‚æœæœ‰é¢„è®¾ï¼Œæ˜¾ç¤ºé¢„è®¾åˆ—è¡¨ï¼ˆæŒ‰æ’åºåçš„é¡ºåºï¼‰
        list.innerHTML = '';
        sortedPresets.forEach(preset => {  // â† è¿™é‡Œæ”¹ä¸º sortedPresets
            const div = document.createElement('div');
            div.style.cssText = `
                padding: 12px 15px; margin-bottom: 8px; border-radius: 10px;
                background: var(--input-bg); border: 1px solid var(--input-border);
                position: relative;
                min-height: 60px; /* å›ºå®šæœ€å°é«˜åº¦ */
            `;
            
            // ä¸»å†…å®¹åŒºåŸŸï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰
            const contentDiv = document.createElement('div');
            contentDiv.style.cssText = `
                cursor: pointer;
                margin-right: 70px; /* ç»™æŒ‰é’®ç•™ç©ºé—´ */
            `;
            
            contentDiv.innerHTML = `
                <div style="font-weight: bold; color: var(--text-color-primary); font-size: 17px;">
                    ${preset.name}
                </div>
                <div style="font-size: 14px; color: var(--accent-color); margin-top: 8px;">
                    ${preset.defaultModel || 'æ— æ¨¡å‹'}
                </div>
            `;
            
            contentDiv.onclick = function() {
    console.log('é€‰æ‹©é¢„è®¾:', preset.name);
    
    // 1. å…ˆåŠ è½½é¢„è®¾æ•°æ®
    loadPreset(preset.id);
    
    // 2. å…³é—­å¼¹çª—ï¼ˆç”¨hideModalç¡®ä¿åŠ¨ç”»æ­£ç¡®ï¼‰
    hideModal('preset-modal');
    
    // 3. ã€é‡è¦ã€‘ä¿å­˜å½“å‰è®¾ç½®
    saveData();
    
    // 4. æ›´æ–°ä¸»é¡µé¢æ˜¾ç¤º
    document.getElementById('api-preset-display').value = preset.name;
    
    // 5. éšè—APIè¾“å…¥å­—æ®µï¼ˆå› ä¸ºç°åœ¨æœ‰é¢„è®¾äº†ï¼‰
    const apiFieldsContainer = document.getElementById('api-fields-container');
    if (apiFieldsContainer) {
        apiFieldsContainer.style.display = 'none';
    }
    document.getElementById('save-preset-btn').style.display = 'none';
    
    console.log('å·²é€‰æ‹©é¢„è®¾:', preset.name);
};
            
            div.appendChild(contentDiv);
            
            // æ“ä½œæŒ‰é’®å®¹å™¨
            const actionsDiv = document.createElement('div');
                        actionsDiv.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;  /* å‚ç›´å±…ä¸­ */
                transform: translateY(-50%);  /* å‚ç›´å±…ä¸­ */
                display: flex;
                gap: 6px;
            `;
            
            // ç¼–è¾‘æŒ‰é’®
            const editBtn = document.createElement('button');
            editBtn.innerHTML = 'âœ';
            editBtn.style.cssText = `
                width: 30px;
                height: 30px;
                border-radius: 6px;
                background: var(--accent-color);
                color: white;
                border: none;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            editBtn.title = 'ç¼–è¾‘é¢„è®¾';
            editBtn.onclick = function(e) {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘é€‰æ‹©
                editPreset(preset.id);
            };
            
            // åˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.style.cssText = `
                width: 30px;
                height: 30px;
                border-radius: 6px;
                background: var(--danger-color);
                color: white;
                border: none;
                cursor: pointer;
                font-size: 18px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            deleteBtn.title = 'åˆ é™¤é¢„è®¾';
            deleteBtn.onclick = function(e) {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                deletePreset(preset.id);
            };
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            div.appendChild(actionsDiv);
            
            list.appendChild(div);
        });
    }

// ã€æ–°å¢ã€‘ç¡®ä¿åˆ—è¡¨æ»šåŠ¨åˆ°é¡¶éƒ¨
    setTimeout(() => {
        if (list) {
            list.scrollTop = 0;
        }
    }, 50);
}

function openPresetManager() {
    // æ˜¾ç¤ºå¼¹çª—
    const modal = document.getElementById('preset-modal');
    modal.style.display = 'flex';
    modal.offsetWidth; // è§¦å‘é‡æ’
    modal.classList.add('active');
    
    // ç„¶ååˆ·æ–°é¢„è®¾åˆ—è¡¨
    refreshPresetList();
}


// æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å¼¹çª—
function showModelSelectDialog(models) {
    // åˆ›å»ºå¼¹çª—
    const modal = document.createElement('div');
    modal.id = 'model-select-modal';
    modal.className = 'overlay';
    modal.style.display = 'flex';
    modal.style.zIndex = '2000';
    
    modal.innerHTML = `
    <div style="
        background: var(--bg-color-secondary); 
        border-radius: 20px; 
        width: 90vw;
        max-width: 420px; 
        height: 80vh;
        max-height: 700px;
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    ">
        <!-- æ ‡é¢˜ -->
        <div style="
            padding: 24px 24px 16px 24px; 
            flex-shrink: 0;
        ">
            <h4 style="
                margin: 0; 
                color: var(--text-color-primary);
                font-size: 20px;
                font-weight: 600;
                text-align: center;
            ">
                é€‰æ‹©æ¨¡å‹ (${models.length}ä¸ª)
            </h4>
        </div>
        
        <!-- æœç´¢æ¡† - å·¦å³æœ‰è¾¹è· -->
        <div style="
            padding: 0 24px 16px 24px; 
            flex-shrink: 0;
        ">
            <input type="text" id="model-search-input" 
                   placeholder="æœç´¢æ¨¡å‹..." 
                   style="
                        width: 100%; 
                        padding: 15px 18px;
                        border-radius: 14px; 
                        border: 1px solid var(--input-border); 
                        background: var(--input-bg); 
                        color: var(--text-color-primary);
                        font-size: 16px;
                        box-sizing: border-box;
                        outline: none;
                   ">
        </div>
        
        <!-- æ¨¡å‹åˆ—è¡¨å®¹å™¨ - å…³é”®ï¼šç‹¬ç«‹æ»šåŠ¨åŒºåŸŸ -->
        <div style="
            flex: 1; 
            overflow: hidden;
            position: relative;
            margin: 0 24px;
            background: var(--bg-color-secondary);
            border-radius: 12px;
        ">
            <div id="model-items-container" style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                overflow-y: auto;
                overflow-x: hidden;
                scrollbar-width: none;
                -ms-overflow-style: none;
                -webkit-overflow-scrolling: touch;
                padding: 0 12px 100px 12px; /* åº•éƒ¨100pxç¡®ä¿ä¸è¢«é®æŒ¡ */
            ">
                <!-- æ¨¡å‹åˆ—è¡¨åœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <!-- åº•éƒ¨æŒ‰é’® - ç»å¯¹å®šä½åœ¨å®¹å™¨å¤– -->
        <div style="
            padding: 20px 24px 24px 24px; 
            flex-shrink: 0;
            background: var(--bg-color-secondary);
            border-top: 1px solid var(--input-border);
        ">
            <button onclick="document.getElementById('model-list-modal').remove()" 
                    style="
                        width: 100%; 
                        padding: 18px; 
                        border-radius: 14px;
                        background: var(--input-bg); 
                        color: var(--text-color-primary);
                        border: 1px solid var(--input-border);
                        font-size: 17px;
                        font-weight: 500;
                        cursor: pointer;
                    ">
                å–æ¶ˆ
            </button>
        </div>
    </div>
`;
    
    document.body.appendChild(modal);
    
    // å¡«å……æ¨¡å‹åˆ—è¡¨
    const container = document.getElementById('model-list-container');
    renderModelList(models, container);
    
    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('model-search');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredModels = models.filter(model => {
            const modelId = (model.id || model).toLowerCase();
            return modelId.includes(searchTerm);
        });
        renderModelList(filteredModels, container);
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
   
}

// æ¸²æŸ“æ¨¡å‹åˆ—è¡¨
function renderModelList(models, container) {
    container.innerHTML = '';
    
    if (models.length === 0) {
        container.innerHTML = `
            <div style="padding: 30px; text-align: center; color: var(--text-color-secondary);">
                æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹
            </div>
        `;
        return;
    }
    
    models.forEach((model, index) => {
        const modelId = model.id || model;
        const modelName = modelId.split('/').pop(); // å–æœ€åä¸€éƒ¨åˆ†
        
        const item = document.createElement('div');
        item.className = 'model-item';
        // ä¿®æ”¹item.style.cssText
item.style.cssText = `
    padding: 18px 20px; 
    margin: 0 auto 12px auto; /* å±…ä¸­ï¼šå·¦å³auto */
    border-radius: 14px;
    border: 1px solid var(--input-border); 
    cursor: pointer;
    background: var(--input-bg); 
    transition: all 0.2s;
    width: 100%; 
    max-width: 100%; /* ç¡®ä¿ä¸è¶…è¿‡å®¹å™¨ */
    box-sizing: border-box;
    word-break: break-word;
    text-align: left; /* æ–‡å­—å·¦å¯¹é½ */
    display: block; /* ç¡®ä¿å±…ä¸­ç”Ÿæ•ˆ */
`;

// ä¿®æ”¹å†…å®¹HTMLï¼Œæ–‡å­—å·¦å¯¹é½ä½†æ•´ä½“å±…ä¸­
item.innerHTML = `
    <div style="
        font-weight: 600; 
        color: var(--text-color-primary);
        font-size: 17px;
        margin-bottom: 8px;
        text-align: left;
    ">
        ${displayName}
    </div>
    <div style="
        font-size: 14px; 
        color: var(--text-color-secondary); 
        line-height: 1.4;
        text-align: left;
        opacity: 0.8;
    ">
        ${modelId}
    </div>
`;
        
        item.onclick = function() {
            document.getElementById('ai-model').value = modelId;
            document.getElementById('model-select-modal').remove();
        };
        
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'var(--input-bg)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
        
        container.appendChild(item);
    });
}

async function openModelSelector() {
    // å…ˆæ£€æŸ¥APIä¿¡æ¯
    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    
    if (!apiUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™API URLå’ŒAPI Key');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½å¼¹çª—
    const loadingModal = document.createElement('div');
    loadingModal.id = 'loading-model-modal';
    loadingModal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
    `;
    
    loadingModal.innerHTML = `
        <div style="background: var(--bg-color-secondary); padding: 30px; border-radius: 16px; 
                    min-width: 200px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
            </div>
            <div>æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</div>
        </div>
    `;
    
    document.body.appendChild(loadingModal);
    
    try {
        // å°è¯•è·å–æ¨¡å‹åˆ—è¡¨
        const models = await fetchModelList(apiUrl, apiKey);
        
        // ç§»é™¤åŠ è½½å¼¹çª—
        loadingModal.remove();
        
        if (models.length === 0) {
            // è·å–å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥
            showManualInputModal();
        } else {
            // æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©åˆ—è¡¨
            showModelListModal(models);
        }
        
    } catch (error) {
        // ç§»é™¤åŠ è½½å¼¹çª—
        loadingModal.remove();
        
        console.error('è·å–æ¨¡å‹å¤±è´¥:', error);
        
        // æ›´å‹å¥½çš„é”™è¯¯æç¤º
        let errorMsg = 'è·å–æ¨¡å‹å¤±è´¥: ' + error.message;
        if (error.message.includes('æ— æ³•æ‰¾åˆ°å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹')) {
            errorMsg = 'æ— æ³•è‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. è¯¥APIæä¾›å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨\n2. æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹ä¸æ ‡å‡†OpenAIæ ¼å¼ä¸åŒ\n3. éœ€è¦æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°';
        }
        
        alert(errorMsg);
        // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥
        showManualInputModal();
    }
}

// è·å–æ¨¡å‹åˆ—è¡¨
async function fetchModelList(apiUrl, apiKey) {
    console.log('å¼€å§‹è·å–æ¨¡å‹åˆ—è¡¨ï¼ŒAPI URL:', apiUrl);
    
    // å°è¯•å¤šç§å¯èƒ½çš„æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹
    const possibleEndpoints = [];
    
    // 1. ä»èŠå¤©URLæ¨æ–­æ¨¡å‹åˆ—è¡¨URL
    if (apiUrl.includes('/chat/completions')) {
        // å°è¯•æ›¿æ¢ä¸º /models
        possibleEndpoints.push(apiUrl.replace('/chat/completions', '/models'));
        // å°è¯•æ›¿æ¢ä¸º /v1/models
        possibleEndpoints.push(apiUrl.replace('/v1/chat/completions', '/v1/models'));
        // å°è¯•ç§»é™¤è·¯å¾„éƒ¨åˆ†
        const baseUrl = apiUrl.split('/chat/completions')[0];
        possibleEndpoints.push(baseUrl + '/models');
        possibleEndpoints.push(baseUrl + '/v1/models');
    }
    
    // 2. æ·»åŠ ä¸€äº›å¸¸è§å…¬ç›Šç«™çš„ç‰¹å®šç«¯ç‚¹
    if (apiUrl.includes('openrouter.ai')) {
        possibleEndpoints.push('https://openrouter.ai/api/v1/models');
    }
    if (apiUrl.includes('api.openai.com')) {
        possibleEndpoints.push('https://api.openai.com/v1/models');
    }
    
    // 3. æœ€åå°è¯•ç›´æ¥ä½¿ç”¨ /models
    possibleEndpoints.push(apiUrl.replace(/\/chat\/completions.*$/, '') + '/models');
    
    // å»é‡
    const uniqueEndpoints = [...new Set(possibleEndpoints.filter(url => url && url !== apiUrl))];
    
    console.log('å°è¯•çš„ç«¯ç‚¹åˆ—è¡¨:', uniqueEndpoints);
    
    let lastError = null;
    
    // å°è¯•æ¯ä¸ªå¯èƒ½çš„ç«¯ç‚¹
    for (const modelsUrl of uniqueEndpoints) {
        try {
            console.log(`å°è¯•ç«¯ç‚¹: ${modelsUrl}`);
            
            const response = await fetch(modelsUrl, {
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                timeout: 8000 // 8ç§’è¶…æ—¶
            });
            
            if (!response.ok) {
                console.log(`ç«¯ç‚¹ ${modelsUrl} è¿”å›é”™è¯¯: ${response.status}`);
                continue; // å°è¯•ä¸‹ä¸€ä¸ªç«¯ç‚¹
            }
            
            const data = await response.json();
            console.log('è·å–åˆ°çš„åŸå§‹æ•°æ®:', data);
            
            // å¤šç§æ ¼å¼çš„æ¨¡å‹åˆ—è¡¨æå–
            let models = [];
            
            if (Array.isArray(data)) {
                models = data;
            } else if (data.data && Array.isArray(data.data)) {
                models = data.data;
            } else if (data.models && Array.isArray(data.models)) {
                models = data.models;
            } else if (data.result && Array.isArray(data.result)) {
                models = data.result; // æœ‰äº›APIç”¨resultå­—æ®µ
            }
            
            // æå–æ¨¡å‹ID
            const modelList = models.map(item => {
                if (typeof item === 'string') {
                    return { id: item };
                } else if (item.id) {
                    return { id: item.id };
                } else if (item.model) {
                    return { id: item.model }; // æœ‰äº›ç”¨modelå­—æ®µ
                }
                return null;
            }).filter(item => item && item.id);
            
            console.log(`æˆåŠŸä» ${modelsUrl} è·å–åˆ° ${modelList.length} ä¸ªæ¨¡å‹`);
            
            if (modelList.length > 0) {
                return modelList;
            }
            
        } catch (error) {
            console.log(`ç«¯ç‚¹ ${modelsUrl} å¤±è´¥:`, error.message);
            lastError = error;
            continue; // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
        }
    }
    
    // æ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥äº†
    throw new Error(lastError ? `è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${lastError.message}` : 'æ— æ³•æ‰¾åˆ°å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹');
}

// ä¸ºfetchæ·»åŠ timeoutæ”¯æŒ
if (!fetch.timeout) {
    fetch.timeout = function(resource, options = {}) {
        const { timeout = 8000 } = options;
        
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        
        return fetch(resource, {
            ...options,
            signal: controller.signal
        }).then(response => {
            clearTimeout(id);
            return response;
        }).catch(error => {
            clearTimeout(id);
            throw error;
        });
    };
}
// æ˜¾ç¤ºæ¨¡å‹åˆ—è¡¨å¼¹çª—
function showModelListForEdit(models) {
    const modal = document.createElement('div');
    modal.id = 'model-list-edit-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
    <div style="background: var(--bg-color-secondary); border-radius: 16px; 
                width: 100%; max-width: 320px; max-height: 70vh;
                display: flex; flex-direction: column;">
        <div style="padding: 20px; border-bottom: 1px solid var(--input-border);">
            <h4 style="margin: 0; color: var(--text-color-primary);">é€‰æ‹©æ¨¡å‹ (${models.length}ä¸ª)</h4>
        </div>
        
        <div style="padding: 15px; flex: 1; overflow-y: auto;">
            <input type="text" id="model-search-edit-input" 
                   placeholder="æœç´¢æ¨¡å‹..." 
                   style="width: 90%; padding: 10px 15px; margin: 0 auto 15px auto;
                          border-radius: 10px; border: 1px solid var(--input-border); 
                          background: var(--input-bg); color: var(--text-color-primary);
                          display: block;">
            
            <div id="model-items-edit-container" style="max-height: 50vh; overflow-y: auto;">
                <!-- æ¨¡å‹åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--input-border); text-align: center;">
            <button onclick="document.getElementById('model-list-edit-modal').remove()" 
                    style="padding: 10px 20px; border-radius: 8px;
                           background: var(--input-bg); color: var(--text-color-primary);
                           border: 1px solid var(--input-border); cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>
    `;
    
    document.body.appendChild(modal);
    
    // å¡«å……æ¨¡å‹åˆ—è¡¨
    renderModelsForEdit(models);
    
    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('model-search-edit-input');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredModels = models.filter(model => {
            const modelId = (model.id || model).toLowerCase();
            return modelId.includes(searchTerm);
        });
        renderModelsForEdit(filteredModels);
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    
}

function renderModelsForEdit(models) {
    const container = document.getElementById('model-items-edit-container');
    container.innerHTML = '';
    
    if (models.length === 0) {
        container.innerHTML = `
            <div style="padding: 30px; text-align: center; color: var(--text-color-secondary);">
                æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹
            </div>
        `;
        return;
    }
    
    models.forEach((model) => {
        const modelId = model.id || model;
        const displayName = modelId.split('/').pop();
        
        const item = document.createElement('div');
        item.style.cssText = `
            padding: 12px 15px; margin: 0 10px 8px 10px; border-radius: 10px;
            border: 1px solid var(--input-border); cursor: pointer;
            background: var(--input-bg); transition: all 0.2s;
            width: calc(100% - 20px);
            box-sizing: border-box;
            overflow: hidden;
            word-break: break-word;
        `;
        
        item.innerHTML = `
            <div style="font-weight: bold; color: var(--text-color-primary);">
                ${displayName}
            </div>
            <div style="font-size: 12px; color: var(--text-color-secondary); margin-top: 4px;">
                ${modelId}
            </div>
        `;
        
        item.onclick = function() {
            // æ›´æ–°ç¼–è¾‘å¼¹çª—ä¸­çš„æ¨¡å‹è¾“å…¥æ¡†
            document.getElementById('edit-default-model').value = modelId;
            // å…³é—­æ¨¡å‹é€‰æ‹©å¼¹çª—
            document.getElementById('model-list-edit-modal').remove();
        };
        
        // æ‚¬åœæ•ˆæœ
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(var(--accent-color-rgb), 0.1)';
            this.style.borderColor = 'var(--accent-color)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.borderColor = '';
        });
        
        container.appendChild(item);
    });
}

// æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥å¼¹çª—ï¼ˆå¤‡ç”¨ï¼‰
function showManualInputModal() {
    const modelName = prompt('è¯·è¾“å…¥æ¨¡å‹åç§°ï¼ˆä¾‹å¦‚ï¼šqwen-72b-chatï¼‰:', 
                            document.getElementById('ai-model').value);
    if (modelName && modelName.trim()) {
        document.getElementById('ai-model').value = modelName.trim();
    }
}

function editPreset(presetId) {
    const isNewPreset = presetId.toString().startsWith('new_');
    let preset;
    
    if (isNewPreset) {
        // æ–°å»ºæ¨¡å¼ï¼Œåˆ›å»ºä¸´æ—¶é¢„è®¾å¯¹è±¡
        preset = {
            id: presetId,
            name: '',
            apiUrl: '',
            apiKey: '',
            defaultModel: ''
        };
    } else {
        // ç¼–è¾‘ç°æœ‰é¢„è®¾
        preset = APP_DATA.presets.find(p => p.id == presetId);
    }
    
    if (!preset) return;    
    // å…ˆå…³é—­APIå¼¹çª—ï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆ
    const presetModal = document.getElementById('preset-modal');
    if (presetModal && presetModal.style.display === 'flex') {
        // å¼€å§‹å…³é—­åŠ¨ç”»
        presetModal.classList.remove('active');
        
                // ã€ç«‹å³åˆ›å»ºç¼–è¾‘å¼¹çª—ï¼Œä¸è¦ç­‰å¾…ï¼ã€‘
        const editModal = document.createElement('div');
        editModal.id = 'edit-preset-modal';
        editModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
            
            editModal.innerHTML = `
    <div style="
        background: var(--bg-color-secondary);
        border-radius: 16px;
        padding: 20px;  // å†…è¾¹è·ä¹Ÿæ”¹å°ä¸€ç‚¹
        width: 90%;
        max-width: 300px;  // æ”¹è¿™é‡Œï¼Œæ›´å°ä¸€ç‚¹
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    ">
                    <h4 style="margin-top: 0; margin-bottom: 20px; color: var(--text-color-primary);">
            ${isNewPreset ? 'æ–°å»ºé¢„è®¾' : 'ç¼–è¾‘é¢„è®¾'}
        </h4>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                            é¢„è®¾åç§°
                        </label>
                        <input type="text" id="edit-preset-name" 
                               style="width: 100%; padding: 12px; border-radius: 8px; 
                                      border: 1px solid var(--input-border); 
                                      background: var(--input-bg); color: var(--text-color-primary);
                                      cursor: pointer; box-sizing: border-box;"
                               value="${preset.name || ''}">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                            API URL
                        </label>
                        <input type="text" id="edit-api-url" 
                               style="width: 100%; padding: 12px; border-radius: 8px; 
                                      border: 1px solid var(--input-border); 
                                      background: var(--input-bg); color: var(--text-color-primary);
                                      cursor: pointer; box-sizing: border-box;"
                               value="${preset.apiUrl || ''}">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                            API Key
                        </label>
                        <input type="password" id="edit-api-key" 
                               style="width: 100%; padding: 12px; border-radius: 8px; 
                                      border: 1px solid var(--input-border); 
                                      background: var(--input-bg); color: var(--text-color-primary);
                                      cursor: pointer; box-sizing: border-box;"
                               value="${preset.apiKey || ''}">
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                            æ¨¡å‹
                        </label>
                        <input type="text" id="edit-default-model" readonly
                               style="width: 100%; padding: 12px; border-radius: 8px; 
                                      border: 1px solid var(--input-border); 
                                      background: var(--input-bg); color: var(--text-color-primary);
                                      cursor: pointer; box-sizing: border-box;"
                               value="${preset.defaultModel || ''}"
                               placeholder="ç‚¹å‡»é€‰æ‹©æ¨¡å‹"
                               onclick="openModelSelectorForEdit()">
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeEditPresetModal()"
                                style="padding: 10px 20px; border-radius: 8px; 
                                       background: var(--input-bg); color: var(--text-color-primary);
                                       border: 1px solid var(--input-border); cursor: pointer;">
                            å–æ¶ˆ
                        </button>
                        <button onclick="savePresetEdit('${presetId}')"
                                style="padding: 10px 20px; border-radius: 8px; 
                                       background: var(--accent-color); color: white;
                                       border: none; cursor: pointer;">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            // å»¶è¿Ÿä¸€ç‚¹å¼€å§‹æ·¡å…¥ï¼ˆå’ŒAPIå¼¹çª—æ·¡å‡ºåŒæ—¶ï¼‰
        setTimeout(() => {
            editModal.style.opacity = '1';
        }, 10);

            document.body.appendChild(editModal);
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            editModal.addEventListener('click', function(e) {
                if (e.target === editModal) {
                    closeEditPresetModal();
                }
            });
            
         // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—APIå¼¹çª—
        setTimeout(() => {
            presetModal.style.display = 'none';
        }, 300);
        
    } else {
        // å¦‚æœAPIå¼¹çª—æœ¬æ¥å°±æ²¡æ˜¾ç¤ºï¼Œç›´æ¥åˆ›å»ºç¼–è¾‘å¼¹çª—
        const editModal = document.createElement('div');
        editModal.id = 'edit-preset-modal';
        editModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: modalFadeIn 0.3s ease;
        `;
        
        editModal.innerHTML = `
            <div style="
                background: var(--bg-color-secondary);
                border-radius: 16px;
                padding: 24px;
                width: 90%;
                max-width: 350px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            ">
                <h4 style="margin-top: 0; margin-bottom: 20px; color: var(--text-color-primary);">
                    ç¼–è¾‘é¢„è®¾
                </h4>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                        é¢„è®¾åç§°
                    </label>
                    <input type="text" id="edit-preset-name" 
                           style="width: 100%; padding: 12px; border-radius: 8px; 
                                  border: 1px solid var(--input-border); 
                                  background: var(--input-bg); color: var(--text-color-primary);
                                  cursor: pointer; box-sizing: border-box;"
                           value="${preset.name || ''}">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                        API URL
                    </label>
                    <input type="text" id="edit-api-url" 
                           style="width: 100%; padding: 12px; border-radius: 8px; 
                                  border: 1px solid var(--input-border); 
                                  background: var(--input-bg); color: var(--text-color-primary);
                                  cursor: pointer; box-sizing: border-box;"
                           value="${preset.apiUrl || ''}">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                        API Key
                    </label>
                    <input type="password" id="edit-api-key" 
                           style="width: 100%; padding: 12px; border-radius: 8px; 
                                  border: 1px solid var(--input-border); 
                                  background: var(--input-bg); color: var(--text-color-primary);
                                  cursor: pointer; box-sizing: border-box;"
                           value="${preset.apiKey || ''}">
                </div>
                
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-color-primary);">
                        æ¨¡å‹
                    </label>
                    <input type="text" id="edit-default-model" readonly
                           style="width: 100%; padding: 12px; border-radius: 8px; 
                                  border: 1px solid var(--input-border); 
                                  background: var(--input-bg); color: var(--text-color-primary);
                                  cursor: pointer; box-sizing: border-box;"
                           value="${preset.defaultModel || ''}"
                           placeholder="ç‚¹å‡»é€‰æ‹©æ¨¡å‹"
                           onclick="openModelSelectorForEdit()">
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeEditPresetModal()"
                            style="padding: 10px 20px; border-radius: 8px; 
                                   background: var(--input-bg); color: var(--text-color-primary);
                                   border: 1px solid var(--input-border); cursor: pointer;">
                        å–æ¶ˆ
                    </button>
                    <button onclick="savePresetEdit('${presetId}')"
                            style="padding: 10px 20px; border-radius: 8px; 
                                   background: var(--accent-color); color: white;
                                   border: none; cursor: pointer;">
                        ä¿å­˜
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(editModal);
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        editModal.addEventListener('click', function(e) {
            if (e.target === editModal) {
                closeEditPresetModal();
            }
        });
    }
}

function savePresetEdit(presetId) {
    const isNewPreset = presetId.toString().startsWith('new_');
    let preset;
    
    if (isNewPreset) {
        // æ–°å»ºé¢„è®¾
        preset = {
            id: Date.now(),
            name: '',
            apiUrl: '',
            apiKey: '',
            defaultModel: ''
        };
        APP_DATA.presets.push(preset);
    } else {
        // ç¼–è¾‘ç°æœ‰é¢„è®¾
        preset = APP_DATA.presets.find(p => p.id == presetId);
    }
    
    if (!preset) return;
    
    const name = document.getElementById('edit-preset-name').value.trim();
    const apiUrl = document.getElementById('edit-api-url').value.trim();
    const apiKey = document.getElementById('edit-api-key').value.trim();
    const defaultModel = document.getElementById('edit-default-model').value.trim();
    
    if (!name) {
        alert('é¢„è®¾åç§°ä¸èƒ½ä¸ºç©º');
        return;
    }
    
    if (!apiUrl || !apiKey) {
        alert('API URL å’Œ API Key ä¸èƒ½ä¸ºç©º');
        return;
    }
    
    // æ›´æ–°é¢„è®¾ä¿¡æ¯
    preset.name = name;
    preset.apiUrl = apiUrl;
    preset.apiKey = apiKey;
    preset.defaultModel = defaultModel;
    
// ã€æ–°å¢ã€‘å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„é¢„è®¾ï¼Œæ›´æ–°ä½¿ç”¨æ—¶é—´
    if (APP_DATA.currentPresetId === preset.id) {
        preset.lastUsedTime = Date.now();
}
    // å¦‚æœæ˜¯æ–°å»ºçš„é¢„è®¾å¹¶ä¸”æ²¡æœ‰å½“å‰é¢„è®¾ï¼Œå°±è®¾ä¸ºå½“å‰
    if (isNewPreset && !APP_DATA.currentPresetId) {
        APP_DATA.currentPresetId = preset.id;
        document.getElementById('api-preset-display').value = preset.name;
        
        // åŒæ­¥åˆ°settings
        APP_DATA.settings.apiUrl = apiUrl;
        APP_DATA.settings.apiKey = apiKey;
        APP_DATA.settings.aiModel = defaultModel;
    }
    
    // ä¿å­˜æ•°æ®
    saveData();
    
    // ç§»é™¤ç¼–è¾‘å¼¹çª—
    const editModal = document.getElementById('edit-preset-modal');
    if (editModal) {
        editModal.style.opacity = '0';
        editModal.style.transition = 'opacity 0.3s ease';
        
        // ç­‰å¾…åŠ¨ç”»å®Œæˆ
        setTimeout(() => {
            if (editModal && editModal.parentNode) {
                editModal.remove();
            }
            
            // åˆ·æ–°é¢„è®¾åˆ—è¡¨
            refreshPresetList();
            
            // æ˜¾ç¤ºAPIå¼¹çª—
            showModal('preset-modal');
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                alert(isNewPreset ? 'é¢„è®¾åˆ›å»ºæˆåŠŸï¼' : 'é¢„è®¾å·²æ›´æ–°');
            }, 100);
            
        }, 300);
    } else {
        refreshPresetList();
        showModal('preset-modal');
        alert(isNewPreset ? 'é¢„è®¾åˆ›å»ºæˆåŠŸï¼' : 'é¢„è®¾å·²æ›´æ–°');
    }
}


function deletePreset(presetId) {
    const preset = APP_DATA.presets.find(p => p.id == presetId);
    if (!preset) return;
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${preset.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
        return;
    }
    
    // å¦‚æœè¦åˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„é¢„è®¾
    if (APP_DATA.currentPresetId === presetId) {
        // æ¸…é™¤å½“å‰é¢„è®¾
        APP_DATA.currentPresetId = null;
        
        // æ˜¾ç¤ºAPIè¾“å…¥å­—æ®µ
        document.getElementById('api-fields-container').style.display = 'block';
        document.getElementById('api-preset-display').value = 'æ–°å»ºé¢„è®¾';
        document.getElementById('save-preset-btn').style.display = 'block';
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('api-url').value = '';
        document.getElementById('api-key').value = '';
        document.getElementById('ai-model').value = '';
    }
    
    // ä»æ•°ç»„ä¸­åˆ é™¤
    APP_DATA.presets = APP_DATA.presets.filter(p => p.id !== presetId);
    
    // å¦‚æœåˆ é™¤åæ²¡æœ‰é¢„è®¾äº†ï¼Œç¡®ä¿é¢„è®¾æ•°ç»„å­˜åœ¨
    if (APP_DATA.presets.length === 0) {
        APP_DATA.presets = [];
    }
    
    // ä¿å­˜æ•°æ®
    saveData();
    
    // åˆ·æ–°é¢„è®¾åˆ—è¡¨
    refreshPresetList();
    
    alert('é¢„è®¾å·²åˆ é™¤');
}

async function openModelSelectorForEdit() {
    // è·å–å½“å‰ç¼–è¾‘å¼¹çª—ä¸­çš„APIä¿¡æ¯
    const apiUrl = document.getElementById('edit-api-url').value.trim();
    const apiKey = document.getElementById('edit-api-key').value.trim();
    
    if (!apiUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™API URLå’ŒAPI Key');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½å¼¹çª—
    const loadingModal = document.createElement('div');
    loadingModal.id = 'loading-edit-model-modal';
    loadingModal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
    `;
    
    loadingModal.innerHTML = `
        <div style="background: var(--bg-color-secondary); padding: 30px; border-radius: 16px; 
                    min-width: 200px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
            </div>
            <div>æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</div>
        </div>
    `;
    
    document.body.appendChild(loadingModal);
    
    try {
        // è·å–æ¨¡å‹åˆ—è¡¨
        const models = await fetchModelList(apiUrl, apiKey);
        
        // ç§»é™¤åŠ è½½å¼¹çª—
        loadingModal.remove();
        
        if (models.length === 0) {
            alert('æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°');
            return;
        }
        
        // æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å¼¹çª—
        showModelListForEdit(models);
    } catch (error) {
        // ç§»é™¤åŠ è½½å¼¹çª—
        loadingModal.remove();
        
        console.error('è·å–æ¨¡å‹å¤±è´¥:', error);
        
        let errorMsg = 'è·å–æ¨¡å‹å¤±è´¥: ' + error.message;
        if (error.message.includes('æ— æ³•æ‰¾åˆ°å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹')) {
            errorMsg = 'æ— æ³•è‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨ã€‚\n\nè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–æ£€æŸ¥ï¼š\n1. API URLæ˜¯å¦æ­£ç¡®\n2. API Keyæ˜¯å¦æœ‰æƒé™\n3. è¯¥APIæ˜¯å¦æ”¯æŒæ¨¡å‹åˆ—è¡¨æŸ¥è¯¢';
        }
        
        alert(errorMsg);
    }
}



function showModelListForEdit(models, presetId) {
    const modal = document.createElement('div');
    modal.id = 'model-list-edit-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
    <div style="background: var(--bg-color-secondary); border-radius: 16px; 
                width: 100%; max-width: 320px; max-height: 70vh;
                display: flex; flex-direction: column;">
        <div style="padding: 20px; border-bottom: 1px solid var(--input-border);">
            <h4 style="margin: 0; color: var(--text-color-primary);">é€‰æ‹©æ¨¡å‹ (${models.length}ä¸ª)</h4>
        </div>
        
        <div style="padding: 15px; flex: 1; overflow-y: auto;">
            <input type="text" id="model-search-edit-input" 
                   placeholder="æœç´¢æ¨¡å‹..." 
                   style="width: 90%; padding: 10px 15px; margin: 0 auto 15px auto;
                          border-radius: 10px; border: 1px solid var(--input-border); 
                          background: var(--input-bg); color: var(--text-color-primary);
                          display: block;">
            
            <div id="model-items-edit-container">
                <!-- æ¨¡å‹åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    `;
    
    document.body.appendChild(modal);
    
    // å¡«å……æ¨¡å‹åˆ—è¡¨
    renderModelsForEdit(models, presetId);
    
    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('model-search-edit-input');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredModels = models.filter(model => {
            const modelId = (model.id || model).toLowerCase();
            return modelId.includes(searchTerm);
        });
        renderModelsForEdit(filteredModels, presetId);
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    
}

function renderModelsForEdit(models, presetId) {
    const container = document.getElementById('model-items-edit-container');
    container.innerHTML = '';
    
    if (models.length === 0) {
        container.innerHTML = `
            <div style="padding: 30px; text-align: center; color: var(--text-color-secondary);">
                æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹
            </div>
        `;
        return;
    }
    
    models.forEach((model) => {
        const modelId = model.id || model;
        const displayName = modelId.split('/').pop();
        
        const item = document.createElement('div');
        item.style.cssText = `
            padding: 12px 15px; margin: 0 10px 8px 10px; border-radius: 10px;
            border: 1px solid var(--input-border); cursor: pointer;
            background: var(--input-bg); transition: all 0.2s;
            width: calc(100% - 20px);
            box-sizing: border-box;
            overflow: hidden;
            word-break: break-word;
        `;
        
        item.innerHTML = `
            <div style="font-weight: bold; color: var(--text-color-primary);">
                ${displayName}
            </div>
            <div style="font-size: 12px; color: var(--text-color-secondary); margin-top: 4px;">
                ${modelId}
            </div>
        `;
        
        item.onclick = function() {
            // æ›´æ–°ç¼–è¾‘å¼¹çª—ä¸­çš„æ¨¡å‹è¾“å…¥æ¡†
            document.getElementById('edit-default-model').value = modelId;
            // å…³é—­æ¨¡å‹é€‰æ‹©å¼¹çª—
            document.getElementById('model-list-edit-modal').remove();
        };
        
        container.appendChild(item);
    });
}

// æµ‹è¯•å…¬ç›Šç«™APIçš„è¾…åŠ©å‡½æ•°
function testPublicAPI(apiUrl, apiKey, modelName) {
    console.log("æµ‹è¯•å…¬ç›Šç«™API:", { apiUrl, apiKey, modelName });
    
    // åˆ›å»ºä¸€ä¸ªæµ‹è¯•å¼¹çª—
    const testModal = document.createElement('div');
    testModal.id = 'test-api-modal';
    testModal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
    `;
    
    testModal.innerHTML = `
        <div style="background: var(--bg-color-secondary); border-radius: 16px; padding: 24px; 
                    width: 90%; max-width: 400px;">
            <h4 style="margin-top: 0; margin-bottom: 20px; color: var(--text-color-primary);">
                æµ‹è¯•APIè¿æ¥
            </h4>
            
            <div id="test-status" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <i class="fa-solid fa-spinner fa-spin" style="margin-right: 10px;"></i>
                    <span>æ­£åœ¨æµ‹è¯•è¿æ¥...</span>
                </div>
                <div id="test-details" style="font-size: 13px; color: var(--text-color-secondary);">
                    
                </div>
            </div>
            
            <div style="text-align: center;">
                <button onclick="document.getElementById('test-api-modal').remove()" 
                        style="padding: 10px 20px; border-radius: 8px;
                               background: var(--accent-color); color: white;
                               border: none; cursor: pointer;">
                    å…³é—­
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(testModal);
    
    // æ‰§è¡Œæµ‹è¯•
    setTimeout(async () => {
        const statusEl = document.getElementById('test-status');
        const detailsEl = document.getElementById('test-details');
        
        try {
            // æµ‹è¯•1ï¼šè·å–æ¨¡å‹åˆ—è¡¨
            detailsEl.innerHTML = '1. æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...';
            const models = await fetchModelList(apiUrl, apiKey);
            
            detailsEl.innerHTML += `<br>âœ“ æˆåŠŸè·å–åˆ° ${models.length} ä¸ªæ¨¡å‹`;
            
            // æµ‹è¯•2ï¼šå‘é€æµ‹è¯•è¯·æ±‚
            detailsEl.innerHTML += '<br>2. æ­£åœ¨å‘é€æµ‹è¯•æ¶ˆæ¯...';
            
            const testResponse = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: modelName || models[0]?.id,
                    messages: [{ role: 'user', content: 'Hello' }],
                    max_tokens: 10
                })
            });
            
            if (testResponse.ok) {
                const data = await testResponse.json();
                detailsEl.innerHTML += '<br>âœ“ APIå“åº”æ­£å¸¸';
                
                statusEl.innerHTML = `
                    <div style="color: #07C160;">
                        <i class="fa-solid fa-check-circle" style="margin-right: 10px;"></i>
                        <span>APIè¿æ¥æµ‹è¯•æˆåŠŸï¼</span>
                    </div>
                `;
            } else {
                detailsEl.innerHTML += `<br>âœ— APIå“åº”é”™è¯¯: ${testResponse.status}`;
                statusEl.innerHTML = `
                    <div style="color: #C26D5E;">
                        <i class="fa-solid fa-times-circle" style="margin-right: 10px;"></i>
                        <span>APIå“åº”é”™è¯¯</span>
                    </div>
                `;
            }
            
        } catch (error) {
            detailsEl.innerHTML += `<br>âœ— æµ‹è¯•å¤±è´¥: ${error.message}`;
            statusEl.innerHTML = `
                <div style="color: #C26D5E;">
                    <i class="fa-solid fa-times-circle" style="margin-right: 10px;"></i>
                    <span>APIè¿æ¥å¤±è´¥</span>
                </div>
            `;
        }
    }, 100);
}

function closeEditPresetModal() {
    const editModal = document.getElementById('edit-preset-modal');
    
    if (editModal) {
        // æ·¡å‡ºæ•ˆæœ
        editModal.style.opacity = '0';
        editModal.style.transition = 'opacity 0.3s ease';
        
        // ç­‰å¾…åŠ¨ç”»å®Œæˆåç§»é™¤
        setTimeout(() => {
            if (editModal && editModal.parentNode) {
                editModal.remove();
            }
            
            // æ˜¾ç¤ºAPIå¼¹çª—
            showModal('preset-modal');
        }, 300);
    } else {
        showModal('preset-modal');
    }
}

// å¼ºåˆ¶å…³é—­æ‰€æœ‰å¼¹çª—
function forceCloseAllModals() {
    // å…³é—­æ‰€æœ‰.overlayå¼¹çª—
    document.querySelectorAll('.overlay').forEach(modal => {
        modal.style.display = 'none';
        modal.classList.remove('active');
    });
    
    // å…³é—­åŠ¨æ€åˆ›å»ºçš„å¼¹çª—
    const dynamicModals = [
        'edit-preset-modal',
        'model-list-modal', 
        'model-list-edit-modal',
        'loading-model-modal',
        'loading-edit-model-modal'
    ];
    
    dynamicModals.forEach(id => {
        const modal = document.getElementById(id);
        if (modal) modal.remove();
    });
    
    // ç¡®ä¿é¢„è®¾å¼¹çª—æ˜¾ç¤ºæ­£å¸¸
    const presetModal = document.getElementById('preset-modal');
    if (presetModal) {
        presetModal.style.display = 'none';
        presetModal.classList.remove('active');
    }
    
    console.log('å·²å¼ºåˆ¶å…³é—­æ‰€æœ‰å¼¹çª—');
}

function selectPreset(presetId) {
    const apiFieldsContainer = document.getElementById('api-fields-container');
    const modelContainer = document.getElementById('current-preset-model-container');
    
    if (presetId === 'new') {
        // æ–°å»ºé¢„è®¾æ¨¡å¼
        document.getElementById('api-preset-display').value = 'æ–°å»ºé¢„è®¾';
        document.getElementById('api-url').value = '';
        document.getElementById('api-key').value = '';
        document.getElementById('ai-model').value = '';
        
        // ã€æ–°å¢ã€‘éšè—å½“å‰é¢„è®¾æ¨¡å‹é€‰æ‹©æ¡†
        if (modelContainer) {
            modelContainer.style.display = 'none';
        }
        
        // æ˜¾ç¤ºAPIè¾“å…¥å­—æ®µï¼ˆæ–°å»ºé¢„è®¾æ¨¡å¼ï¼‰
        if (apiFieldsContainer) {
            apiFieldsContainer.style.display = 'block';
        }
        
        document.getElementById('save-preset-btn').style.display = 'block';
        APP_DATA.currentPresetId = null;
    } else {
        // åŠ è½½ç°æœ‰é¢„è®¾
        loadPreset(presetId);
    }
}

// æ‰“å¼€å½“å‰é¢„è®¾çš„æ¨¡å‹é€‰æ‹©å™¨
async function openCurrentPresetModelSelector() {
    if (!APP_DATA.currentPresetId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢„è®¾');
        return;
    }
    
    const preset = APP_DATA.presets.find(p => p.id == APP_DATA.currentPresetId);
    if (!preset) {
        alert('é¢„è®¾ä¸å­˜åœ¨');
        return;
    }
    
    const apiUrl = preset.apiUrl || '';
    const apiKey = preset.apiKey || '';
    
    if (!apiUrl || !apiKey) {
        alert('è¯·å…ˆåœ¨ç¼–è¾‘é¢„è®¾ä¸­å¡«å†™API URLå’ŒAPI Key');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½å¼¹çª—
    const loadingModal = document.createElement('div');
    loadingModal.id = 'loading-current-model-modal';
    loadingModal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
    `;
    
    loadingModal.innerHTML = `
        <div style="background: var(--bg-color-secondary); padding: 30px; border-radius: 16px; 
                    min-width: 200px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
            </div>
            <div>æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</div>
        </div>
    `;
    
    document.body.appendChild(loadingModal);
    
    try {
        // è·å–æ¨¡å‹åˆ—è¡¨
        const models = await fetchModelList(apiUrl, apiKey);
        
        // ç§»é™¤åŠ è½½å¼¹çª—
        loadingModal.remove();
        
        if (models.length === 0) {
            alert('æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°');
            return;
        }
        
        // æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å¼¹çª—
        showCurrentPresetModelList(models);
        
    } catch (error) {
        // ç§»é™¤åŠ è½½å¼¹çª—
        loadingModal.remove();
        
        console.error('è·å–æ¨¡å‹å¤±è´¥:', error);
        
        let errorMsg = 'è·å–æ¨¡å‹å¤±è´¥: ' + error.message;
        if (error.message.includes('æ— æ³•æ‰¾åˆ°å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹')) {
            errorMsg = 'æ— æ³•è‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨ã€‚\n\nè¯·å…ˆåœ¨ç¼–è¾‘é¢„è®¾ä¸­æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°';
        }
        
        alert(errorMsg);
    }
}

// æ˜¾ç¤ºå½“å‰é¢„è®¾çš„æ¨¡å‹åˆ—è¡¨
function showCurrentPresetModelList(models) {
    const modal = document.createElement('div');
    modal.id = 'current-model-list-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
    <div style="background: var(--bg-color-secondary); border-radius: 16px; 
                width: 100%; max-width: 400px; max-height: 70vh;
                display: flex; flex-direction: column;">
        <div style="padding: 20px; border-bottom: 1px solid var(--input-border);">
            <h4 style="margin: 0; color: var(--text-color-primary);">é€‰æ‹©æ¨¡å‹ (${models.length}ä¸ª)</h4>
        </div>
        
        <div style="padding: 15px; flex: 1; overflow-y: auto;">
            <input type="text" id="current-model-search-input" 
                   placeholder="æœç´¢æ¨¡å‹..." 
                   style="width: 90%; padding: 10px 15px; margin: 0 auto 15px auto;
                          border-radius: 10px; border: 1px solid var(--input-border); 
                          background: var(--input-bg); color: var(--text-color-primary);
                          display: block;">
            
            <div id="current-model-items-container" style="max-height: 50vh; overflow-y: auto;">
                <!-- æ¨¡å‹åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div style="padding: 15px; border-top: 1px solid var(--input-border); text-align: center;">
            <button onclick="document.getElementById('current-model-list-modal').remove()" 
                    style="padding: 10px 20px; border-radius: 8px;
                           background: var(--input-bg); color: var(--text-color-primary);
                           border: 1px solid var(--input-border); cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>
    `;
    
    document.body.appendChild(modal);
    
    // å¡«å……æ¨¡å‹åˆ—è¡¨
    renderCurrentPresetModels(models);
    
    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('current-model-search-input');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredModels = models.filter(model => {
            const modelId = (model.id || model).toLowerCase();
            return modelId.includes(searchTerm);
        });
        renderCurrentPresetModels(filteredModels);
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// æ¸²æŸ“å½“å‰é¢„è®¾çš„æ¨¡å‹åˆ—è¡¨
function renderCurrentPresetModels(models) {
    const container = document.getElementById('current-model-items-container');
    container.innerHTML = '';
    
    if (models.length === 0) {
        container.innerHTML = `
            <div style="padding: 30px; text-align: center; color: var(--text-color-secondary);">
                æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹
            </div>
        `;
        return;
    }
    
    models.forEach((model) => {
        const modelId = model.id || model;
        const displayName = modelId.split('/').pop();
        
        const item = document.createElement('div');
        item.style.cssText = `
            padding: 12px 15px; margin: 0 10px 8px 10px; border-radius: 10px;
            border: 1px solid var(--input-border); cursor: pointer;
            background: var(--input-bg); transition: all 0.2s;
            width: calc(100% - 20px);
            box-sizing: border-box;
            overflow: hidden;
            word-break: break-word;
        `;
        
        item.innerHTML = `
            <div style="font-weight: bold; color: var(--text-color-primary);">
                ${displayName}
            </div>
            <div style="font-size: 12px; color: var(--text-color-secondary); margin-top: 4px;">
                ${modelId}
            </div>
        `;
        
        item.onclick = function() {
            // æ›´æ–°å½“å‰é¢„è®¾çš„æ¨¡å‹
            if (APP_DATA.currentPresetId) {
                const preset = APP_DATA.presets.find(p => p.id == APP_DATA.currentPresetId);
                if (preset) {
                    preset.defaultModel = modelId;
                    document.getElementById('current-preset-model').value = modelId;
                    APP_DATA.settings.aiModel = modelId;
                    saveData();
                }
            }
            
            // å…³é—­æ¨¡å‹é€‰æ‹©å¼¹çª—
            document.getElementById('current-model-list-modal').remove();
        };
        
        container.appendChild(item);
    });
}
// ==================== æ·±é¢„è®¾å’Œæ­£åˆ™åŠŸèƒ½ ====================

// åŠ è½½æ·±é¢„è®¾å’Œæ­£åˆ™è®¾ç½®
function loadDeepPresetAndRegexSettings() {
    // æ›´æ–°å¼€å…³çŠ¶æ€
    updateSwitchState('deep-preset-switch', APP_DATA.deepPresetEnabled);
    updateSwitchState('regex-switch', APP_DATA.regexEnabled);
    
    // æ›´æ–°æ˜¾ç¤ºæ¡†å†…å®¹
    updateDeepPresetDisplay();
    updateRegexDisplay();
}

// æ›´æ–°å¼€å…³çŠ¶æ€
function updateSwitchState(switchId, enabled) {
    const switchElement = document.getElementById(switchId);
    if (!switchElement) return;
    
    const thumb = switchElement.querySelector('.theme-switch-thumb');
    if (!thumb) return;
    
    if (enabled) {
        thumb.style.left = 'calc(100% - 19px)'; // å³è¾¹
        switchElement.style.background = 'var(--accent-color)';
    } else {
        thumb.style.left = '1px'; // å·¦è¾¹
        switchElement.style.background = 'var(--input-border)';
    }
}

// æ›´æ–°æ·±é¢„è®¾æ˜¾ç¤º
function updateDeepPresetDisplay() {
    const display = document.getElementById('deep-preset-display');
    if (!display) return;
    
    if (APP_DATA.currentDeepPresetId) {
        const preset = APP_DATA.deepPresets.find(p => p.id == APP_DATA.currentDeepPresetId);
        if (preset) {
            display.value = preset.name;
            return;
        }
    }
    display.value = 'æœªé€‰æ‹©é¢„è®¾';
}

// æ›´æ–°æ­£åˆ™æ˜¾ç¤º
function updateRegexDisplay() {
    const display = document.getElementById('regex-display');
    if (!display) return;
    
    if (APP_DATA.currentRegexId) {
        const regex = APP_DATA.regexPatterns.find(r => r.id == APP_DATA.currentRegexId);
        if (regex) {
            display.value = regex.name;
            return;
        }
    }
    display.value = 'æœªé€‰æ‹©æ­£åˆ™';
}

// åˆ‡æ¢æ·±é¢„è®¾å¼€å…³
function toggleDeepPreset() {
    APP_DATA.deepPresetEnabled = !APP_DATA.deepPresetEnabled;
    updateSwitchState('deep-preset-switch', APP_DATA.deepPresetEnabled);
    saveData();
}

// åˆ‡æ¢æ­£åˆ™å¼€å…³
function toggleRegex() {
    APP_DATA.regexEnabled = !APP_DATA.regexEnabled;
    updateSwitchState('regex-switch', APP_DATA.regexEnabled);
    saveData();
}

// æ‰“å¼€æ·±é¢„è®¾ç®¡ç†å¼¹çª—
function openDeepPresetManager() {
    refreshDeepPresetList();
    showModal('deep-preset-modal');
}

// æ‰“å¼€æ­£åˆ™ç®¡ç†å¼¹çª—
function openRegexManager() {
    refreshRegexList();
    showModal('regex-modal');
}

// åˆ·æ–°æ·±é¢„è®¾åˆ—è¡¨
function refreshDeepPresetList() {
    const list = document.getElementById('deep-preset-list');
    if (!list) return;
    
    if (!APP_DATA.deepPresets || APP_DATA.deepPresets.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 30px; color: var(--text-color-secondary);">
                <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“</div>
                <div>æ— é¢„è®¾</div>
            </div>
        `;
        return;
    }
    
    // æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åº
    const sortedPresets = [...APP_DATA.deepPresets].sort((a, b) => {
        const timeA = a.lastUsedTime || 0;
        const timeB = b.lastUsedTime || 0;
        return timeB - timeA;
    });
    
    list.innerHTML = '';
    sortedPresets.forEach(preset => {
        const div = document.createElement('div');
        div.style.cssText = `
            padding: 12px 15px; margin-bottom: 8px; border-radius: 10px;
            background: var(--input-bg); border: 1px solid var(--input-border);
            position: relative;
            min-height: 60px;
        `;
        
        // ä¸»å†…å®¹åŒºåŸŸï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰
        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = `
            cursor: pointer;
            margin-right: 40px; /* ç»™åˆ é™¤æŒ‰é’®ç•™ç©ºé—´ */
        `;
        
        contentDiv.innerHTML = `
            <div style="font-weight: bold; color: var(--text-color-primary); font-size: 17px;">
                ${preset.name}
            </div>
            <div style="font-size: 13px; color: var(--text-color-secondary); margin-top: 6px; line-height: 1.4;">
                ${preset.content.substring(0, 50)}${preset.content.length > 50 ? '...' : ''}
            </div>
        `;
        
        contentDiv.onclick = function() {
            selectDeepPreset(preset.id);
        };
        
        div.appendChild(contentDiv);
        
        // åˆ é™¤æŒ‰é’®
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.cssText = `
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: var(--danger-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        deleteBtn.title = 'åˆ é™¤é¢„è®¾';
        deleteBtn.onclick = function(e) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡
            deleteDeepPreset(preset.id);
        };
        
        div.appendChild(deleteBtn);
        list.appendChild(div);
    });
}

// åˆ·æ–°æ­£åˆ™åˆ—è¡¨
function refreshRegexList() {
    const list = document.getElementById('regex-list');
    if (!list) return;
    
    if (!APP_DATA.regexPatterns || APP_DATA.regexPatterns.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 30px; color: var(--text-color-secondary);">
                <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“„</div>
                <div>æ— æ­£åˆ™</div>
            </div>
        `;
        return;
    }
    
    // æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åº
    const sortedRegex = [...APP_DATA.regexPatterns].sort((a, b) => {
        const timeA = a.lastUsedTime || 0;
        const timeB = b.lastUsedTime || 0;
        return timeB - timeA;
    });
    
    list.innerHTML = '';
    sortedRegex.forEach(regex => {
        const div = document.createElement('div');
        div.style.cssText = `
            padding: 12px 15px; margin-bottom: 8px; border-radius: 10px;
            background: var(--input-bg); border: 1px solid var(--input-border);
            position: relative;
            min-height: 60px;
        `;
        
        // ä¸»å†…å®¹åŒºåŸŸï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰
        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = `
            cursor: pointer;
            margin-right: 40px; /* ç»™åˆ é™¤æŒ‰é’®ç•™ç©ºé—´ */
        `;
        
        contentDiv.innerHTML = `
            <div style="font-weight: bold; color: var(--text-color-primary); font-size: 17px;">
                ${regex.name}
            </div>
            <div style="font-size: 12px; color: var(--text-color-secondary); margin-top: 4px; line-height: 1.3;">
                <div style="margin-bottom: 2px;">æ¨¡å¼: ${regex.pattern.substring(0, 40)}${regex.pattern.length > 40 ? '...' : ''}</div>
                <div>æ›¿æ¢: ${regex.replacement.substring(0, 40)}${regex.replacement.length > 40 ? '...' : ''}</div>
            </div>
        `;
        
        contentDiv.onclick = function() {
            selectRegex(regex.id);
        };
        
        div.appendChild(contentDiv);
        
        // åˆ é™¤æŒ‰é’®
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.cssText = `
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: var(--danger-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        deleteBtn.title = 'åˆ é™¤æ­£åˆ™';
        deleteBtn.onclick = function(e) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡
            deleteRegex(regex.id);
        };
        
        div.appendChild(deleteBtn);
        list.appendChild(div);
    });
}

// é€‰æ‹©æ·±é¢„è®¾
function selectDeepPreset(presetId) {
    const preset = APP_DATA.deepPresets.find(p => p.id == presetId);
    if (!preset) return;
    
    APP_DATA.currentDeepPresetId = presetId;
    preset.lastUsedTime = Date.now();
    updateDeepPresetDisplay();
    saveData();
    hideModal('deep-preset-modal');
}

// é€‰æ‹©æ­£åˆ™
function selectRegex(regexId) {
    const regex = APP_DATA.regexPatterns.find(r => r.id == regexId);
    if (!regex) return;
    
    APP_DATA.currentRegexId = regexId;
    regex.lastUsedTime = Date.now();
    updateRegexDisplay();
    saveData();
    hideModal('regex-modal');
}

// åˆ é™¤æ·±é¢„è®¾
function deleteDeepPreset(presetId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }
    
    // å¦‚æœè¦åˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„é¢„è®¾
    if (APP_DATA.currentDeepPresetId === presetId) {
        APP_DATA.currentDeepPresetId = null;
        updateDeepPresetDisplay();
    }
    
    // ä»æ•°ç»„ä¸­åˆ é™¤
    APP_DATA.deepPresets = APP_DATA.deepPresets.filter(p => p.id !== presetId);
    saveData();
    refreshDeepPresetList();
}

// åˆ é™¤æ­£åˆ™
function deleteRegex(regexId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ­£åˆ™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }
    
    // å¦‚æœè¦åˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„æ­£åˆ™
    if (APP_DATA.currentRegexId === regexId) {
        APP_DATA.currentRegexId = null;
        updateRegexDisplay();
    }
    
    // ä»æ•°ç»„ä¸­åˆ é™¤
    APP_DATA.regexPatterns = APP_DATA.regexPatterns.filter(r => r.id !== regexId);
    saveData();
    refreshRegexList();
}

// å¯¼å…¥æ·±é¢„è®¾æ–‡ä»¶
function importDeepPresetFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.txt';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const fileContent = e.target.result;
                let presetName = file.name.replace(/\.[^/.]+$/, "");
                let presetContent = "";

                try {
                    // å°è¯•è§£æä¸º JSON
                    const presetData = JSON.parse(fileContent);
                    
                    // è‡ªåŠ¨å¯»æ‰¾å¯èƒ½çš„å­—æ®µå
                    presetContent = presetData.content || presetData.text || presetData.value || 
                                    (typeof presetData === 'string' ? presetData : JSON.stringify(presetData));
                    
                    if (presetData.name) {
                        presetName = presetData.name;
                    }
                } catch (jsonError) {
                    // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥ä½œä¸ºçº¯æ–‡æœ¬
                    presetContent = fileContent;
                }
                
                if (!presetContent || presetContent.trim() === "") {
                    alert("æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¯¼å…¥");
                    return;
                }

                // åˆ›å»ºé¢„è®¾å¯¹è±¡å¹¶ä¿å­˜
                const newPreset = {
                    id: Date.now(),
                    name: presetName,
                    content: presetContent,
                    lastUsedTime: Date.now()
                };

                if (!APP_DATA.deepPresets) APP_DATA.deepPresets = [];
                APP_DATA.deepPresets.push(newPreset);
                saveData();
                
                refreshDeepPresetList();
                selectDeepPreset(newPreset.id);
                
                alert('é¢„è®¾å¯¼å…¥æˆåŠŸï¼');
            } catch (error) {
                alert('å¯¼å…¥è¿‡ç¨‹ä¸­å‡ºé”™ï¼š' + error.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// å¯¼å…¥æ­£åˆ™æ–‡ä»¶
function importRegexFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.txt';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const fileContent = e.target.result;
                let regexData;
                
                try {
                    regexData = JSON.parse(fileContent);
                } catch (jsonError) {
                    alert('è¯·æä¾›æœ‰æ•ˆçš„ JSON æ ¼å¼æ–‡ä»¶ã€‚');
                    return;
                }

                // --- æ™ºèƒ½è¯†åˆ«é€»è¾‘ ---
                // 1. æ‰¾åç§°
                let name = regexData.name || regexData.title || file.name.replace(/\.[^/.]+$/, "");
                
                // 2. æ‰¾åŒ¹é…æ¨¡å¼ (Pattern)
                let pattern = regexData.pattern || regexData.regex || regexData.match;
                
                // 3. æ‰¾æ›¿æ¢å†…å®¹ (Replacement)
                let replacement = regexData.replacement || regexData.replace || regexData.result || "";

                if (!pattern) {
                    alert('å¯¼å…¥å¤±è´¥ï¼šæœªåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°â€œpatternâ€æˆ–â€œregexâ€åŒ¹é…è§„åˆ™ã€‚');
                    return;
                }

                const newRegex = {
                    id: Date.now(),
                    name: name,
                    pattern: pattern,
                    replacement: String(replacement), // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                    lastUsedTime: Date.now()
                };

                if (!APP_DATA.regexPatterns) APP_DATA.regexPatterns = [];
                APP_DATA.regexPatterns.push(newRegex);
                saveData();
                
                refreshRegexList();
                selectRegex(newRegex.id);
                
                alert('æ­£åˆ™è§„åˆ™å¯¼å…¥æˆåŠŸï¼');
            } catch (error) {
                alert('å¯¼å…¥å‡ºé”™ï¼š' + error.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// åˆ›å»ºæ–°çš„æ·±é¢„è®¾ï¼ˆç©ºé¢„è®¾ï¼Œç”¨äºæ‰‹åŠ¨åˆ›å»ºï¼‰
function createNewDeepPreset() {
    const presetName = prompt('è¯·è¾“å…¥é¢„è®¾åç§°ï¼š', 'æ–°é¢„è®¾');
    if (!presetName || !presetName.trim()) return;
    
    const presetContent = prompt('è¯·è¾“å…¥é¢„è®¾å†…å®¹ï¼š', '');
    if (presetContent === null) return; // ç”¨æˆ·å–æ¶ˆ
    
    const newPreset = {
        id: Date.now(),
        name: presetName.trim(),
        content: presetContent || '',
        lastUsedTime: Date.now()
    };
    
    APP_DATA.deepPresets.push(newPreset);
    saveData();
    refreshDeepPresetList();
    selectDeepPreset(newPreset.id);
}

// åˆ›å»ºæ–°çš„æ­£åˆ™ï¼ˆç©ºæ­£åˆ™ï¼Œç”¨äºæ‰‹åŠ¨åˆ›å»ºï¼‰
function createNewRegex() {
    const regexName = prompt('è¯·è¾“å…¥æ­£åˆ™åç§°ï¼š', 'æ–°æ­£åˆ™');
    if (!regexName || !regexName.trim()) return;
    
    const regexPattern = prompt('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼š', '');
    if (regexPattern === null) return;
    
    const regexReplacement = prompt('è¯·è¾“å…¥æ›¿æ¢å†…å®¹ï¼ˆå¯ä¸ºç©ºï¼‰ï¼š', '');
    
    const newRegex = {
        id: Date.now(),
        name: regexName.trim(),
        pattern: regexPattern,
        replacement: regexReplacement || '',
        lastUsedTime: Date.now()
    };
    
    APP_DATA.regexPatterns.push(newRegex);
    saveData();
    refreshRegexList();
    selectRegex(newRegex.id);
}

// åœ¨AIå¯¹è¯ä¸­åº”ç”¨æ·±é¢„è®¾
function applyDeepPresetToPrompt() {
    if (!APP_DATA.deepPresetEnabled || !APP_DATA.currentDeepPresetId) {
        return '';
    }
    
    const preset = APP_DATA.deepPresets.find(p => p.id == APP_DATA.currentDeepPresetId);
    if (!preset) return '';
    
    return `\nã€æ·±é¢„è®¾ã€‘\n${preset.content}\n`;
}

// åœ¨AIå›å¤ååº”ç”¨æ­£åˆ™å¤„ç†
function applyRegexToText(text) {
    if (!APP_DATA.regexEnabled || !APP_DATA.currentRegexId) {
        return text;
    }
    
    const regex = APP_DATA.regexPatterns.find(r => r.id == APP_DATA.currentRegexId);
    if (!regex) return text;
    
    try {
        const pattern = new RegExp(regex.pattern, 'g');
        return text.replace(pattern, regex.replacement);
    } catch (error) {
        console.error('æ­£åˆ™å¤„ç†é”™è¯¯:', error);
        return text;
    }
}
 async function sendPushNotification(messageText) {
    const appId = "377df80f-5fd9-4c68-8b0d-9fae568761b8";
    const apiKey = APP_DATA.settings.oneSignalKey;

    console.log("ã€æ¨é€è°ƒè¯•ã€‘å‡†å¤‡å‘é€é€šçŸ¥...");
    console.log("ã€æ¨é€è°ƒè¯•ã€‘ä½¿ç”¨çš„ Key (å‰5ä½):", apiKey ? apiKey.substring(0, 5) : "æ— Key");

    if (!apiKey) {
        console.error("ã€æ¨é€ä¸­æ­¢ã€‘APP_DATA ä¸­æ²¡æœ‰æ‰¾åˆ° oneSignalKeyï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®ã€‚");
        return;
    }

    // è°ƒè¯•æ—¥å¿—ï¼šæ£€æŸ¥ Key æ˜¯å¦è¯»å–æˆåŠŸ
    console.log("ã€æ¨é€æ£€æŸ¥ã€‘Keyæ˜¯å¦å­˜åœ¨:", !!apiKey);
    console.log("ã€æ¨é€æ£€æŸ¥ã€‘å‘é€å†…å®¹:", messageText);

    if (!apiKey || !messageText) {
        console.error("ã€æ¨é€å¤±è´¥ã€‘ç¼ºå°‘ API Key æˆ–æ¶ˆæ¯å†…å®¹");
        return;
    }

    try {
        const response = await fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "Authorization": "Basic " + apiKey.trim()
            },
            body: JSON.stringify({
                app_id: appId,
                contents: { "en": messageText },
                headings: { "en": "Linkgo â­" },
                // å°è¯•æ·»åŠ è¿™ä¸ªï¼šå¼ºåˆ¶æ¨é€åˆ°æ‰€æœ‰å·²è®¢é˜…è®¾å¤‡
                included_segments: ["All"] 
            })
        });
        
        const result = await response.json();
        console.log("ã€OneSignal å“åº”ã€‘", result);
    } catch (e) {
        console.error("ã€ç½‘ç»œå¼‚å¸¸ã€‘", e);
    }
}

	// æ§åˆ¶é™éŸ³éŸ³é¢‘æ’­æ”¾çš„å‡½æ•°
function toggleSilentAudio(shouldPlay) {
    const audio = document.getElementById('silent-audio');
    if (!audio) return;
    
    if (shouldPlay) {
        audio.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«æ‹¦æˆª:", e));
    } else {
        audio.pause();
    }
}

// ç¡®ä¿å˜é‡åœ¨å…¨å±€èŒƒå›´å†…
let isKeepAliveEnabled = false;

async function toggleKeepAlive() {
    const track = document.getElementById('keep-alive-switch');
    const thumb = track.querySelector('.theme-switch-thumb');
    const audio = document.getElementById('silent-audio');
    
    if (!audio) return;

    isKeepAliveEnabled = !isKeepAliveEnabled;
    
    if (isKeepAliveEnabled) {
        // UI è¡¨ç°
        thumb.style.left = 'calc(100% - 28px)'; 
        track.style.background = 'var(--accent-color)';
        
        // å¼ºåˆ¶å¼€å¯å¾ªç¯æ¨¡å¼
        audio.loop = true;
        audio.volume = 0.5; 
        
        try {
            await audio.play();
            console.log("âœ… åå°ä¿æ´»å·²å¯åŠ¨å¹¶è®¾ç½®ä¸ºå¾ªç¯æ¨¡å¼");
        } catch (e) {
            console.warn("âŒ æ’­æ”¾å¤±è´¥:", e);
            isKeepAliveEnabled = false;
            thumb.style.left = '2px';
            track.style.background = 'var(--input-border)';
        }
    } else {
        // å…³é—­
        thumb.style.left = '2px';
        track.style.background = 'var(--input-border)';
        audio.pause();
    }
}

// --- æ–°å¢ï¼šåŒé‡ä¿é™©ï¼Œç¡®ä¿éŸ³é¢‘ç»“æŸæ—¶è‡ªåŠ¨é‡æ–°æ’­æ”¾ ---
document.getElementById('silent-audio').addEventListener('ended', function() {
    if (isKeepAliveEnabled) {
        this.play();
    }
}, false);

// è‡ªåŠ¨æ£€æµ‹å¹¶æ¿€æ´» OneSignal è®¢é˜…
async function checkAndReactivateSubscription() {
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
        console.log("ã€OneSignalã€‘æ­£åœ¨æ£€æŸ¥è®¢é˜…çŠ¶æ€...");

        // 1. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒé€šçŸ¥
        if (!OneSignal.Notifications.canRequest()) {
            console.warn("ã€OneSignalã€‘å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæˆ–å·²ç¦ç”¨é€šçŸ¥ã€‚");
            return;
        }

        // 2. æ£€æŸ¥å½“å‰æ˜¯å¦å·²è®¢é˜…
        const isSubscribed = OneSignal.User.PushSubscription.optedIn;
        const pushToken = OneSignal.User.PushSubscription.id;

        if (isSubscribed && pushToken) {
            console.log("âœ… ã€OneSignalã€‘è®¢é˜…å¤„äºæ´»è·ƒçŠ¶æ€ã€‚ID:", pushToken);
        } else {
            console.warn("âŒ ã€OneSignalã€‘æœªè®¢é˜…æˆ–è®¢é˜…å·²å¤±æ•ˆï¼Œå°è¯•é‡æ–°æ¿€æ´»...");
            try {
                // å¼ºåˆ¶å¼¹å‡ºè®¢é˜…æç¤ºæˆ–é™é»˜æ¿€æ´»
                await OneSignal.Notifications.request();
                console.log("ğŸš€ ã€OneSignalã€‘å·²è§¦å‘é‡æ–°è®¢é˜…è¯·æ±‚ã€‚");
            } catch (err) {
                console.error("ã€OneSignalã€‘é‡æ–°æ¿€æ´»å¤±è´¥:", err);
            }
        }
    });
}

// é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œ
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkAndReactivateSubscription, 2000); // å»¶è¿Ÿ2ç§’ç¡®ä¿SDKåŠ è½½å®Œæˆ
});

</script>

<!-- é¢„è®¾ç®¡ç†å¼¹çª— -->
<div id="preset-modal" class="overlay">
    <div class="modal-content" style="width: 90%; max-width: 320px; max-height: 70vh;">
  
  <h4 style="margin-top: 0; margin-bottom: 20px; color: var(--text-color-primary);">APIé¢„è®¾ç®¡ç†</h4>
        
        <!-- é¢„è®¾åˆ—è¡¨ -->
        <div id="preset-list" style="max-height: 50vh; overflow-y: auto; margin-bottom: 10px; padding-right: 5px;">
            <!-- åŠ¨æ€ç”Ÿæˆé¢„è®¾åˆ—è¡¨ -->
        </div>
        
        <!-- æ–°å»ºé¢„è®¾æŒ‰é’® -->
        <div style="text-align: center; padding-top: 15px; border-top: 1px solid var(--input-border);">
            <button onclick="doCreateNewPreset()" 
                    style="width: 100%; padding: 14px; border-radius: var(--radius-default); 
                           background: var(--accent-color); color: white; border: none; 
                           cursor: pointer; font-size: 16px; margin-bottom: 10px;">
                <i class="fas fa-plus-circle"></i> æ–°å»ºé¢„è®¾
            </button>
          
        </div>
    </div>
</div>
<div id="push-key-modal" class="overlay">
    <div class="modal-content" style="width: 85%; max-width: 300px;">
        <h4>é€šçŸ¥ API è®¾ç½®</h4>
        <label style="font-size: 14px;">OneSignal REST API Key:</label>
        <input type="password" id="onesignal-key-input" placeholder="os_v2_app_..." 
               style="width: 100%; padding: 12px; margin: 15px 0; border: 1px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-color-primary);">
        <div class="modal-footer">
            <button class="save-btn" onclick="savePushKey()">ä¿å­˜</button>
            <button class="cancel-btn" onclick="hideModal('push-key-modal')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

</body>
